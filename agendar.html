<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Meta Tags Essenciais -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <!-- SEO -->
  <meta name="description" content="Agende seu servi√ßo de forma r√°pida e f√°cil">
  <meta name="robots" content="noindex, nofollow">
  
  <!-- T√≠tulo -->
  <title>Agendar Servi√ßo - Sistema de Agendamentos</title>
  
  <!-- Estilos -->
  <link rel="stylesheet" href="assets/style.css">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìÜ</text></svg>">
</head>

<body>
  <!-- Container Principal -->
  <main class="container" role="main">
    <!-- Cabe√ßalho -->
    <header>
      <h2>üìÜ Agendar Servi√ßo</h2>
      <p>Preencha os dados abaixo para agendar seu servi√ßo</p>
      <div id="userInfo" style="text-align: center; margin-bottom: 16px; font-size: 14px; color: #6c757d;"></div>
    </header>

    <!-- Formul√°rio de Agendamento -->
    <form id="agendamentoForm" aria-label="Formul√°rio de agendamento" onsubmit="return false;">
      
      <!-- Campo Nome -->
      <div class="form-group">
        <label for="nome">
          Nome Completo <span style="color: red;">*</span>
        </label>
        <input 
          id="nome" 
          type="text" 
          placeholder="Digite seu nome completo" 
          required
          autocomplete="name"
          aria-required="true"
          minlength="3"
        />
      </div>

      <!-- Campo Telefone -->
      <div class="form-group">
        <label for="telefone">
          Telefone <span style="color: red;">*</span>
        </label>
        <input 
          id="telefone" 
          type="tel" 
          placeholder="(00) 00000-0000" 
          required
          autocomplete="tel"
          aria-required="true"
        />
      </div>

      <!-- Campo Servi√ßo -->
      <div class="form-group">
        <label for="servico">
          Tipo de Servi√ßo <span style="color: red;">*</span>
        </label>
        <select id="servico" required aria-required="true">
          <option value="">Selecione um servi√ßo</option>
          <option value="Corte de Cabelo">üíá Corte de Cabelo</option>
          <option value="Barba">üßî Barba</option>
          <option value="Corte + Barba">üíá‚Äç‚ôÇÔ∏è Corte + Barba</option>
          <option value="Manicure">üíÖ Manicure</option>
          <option value="Pedicure">ü¶∂ Pedicure</option>
          <option value="Depila√ß√£o">‚ú® Depila√ß√£o</option>
          <option value="Massagem">üíÜ Massagem</option>
          <option value="Outros">üîß Outros</option>
        </select>
      </div>

      <!-- Campo Servi√ßo Personalizado (aparecer se "Outros" for selecionado) -->
      <div class="form-group" id="servicoCustomDiv" style="display: none;">
        <label for="servicoCustom">
          Especifique o servi√ßo
        </label>
        <input 
          id="servicoCustom" 
          type="text" 
          placeholder="Descreva o servi√ßo desejado"
        />
      </div>

      <!-- Campo Data e Hora -->
      <div class="form-group">
        <label for="dataHora">
          Data e Hor√°rio <span style="color: red;">*</span>
        </label>
        <input 
          id="dataHora" 
          type="datetime-local" 
          required
          aria-required="true"
        />
      </div>

      <!-- Campo Observa√ß√µes -->
      <div class="form-group">
        <label for="observacoes">
          Observa√ß√µes (opcional)
        </label>
        <textarea 
          id="observacoes" 
          placeholder="Alguma observa√ß√£o adicional?"
          rows="3"
          style="resize: vertical;"
        ></textarea>
      </div>

      <!-- Bot√µes de A√ß√£o -->
      <button type="submit" onclick="enviarAgendamento()" class="button">
        ‚úÖ Confirmar Agendamento
      </button>

      <!-- Links de Navega√ß√£o -->
      <a href="index.html" style="text-align: center; margin-top: 8px;">
        ‚Üê Voltar para p√°gina inicial
      </a>

      <a href="#" onclick="logout(); return false;" style="text-align: center; color: #dc3545;">
        üö™ Sair da conta
      </a>

      <!-- Mensagens de Feedback -->
      <div id="msg" role="alert" aria-live="polite" aria-atomic="true"></div>
    </form>
  </main>

  <!-- Firebase SDK (vers√£o 9 - compatibilidade) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Configura√ß√£o Firebase -->
  <script src="firebase/firebase-config.js"></script>

  <!-- L√≥gica de Agendamento -->
  <script>
    // Elementos do DOM
    const nomeInput = document.getElementById('nome');
    const telefoneInput = document.getElementById('telefone');
    const servicoSelect = document.getElementById('servico');
    const servicoCustomDiv = document.getElementById('servicoCustomDiv');
    const servicoCustomInput = document.getElementById('servicoCustom');
    const dataHoraInput = document.getElementById('dataHora');
    const observacoesInput = document.getElementById('observacoes');
    const msgElement = document.getElementById('msg');
    const userInfoDiv = document.getElementById('userInfo');

    // Configurar data m√≠nima (hoje)
    const hoje = new Date();
    hoje.setHours(hoje.getHours() + 1); // Pelo menos 1 hora a partir de agora
    dataHoraInput.min = hoje.toISOString().slice(0, 16);

    // Mostrar/ocultar campo de servi√ßo personalizado
    servicoSelect.addEventListener('change', function() {
      if (this.value === 'Outros') {
        servicoCustomDiv.style.display = 'block';
        servicoCustomInput.required = true;
      } else {
        servicoCustomDiv.style.display = 'none';
        servicoCustomInput.required = false;
      }
    });

    // M√°scara de telefone
    telefoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      }
    });

    // Fun√ß√£o de enviar agendamento
    function enviarAgendamento() {
      // Valida√ß√£o b√°sica
      if (!nomeInput.value || !telefoneInput.value || !servicoSelect.value || !dataHoraInput.value) {
        mostrarMensagem('‚ùå Por favor, preencha todos os campos obrigat√≥rios', 'error');
        return;
      }

      // Validar data futura
      const dataEscolhida = new Date(dataHoraInput.value);
      if (dataEscolhida <= new Date()) {
        mostrarMensagem('‚ùå Por favor, escolha uma data e hora futura', 'error');
        return;
      }

      // Determinar servi√ßo
      let servicoFinal = servicoSelect.value;
      if (servicoSelect.value === 'Outros' && servicoCustomInput.value) {
        servicoFinal = servicoCustomInput.value;
      }

      // Desabilitar formul√°rio durante processamento
      desabilitarFormulario(true);
      mostrarMensagem('üì§ Enviando agendamento...', 'info');

      // Obter usu√°rio atual
      const usuario = firebase.auth().currentUser;
      
      // Dados do agendamento
      const dados = {
        nome: nomeInput.value.trim(),
        telefone: telefoneInput.value.trim(),
        servico: servicoFinal,
        dataHora: dataHoraInput.value,
        observacoes: observacoesInput.value.trim() || 'Nenhuma',
        userEmail: usuario ? usuario.email : 'visitante',
        userId: usuario ? usuario.uid : 'visitante',
        criadoEm: new Date().toISOString(),
        timestamp: Date.now(),
        status: 'pendente'
      };

      // Salvar no Firebase
      firebase.database().ref("agendamentos").push(dados)
        .then(() => {
          mostrarMensagem('‚úÖ Agendamento enviado com sucesso! Entraremos em contato em breve.', 'success');
          limparFormulario();
          desabilitarFormulario(false);
          
          // Opcional: redirecionar ap√≥s alguns segundos
          setTimeout(() => {
            window.location.href = "index.html";
          }, 3000);
        })
        .catch((error) => {
          console.error('Erro ao salvar:', error);
          mostrarMensagem(`‚ùå Erro ao enviar agendamento: ${error.message}`, 'error');
          desabilitarFormulario(false);
        });
    }

    // Fun√ß√£o para mostrar mensagens
    function mostrarMensagem(mensagem, tipo) {
      msgElement.textContent = mensagem;
      msgElement.className = tipo === 'error' ? 'msg-error' : tipo === 'success' ? 'msg-success' : 'msg-info';
      msgElement.style.display = 'block';
    }

    // Fun√ß√£o para limpar formul√°rio
    function limparFormulario() {
      nomeInput.value = '';
      telefoneInput.value = '';
      servicoSelect.value = '';
      servicoCustomInput.value = '';
      dataHoraInput.value = '';
      observacoesInput.value = '';
      servicoCustomDiv.style.display = 'none';
    }

    // Fun√ß√£o para desabilitar/habilitar formul√°rio
    function desabilitarFormulario(desabilitar) {
      const elementos = document.querySelectorAll('input, select, textarea, button');
      elementos.forEach(el => el.disabled = desabilitar);
    }

    // Fun√ß√£o de logout
    function logout() {
      firebase.auth().signOut()
        .then(() => {
          mostrarMensagem('‚úÖ Logout realizado com sucesso', 'success');
          setTimeout(() => {
            window.location.href = "index.html";
          }, 1500);
        })
        .catch((error) => {
          console.error('Erro no logout:', error);
          mostrarMensagem('‚ùå Erro ao fazer logout', 'error');
        });
    }

    // Verificar autentica√ß√£o e mostrar info do usu√°rio
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        userInfoDiv.innerHTML = `‚úÖ Logado como: <strong>${user.email}</strong>`;
        console.log('‚úÖ Usu√°rio autenticado:', user.email);
      } else {
        userInfoDiv.innerHTML = `‚ÑπÔ∏è Agendando como <strong>visitante</strong>`;
        console.log('‚ÑπÔ∏è Agendamento como visitante');
      }
    });
  </script>

  <!-- Estilos adicionais -->
  <style>
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #212529;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    select {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 16px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #212529;
      background: #ffffff;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    select:focus {
      border-color: #0066ff;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      outline: none;
    }
    
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color: #212529;
      background: #ffffff;
      transition: all 0.3s ease;
    }
    
    textarea:focus {
      border-color: #0066ff;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
      outline: none;
    }
  </style>
</body>
</html>
