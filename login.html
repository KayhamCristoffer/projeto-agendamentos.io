<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div class="container slide-up">
    <div class="text-center mb-3">
      <h2 style="font-size: 32px; margin-bottom: 8px;">üîê Bem-vindo!</h2>
      <p style="color: var(--text-secondary);">Entre na sua conta ou crie uma nova</p>
    </div>

    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color);">
      <button class="btn btn-ghost btn-full" id="tabLogin" onclick="mostrarTab('login')" style="border-radius: 0; border-bottom: 3px solid var(--primary-color);">
        Login
      </button>
      <button class="btn btn-ghost btn-full" id="tabCadastro" onclick="mostrarTab('cadastro')" style="border-radius: 0;">
        Cadastrar
      </button>
      <a href="index.html" class="btn btn-ghost btn-full" style="border-radius: 0; color: var(--text-secondary);">
        ‚Üê Voltar
      </a>
    </div>

    <form id="formLogin" class="fade-in">
      <div class="form-group">
        <label class="form-label" for="loginEmail">E-mail</label>
        <input 
          class="form-input" 
          type="email" 
          id="loginEmail" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        >
      </div>

      <div class="form-group">
        <label class="form-label" for="loginSenha">Senha</label>
        <input 
          class="form-input" 
          type="password" 
          id="loginSenha" 
          placeholder="******"
          required
          autocomplete="current-password"
        >
      </div>

      <button class="btn btn-primary btn-full mt-3" type="submit">
        Entrar
      </button>

      <div class="text-center mt-2">
        <a href="#" onclick="mostrarEsqueciSenha(event)" style="font-size: 14px; color: var(--primary-color);">Esqueci a senha</a>
      </div>
    </form>

    <form id="formCadastro" class="hidden">
      <div class="form-group">
        <label class="form-label" for="cadastroNome">Nome Completo</label>
        <input 
          class="form-input" 
          type="text" 
          id="cadastroNome" 
          placeholder="Seu nome"
          required
        >
      </div>
      
      <div class="form-group">
        <label class="form-label" for="cadastroTelefone">Telefone</label>
        <input 
          class="form-input" 
          type="tel" 
          id="cadastroTelefone" 
          placeholder="(99) 99999-9999"
          required
        >
      </div>

      <div class="form-group">
        <label class="form-label" for="cadastroEmail">E-mail</label>
        <input 
          class="form-input" 
          type="email" 
          id="cadastroEmail" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        >
      </div>

      <div class="form-group">
        <label class="form-label" for="cadastroSenha">Senha (m√≠n. 6 caracteres)</label>
        <input 
          class="form-input" 
          type="password" 
          id="cadastroSenha" 
          placeholder="******"
          required
          minlength="6"
          autocomplete="new-password"
        >
      </div>

      <button class="btn btn-primary btn-full mt-3" type="submit">
        Criar Conta
      </button>
    </form>
    
    <form id="formEsqueciSenha" class="hidden">
        <h4 class="mb-2">Recuperar Senha</h4>
        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">
            Insira seu e-mail para receber um link de redefini√ß√£o.
        </p>
        <div class="form-group">
            <label class="form-label" for="resetEmail">E-mail</label>
            <input 
              class="form-input" 
              type="email" 
              id="resetEmail" 
              placeholder="seu@email.com"
              required
            >
        </div>
        <button class="btn btn-warning btn-full mt-3" type="submit">
            üìß Enviar Link
        </button>
        <div class="text-center mt-2">
            <a href="#" onclick="voltarParaLogin(event)" style="font-size: 14px; color: var(--primary-color);">‚Üê Voltar para Login</a>
        </div>
    </form>

    <div id="mensagem" class="mt-2" style="display: none;"></div>
    
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    const formLogin = document.getElementById('formLogin');
    const formCadastro = document.getElementById('formCadastro');
    const formEsqueciSenha = document.getElementById('formEsqueciSenha');
    const tabLogin = document.getElementById('tabLogin');
    const tabCadastro = document.getElementById('tabCadastro');
    
    // Fun√ß√£o para alternar entre as tabs (Login/Cadastro)
    function mostrarTab(tab) {
      // Esconder todos os formul√°rios principais
      formLogin.classList.add('hidden');
      formCadastro.classList.add('hidden');
      formEsqueciSenha.classList.add('hidden'); 
      
      // Remover destaque das tabs
      tabLogin.style.borderBottom = 'none';
      tabCadastro.style.borderBottom = 'none';
      
      // Mostrar a tab/formul√°rio selecionado
      if (tab === 'login') {
        formLogin.classList.remove('hidden');
        tabLogin.style.borderBottom = '3px solid var(--primary-color)';
      } else if (tab === 'cadastro') {
        formCadastro.classList.remove('hidden');
        tabCadastro.style.borderBottom = '3px solid var(--primary-color)';
      }
      
      // Limpar mensagens
      document.getElementById('mensagem').style.display = 'none';
    }
    
    // Fun√ß√£o para mostrar o formul√°rio de recupera√ß√£o de senha
    function mostrarEsqueciSenha(e) {
        e.preventDefault();
        formLogin.classList.add('hidden');
        formCadastro.classList.add('hidden');
        formEsqueciSenha.classList.remove('hidden');
        
        tabLogin.style.borderBottom = 'none';
        tabCadastro.style.borderBottom = 'none';
    }
    
    // Fun√ß√£o para voltar ao login
    function voltarParaLogin(e) {
        if (e) e.preventDefault();
        mostrarTab('login');
    }
    
    // Fun√ß√£o para mostrar mensagens de sucesso/erro
    function mostrarMensagem(texto, tipo) {
      const msg = document.getElementById('mensagem');
      msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
      msg.textContent = texto;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 5000);
    }

    // Inicializa na tab de Login
    mostrarTab('login'); 

    // ===============================================
    // Event Listeners (Firebase)
    // ===============================================

    // Login
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const senha = document.getElementById('loginSenha').value;
      
      try {
        await firebase.auth().signInWithEmailAndPassword(email, senha);
        // O redirecionamento ser√° feito no listener onAuthStateChanged
      } catch (error) {
        let mensagemErro = 'Erro ao fazer login';
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          mensagemErro = 'E-mail ou senha incorretos';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Cadastro
    formCadastro.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nomeCompleto = document.getElementById('cadastroNome').value;
      const telefone = document.getElementById('cadastroTelefone').value;
      const email = document.getElementById('cadastroEmail').value;
      const senha = document.getElementById('cadastroSenha').value;
      
      if (senha.length < 6) {
           mostrarMensagem('‚ùå A senha deve ter no m√≠nimo 6 caracteres', 'erro');
           return;
      }

      try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
        const user = userCredential.user;
        
        // 1. Salvar perfil do usu√°rio com a role 'cliente'
        const perfilData = {
            email: email,
            nomeCompleto: nomeCompleto,
            telefone: telefone,
            role: 'cliente' // Padr√£o: cliente
        };
        // salvarPerfilUsuario est√° em database.js
        await salvarPerfilUsuario(user.uid, perfilData); 
        
        // 2. Opcional: Atualizar displayName no Firebase Auth
        await user.updateProfile({ displayName: nomeCompleto });

        // O redirecionamento ser√° feito no listener onAuthStateChanged
      } catch (error) {
        let mensagemErro = 'Erro ao cadastrar';
        if (error.code === 'auth/email-already-in-use') {
          mensagemErro = 'Este e-mail j√° est√° em uso';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        } else if (error.code === 'auth/weak-password') {
          mensagemErro = 'Senha muito fraca';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Esqueci senha
    formEsqueciSenha.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('resetEmail').value;
      
      try {
        await firebase.auth().sendPasswordResetEmail(email);
        mostrarMensagem('‚úÖ E-mail de recupera√ß√£o enviado! Verifique sua caixa de entrada.', 'sucesso');
        
        setTimeout(() => {
          voltarParaLogin();
        }, 3000);
      } catch (error) {
        let mensagemErro = 'Erro ao enviar e-mail';
        if (error.code === 'auth/user-not-found') {
          mensagemErro = 'E-mail n√£o cadastrado';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Verificar se j√° est√° logado e redirecionar (Listener Global)
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        // obterPerfilUsuario est√° em database.js
        const perfil = await obterPerfilUsuario(user.uid); 
        
        // Redirecionamento baseado na role
        if (perfil && perfil.role === 'admin') {
          window.location.href = 'admin.html';
        } else if (perfil && perfil.role === 'cliente') {
          window.location.href = 'cliente.html';
        } else {
          // Se o perfil n√£o for encontrado ou n√£o tiver role, trata como cliente por padr√£o
          window.location.href = 'cliente.html';
        }
      }
    });
    
    // M√°scara telefone
    document.getElementById('cadastroTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      }
    });

  </script>
</body>
</html>