<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistema de Agendamentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen flex items-center justify-center p-4 transition-colors duration-300">
  
  <!-- Theme Toggle (Fixed Position) -->
  <button onclick="toggleTheme()" class="fixed top-4 right-4 p-3 rounded-full bg-white dark:bg-gray-700 shadow-lg hover:shadow-xl transition z-50">
    <span id="themeIcon" class="text-2xl">ğŸŒ™</span>
  </button>

  <!-- Login/Cadastro Container -->
  <div class="w-full max-w-md">
    <!-- Logo & Title -->
    <div class="text-center mb-8">
      <div class="text-6xl mb-4">ğŸ“…</div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Sistema de Agendamentos</h1>
      <p class="text-gray-600 dark:text-gray-400">Gerencie seus horÃ¡rios com facilidade</p>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 mb-6">
      <button onclick="mostrarAba('login')" id="btnLogin" class="flex-1 py-3 px-4 bg-white dark:bg-gray-800 text-primary font-semibold rounded-t-lg shadow-md transition">
        Entrar
      </button>
      <button onclick="mostrarAba('cadastro')" id="btnCadastro" class="flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 font-semibold rounded-t-lg transition">
        Cadastrar
      </button>
    </div>

    <!-- Login Form -->
    <div id="abaLogin" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8">
      <form id="formLogin" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">E-mail</label>
          <input type="email" id="loginEmail" required 
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
          <div class="relative">
            <input type="password" id="loginSenha" required minlength="6"
                   class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
            <button type="button" onclick="toggleSenha('loginSenha', 'iconLoginSenha')" 
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <span id="iconLoginSenha">ğŸ‘ï¸</span>
            </button>
          </div>
        </div>
        <button type="button" onclick="mostrarAba('esqueci')" class="text-sm text-primary hover:underline">
          Esqueceu a senha?
        </button>
        <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">
          ğŸš€ Entrar
        </button>
      </form>
      <div id="mensagemLogin" class="mt-4 text-center"></div>
    </div>

    <!-- Cadastro Form -->
    <div id="abaCadastro" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 hidden">
      <form id="formCadastro" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo</label>
          <input type="text" id="cadastroNome" required
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone</label>
          <input type="tel" id="cadastroTelefone" required placeholder="(99) 99999-9999" maxlength="15"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">E-mail</label>
          <input type="email" id="cadastroEmail" required
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
          <div class="relative">
            <input type="password" id="cadastroSenha" required minlength="6"
                   class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
            <button type="button" onclick="toggleSenha('cadastroSenha', 'iconCadastroSenha')" 
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <span id="iconCadastroSenha">ğŸ‘ï¸</span>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar Senha</label>
          <div class="relative">
            <input type="password" id="cadastroConfirmaSenha" required minlength="6"
                   class="w-full px-4 py-3 pr-12 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
            <button type="button" onclick="toggleSenha('cadastroConfirmaSenha', 'iconCadastroConfirma')" 
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <span id="iconCadastroConfirma">ğŸ‘ï¸</span>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">
          âœ… Criar Conta
        </button>
      </form>
      <div id="mensagemCadastro" class="mt-4 text-center"></div>
    </div>

    <!-- Esqueceu Senha Form -->
    <div id="abaEsqueci" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 hidden">
      <button onclick="mostrarAba('login')" class="text-sm text-gray-600 dark:text-gray-400 hover:text-primary mb-4">
        â† Voltar ao login
      </button>
      <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Recuperar Senha</h2>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Enviaremos um link de recuperaÃ§Ã£o para seu e-mail</p>
      <form id="formEsqueci" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">E-mail</label>
          <input type="email" id="esqueciEmail" required
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:text-white transition">
        </div>
        <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
          ğŸ“§ Enviar Link
        </button>
      </form>
      <div id="mensagemEsqueci" class="mt-4 text-center"></div>
    </div>

    <!-- Link para Home -->
    <div class="text-center mt-6">
      <a href="index.html" class="text-gray-600 dark:text-gray-400 hover:text-primary transition">
        â† Voltar para home
      </a>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    // MÃ¡scara de telefone
    document.getElementById('cadastroTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      } else if (value.length > 0) {
        value = `(${value}`;
      }
      e.target.value = value;
    });

    // Alternar abas
    function mostrarAba(aba) {
      document.getElementById('abaLogin').classList.add('hidden');
      document.getElementById('abaCadastro').classList.add('hidden');
      document.getElementById('abaEsqueci').classList.add('hidden');
      
      document.getElementById('btnLogin').className = 'flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 font-semibold rounded-t-lg transition';
      document.getElementById('btnCadastro').className = 'flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 font-semibold rounded-t-lg transition';
      
      if (aba === 'login') {
        document.getElementById('abaLogin').classList.remove('hidden');
        document.getElementById('btnLogin').className = 'flex-1 py-3 px-4 bg-white dark:bg-gray-800 text-primary font-semibold rounded-t-lg shadow-md transition';
      } else if (aba === 'cadastro') {
        document.getElementById('abaCadastro').classList.remove('hidden');
        document.getElementById('btnCadastro').className = 'flex-1 py-3 px-4 bg-white dark:bg-gray-800 text-primary font-semibold rounded-t-lg shadow-md transition';
      } else if (aba === 'esqueci') {
        document.getElementById('abaEsqueci').classList.remove('hidden');
      }
    }

    // Mostrar mensagens
    function mostrarMensagem(tipo, mensagem, divId) {
      const div = document.getElementById(divId);
      const classes = tipo === 'sucesso' 
        ? 'bg-green-100 dark:bg-green-900 border border-green-400 text-green-700 dark:text-green-200 px-4 py-3 rounded'
        : 'bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded';
      div.innerHTML = `<div class="${classes}">${mensagem}</div>`;
      setTimeout(() => div.innerHTML = '', 5000);
    }

    // Login
    document.getElementById('formLogin').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const senha = document.getElementById('loginSenha').value;

      try {
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, senha);
        const user = userCredential.user;
        
        // Verificar role do usuÃ¡rio
        const perfil = await obterPerfilUsuario(user.uid);
        
        if (perfil && perfil.role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'cliente.html';
        }
      } catch (error) {
        console.error('Erro ao fazer login:', error);
        mostrarMensagem('erro', 'E-mail ou senha incorretos. Tente novamente.', 'mensagemLogin');
      }
    });

    // Cadastro
    document.getElementById('formCadastro').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('cadastroNome').value;
      const telefone = document.getElementById('cadastroTelefone').value;
      const email = document.getElementById('cadastroEmail').value;
      const senha = document.getElementById('cadastroSenha').value;
      const confirmaSenha = document.getElementById('cadastroConfirmaSenha').value;

      if (senha !== confirmaSenha) {
        mostrarMensagem('erro', 'As senhas nÃ£o coincidem!', 'mensagemCadastro');
        return;
      }

      try {
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
        const user = userCredential.user;
        
        console.log('âœ… UsuÃ¡rio criado no Authentication:', user.uid);
        
        await user.updateProfile({ displayName: nome });
        console.log('âœ… DisplayName atualizado');
        
        const perfil = {
          nome: nome,
          nomeCompleto: nome,
          telefone: telefone,
          email: email,
          role: 'cliente',
          whatsapp: telefone,
          totalVisitas: 0,
          ultimaVisita: null,
          criadoEm: new Date().toISOString(),
          atualizadoEm: new Date().toISOString()
        };
        
        console.log('ğŸ“ Salvando perfil no Realtime Database:', perfil);
        console.log('ğŸ”‘ UID do usuÃ¡rio:', user.uid);
        
        // Salvar diretamente no Firebase Realtime Database
        const dbRef = firebase.database().ref(`usuarios/${user.uid}`);
        console.log('ğŸ“ ReferÃªncia do Firebase:', dbRef.toString());
        
        await dbRef.set(perfil);
        console.log('âœ… Perfil salvo com sucesso no Realtime Database');
        
        // Verificar se foi salvo
        const snapshot = await dbRef.once('value');
        console.log('ğŸ” VerificaÃ§Ã£o - Dados salvos:', snapshot.val());

        mostrarMensagem('sucesso', 'Conta criada com sucesso! Redirecionando...', 'mensagemCadastro');
        setTimeout(() => window.location.href = 'cliente.html', 2000);
      } catch (error) {
        console.error('âŒ Erro ao criar conta:', error);
        let mensagem = 'Erro ao criar conta. Tente novamente.';
        if (error.code === 'auth/email-already-in-use') {
          mensagem = 'Este e-mail jÃ¡ estÃ¡ em uso.';
        }
        mostrarMensagem('erro', mensagem, 'mensagemCadastro');
      }
    });

    // Esqueceu senha
    document.getElementById('formEsqueci').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('esqueciEmail').value;

      try {
        await firebase.auth().sendPasswordResetEmail(email);
        mostrarMensagem('sucesso', 'E-mail de recuperaÃ§Ã£o enviado! Verifique sua caixa de entrada.', 'mensagemEsqueci');
      } catch (error) {
        console.error('Erro ao enviar e-mail:', error);
        mostrarMensagem('erro', 'Erro ao enviar e-mail. Verifique o endereÃ§o e tente novamente.', 'mensagemEsqueci');
      }
    });

    // FunÃ§Ã£o para mostrar/ocultar senha
    function toggleSenha(campoId, iconId) {
      const campo = document.getElementById(campoId);
      const icon = document.getElementById(iconId);
      
      if (campo.type === 'password') {
        campo.type = 'text';
        icon.textContent = 'ğŸ™ˆ';
      } else {
        campo.type = 'password';
        icon.textContent = 'ğŸ‘ï¸';
      }
    }

    // Verificar se jÃ¡ estÃ¡ logado
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        const perfil = await obterPerfilUsuario(user.uid);
        if (perfil && perfil.role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'cliente.html';
        }
      }
    });
  </script>
</body>
</html>
