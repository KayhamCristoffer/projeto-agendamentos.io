<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <div class="container">
    <div class="text-center mb-3">
      <h2>üîê Bem-vindo!</h2>
      <p>Entre na sua conta ou crie uma nova</p>
    </div>

    <!-- Tabs de Login/Cadastro -->
    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color);">
      <button class="btn btn-ghost btn-full" id="tabLogin" onclick="mostrarTab('login')" style="border-radius: 0; border-bottom: 3px solid var(--primary-color);">
        Login
      </button>
      <button class="btn btn-ghost btn-full" id="tabCadastro" onclick="mostrarTab('cadastro')" style="border-radius: 0;">
        Cadastrar
      </button>
    </div>

    <!-- Formul√°rio de Login -->
    <form id="formLogin" class="slide-up">
      <div class="form-group">
        <label class="form-label" for="loginEmail">E-mail</label>
        <input 
          class="form-input" 
          type="email" 
          id="loginEmail" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="loginSenha">Senha</label>
        <input 
          class="form-input" 
          type="password" 
          id="loginSenha" 
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          required
          autocomplete="current-password"
          minlength="6"
        />
      </div>

      <button type="submit" class="btn btn-primary btn-full">
        ‚úÖ Entrar
      </button>

      <div class="text-center mt-2">
        <a href="#" onclick="mostrarEsqueciSenha(); return false;" style="font-size: 14px;">
          Esqueci minha senha
        </a>
      </div>
    </form>

    <!-- Formul√°rio de Cadastro -->
    <form id="formCadastro" class="hidden">
      <div class="form-group">
        <label class="form-label" for="cadNome">Nome Completo</label>
        <input 
          class="form-input" 
          type="text" 
          id="cadNome" 
          placeholder="Seu nome completo"
          required
          autocomplete="name"
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="cadTelefone">Telefone</label>
        <input 
          class="form-input" 
          type="tel" 
          id="cadTelefone" 
          placeholder="(00) 00000-0000"
          required
          autocomplete="tel"
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="cadEmail">E-mail</label>
        <input 
          class="form-input" 
          type="email" 
          id="cadEmail" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        />
      </div>

      <div class="form-group">
        <label class="form-label" for="cadSenha">Senha</label>
        <input 
          class="form-input" 
          type="password" 
          id="cadSenha" 
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          required
          autocomplete="new-password"
          minlength="6"
        />
        <small class="form-help">M√≠nimo de 6 caracteres</small>
      </div>

      <div class="form-group">
        <label class="form-label" for="cadSenhaConfirm">Confirmar Senha</label>
        <input 
          class="form-input" 
          type="password" 
          id="cadSenhaConfirm" 
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          required
          autocomplete="new-password"
          minlength="6"
        />
      </div>

      <button type="submit" class="btn btn-primary btn-full">
        ‚ûï Criar Conta
      </button>
    </form>

    <!-- Formul√°rio de Esqueci Senha -->
    <form id="formEsqueciSenha" class="hidden">
      <div class="text-center mb-2">
        <p style="font-size: 14px; color: var(--text-secondary);">
          Digite seu e-mail e enviaremos instru√ß√µes para redefinir sua senha
        </p>
      </div>

      <div class="form-group">
        <label class="form-label" for="resetEmail">E-mail</label>
        <input 
          class="form-input" 
          type="email" 
          id="resetEmail" 
          placeholder="seu@email.com"
          required
          autocomplete="email"
        />
      </div>

      <button type="submit" class="btn btn-primary btn-full">
        üìß Enviar E-mail de Recupera√ß√£o
      </button>

      <div class="text-center mt-2">
        <a href="#" onclick="voltarParaLogin(); return false;" style="font-size: 14px;">
          ‚Üê Voltar para login
        </a>
      </div>
    </form>

    <!-- Mensagens -->
    <div id="mensagem" class="mt-2"></div>

    <!-- Link para home -->
    <div class="text-center mt-3">
      <a href="index.html" class="btn btn-ghost">
        ‚Üê Voltar para p√°gina inicial
      </a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- Scripts -->
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    // Elementos do DOM
    const formLogin = document.getElementById('formLogin');
    const formCadastro = document.getElementById('formCadastro');
    const formEsqueciSenha = document.getElementById('formEsqueciSenha');
    const mensagem = document.getElementById('mensagem');
    const tabLogin = document.getElementById('tabLogin');
    const tabCadastro = document.getElementById('tabCadastro');

    // Mostrar/Ocultar tabs
    function mostrarTab(tab) {
      if (tab === 'login') {
        formLogin.classList.remove('hidden');
        formCadastro.classList.add('hidden');
        formEsqueciSenha.classList.add('hidden');
        tabLogin.style.borderBottom = '3px solid var(--primary-color)';
        tabCadastro.style.borderBottom = 'none';
      } else {
        formLogin.classList.add('hidden');
        formCadastro.classList.remove('hidden');
        formEsqueciSenha.classList.add('hidden');
        tabLogin.style.borderBottom = 'none';
        tabCadastro.style.borderBottom = '3px solid var(--primary-color)';
      }
      limparMensagem();
    }

    function mostrarEsqueciSenha() {
      formLogin.classList.add('hidden');
      formCadastro.classList.add('hidden');
      formEsqueciSenha.classList.remove('hidden');
      tabLogin.style.borderBottom = 'none';
      tabCadastro.style.borderBottom = 'none';
      limparMensagem();
    }

    function voltarParaLogin() {
      mostrarTab('login');
    }

    // M√°scara de telefone
    document.getElementById('cadTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      }
    });

    // Mostrar mensagem
    function mostrarMensagem(texto, tipo) {
      mensagem.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
      mensagem.textContent = texto;
      mensagem.classList.remove('hidden');
    }

    function limparMensagem() {
      mensagem.className = '';
      mensagem.textContent = '';
      mensagem.classList.add('hidden');
    }

    // Login
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const senha = document.getElementById('loginSenha').value;
      
      try {
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, senha);
        mostrarMensagem('‚úÖ Login realizado com sucesso!', 'sucesso');
        
        // Obter perfil do usu√°rio
        const perfil = await obterPerfilUsuario(userCredential.user.uid);
        
        // Redirecionar baseado no role
        setTimeout(() => {
          if (perfil && perfil.role === 'admin') {
            window.location.href = 'admin.html';
          } else {
            window.location.href = 'cliente.html';
          }
        }, 1000);
      } catch (error) {
        let mensagemErro = 'Erro ao fazer login';
        if (error.code === 'auth/user-not-found') {
          mensagemErro = 'Usu√°rio n√£o encontrado';
        } else if (error.code === 'auth/wrong-password') {
          mensagemErro = 'Senha incorreta';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Cadastro
    formCadastro.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nome = document.getElementById('cadNome').value;
      const telefone = document.getElementById('cadTelefone').value;
      const email = document.getElementById('cadEmail').value;
      const senha = document.getElementById('cadSenha').value;
      const senhaConfirm = document.getElementById('cadSenhaConfirm').value;
      
      // Validar senhas
      if (senha !== senhaConfirm) {
        mostrarMensagem('‚ùå As senhas n√£o coincidem', 'erro');
        return;
      }
      
      try {
        // Criar conta no Firebase Auth
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
        
        // Salvar perfil no database
        await salvarPerfilUsuario(userCredential.user.uid, {
          nome,
          telefone,
          email,
          role: 'cliente',
          criadoEm: new Date().toISOString()
        });
        
        // Atualizar displayName
        await userCredential.user.updateProfile({ displayName: nome });
        
        mostrarMensagem('‚úÖ Conta criada com sucesso! Redirecionando...', 'sucesso');
        
        setTimeout(() => {
          window.location.href = 'cliente.html';
        }, 1500);
      } catch (error) {
        let mensagemErro = 'Erro ao criar conta';
        if (error.code === 'auth/email-already-in-use') {
          mensagemErro = 'Este e-mail j√° est√° em uso';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        } else if (error.code === 'auth/weak-password') {
          mensagemErro = 'Senha muito fraca';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Esqueci senha
    formEsqueciSenha.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('resetEmail').value;
      
      try {
        await firebase.auth().sendPasswordResetEmail(email);
        mostrarMensagem('‚úÖ E-mail de recupera√ß√£o enviado! Verifique sua caixa de entrada.', 'sucesso');
        
        setTimeout(() => {
          voltarParaLogin();
        }, 3000);
      } catch (error) {
        let mensagemErro = 'Erro ao enviar e-mail';
        if (error.code === 'auth/user-not-found') {
          mensagemErro = 'E-mail n√£o cadastrado';
        } else if (error.code === 'auth/invalid-email') {
          mensagemErro = 'E-mail inv√°lido';
        }
        mostrarMensagem('‚ùå ' + mensagemErro, 'erro');
      }
    });

    // Verificar se j√° est√° logado
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        const perfil = await obterPerfilUsuario(user.uid);
        if (perfil && perfil.role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          window.location.href = 'cliente.html';
        }
      }
    });
  </script>
</body>
</html>
