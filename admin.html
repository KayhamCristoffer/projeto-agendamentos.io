<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Sistema de Agendamentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  
  <!-- Navbar -->
  <nav class="bg-white dark:bg-gray-800 shadow-lg fixed w-full top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">ğŸ› ï¸</span>
          <span class="text-xl font-bold text-gray-900 dark:text-white">Painel Admin</span>
        </div>
        <div class="flex items-center space-x-4">
          <span id="nomeAdmin" class="text-gray-600 dark:text-gray-300 text-sm hidden md:block"></span>
          <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <span id="themeIcon" class="text-xl">ğŸŒ™</span>
          </button>
          <a href="cliente.html" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">
            ğŸ‘¤ Ãrea Cliente
          </a>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
            Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="pt-20 pb-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
    
    <!-- EstatÃ­sticas -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalAgendamentos" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Total</div>
      </div>
      <div class="bg-gradient-to-br from-yellow-500 to-orange-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalPendentes" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Pendentes</div>
      </div>
      <div class="bg-gradient-to-br from-blue-500 to-cyan-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalConfirmados" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Confirmados</div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-teal-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalConcluidos" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">ConcluÃ­dos</div>
      </div>
      <div class="bg-gradient-to-br from-red-500 to-pink-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalCancelados" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Cancelados</div>
      </div>
    </div>

    <!-- BotÃ£o Novo Agendamento -->
    <div class="mb-6">
      <button onclick="abrirModalNovoAgendamento()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
        â• Novo Agendamento
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-6 overflow-x-auto border-b-2 border-gray-200 dark:border-gray-700">
      <button onclick="mostrarTab('calendario')" id="tabCalendario" class="px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap">
        ğŸ“… CalendÃ¡rio
      </button>
      <button onclick="mostrarTab('clientes')" id="tabClientes" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ğŸ‘¥ Gerenciar Clientes
      </button>
      <button onclick="mostrarTab('equipe')" id="tabEquipe" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ğŸ‘¥ Equipe
      </button>
      <button onclick="mostrarTab('servicos')" id="tabServicos" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        âœ‚ï¸ ServiÃ§os
      </button>
      <button onclick="mostrarTab('produtos')" id="tabProdutos" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ğŸ›ï¸ Ponto de Vendas
      </button>
      <button onclick="mostrarTab('faturamento')" id="tabFaturamento" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ğŸ’° Faturamento
      </button>
      <button onclick="mostrarTab('pendentes')" id="tabPendentes" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        â³ Pendentes
      </button>
      <button onclick="mostrarTab('confirmados')" id="tabConfirmados" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        âœ… Confirmados
      </button>
      <button onclick="mostrarTab('concluidos')" id="tabConcluidos" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ğŸ‰ ConcluÃ­dos
      </button>
    </div>

    <!-- SeÃ§Ã£o: CalendÃ¡rio -->
    <div id="secaoCalendario">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- CalendÃ¡rio -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">ğŸ“… CalendÃ¡rio</h2>
            <button onclick="carregarCalendario()" class="bg-primary hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition">
              ğŸ”„ Atualizar
            </button>
          </div>
          <div class="flex justify-between items-center mb-4">
            <button onclick="mesAnterior()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">â†</button>
            <h3 id="mesAno" class="font-semibold text-gray-900 dark:text-white"></h3>
            <button onclick="proximoMes()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">â†’</button>
          </div>
          <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">
            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div>
          </div>
          <div id="diasCalendario" class="grid grid-cols-7 gap-1"></div>
        </div>

        <!-- Agendamentos do Dia -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <h2 id="tituloAgendamentosDia" class="text-xl font-bold text-gray-900 dark:text-white mb-4">ğŸ“‹ Selecione uma data</h2>
          <div id="agendamentosDia" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: UsuÃ¡rios -->
    <!-- SeÃ§Ã£o: Pendentes -->
    <div id="secaoPendentes" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">â³ Agendamentos Pendentes</h2>
        <button onclick="carregarPendentes()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaPendentes" class="space-y-4"></div>
    </div>

    <!-- SeÃ§Ã£o: Confirmados -->
    <div id="secaoConfirmados" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">âœ… Agendamentos Confirmados</h2>
        <button onclick="carregarConfirmados()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaConfirmados" class="space-y-4"></div>
    </div>

    <!-- SeÃ§Ã£o: ConcluÃ­dos -->
    <div id="secaoConcluidos" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ğŸ‰ Agendamentos ConcluÃ­dos</h2>
        <button onclick="carregarConcluidos()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaConcluidos" class="space-y-4"></div>
    </div>

    <!-- SeÃ§Ã£o: Gerenciar Clientes -->
    <div id="secaoClientes" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ğŸ‘¥ Gerenciar Clientes</h2>
      <div class="flex gap-2">
        <button onclick="abrirModalAdicionarCliente()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
          â• Adicionar Cliente
        </button>
        <button onclick="carregarClientesAdmin()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Atualizar
        </button>
      </div>
    </div>
    <div id="listaClientesAdmin" class="space-y-4"></div>
    </div>

    <!-- SeÃ§Ã£o: Equipe -->
    <div id="secaoEquipe" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ğŸ‘¥ Nossa Equipe</h2>
      <button onclick="abrirModalAdicionarMembro()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
        â• Adicionar Membro
      </button>
    </div>
    <div id="listaEquipeAdmin" class="grid md:grid-cols-3 gap-4"></div>
    </div>
  </div>
  <!-- ADICIONAR ESTAS 3 SEÃ‡Ã•ES COMPLETAS -->

<!-- SeÃ§Ã£o: ServiÃ§os -->
<!-- SeÃ§Ã£o: ServiÃ§os -->
<div id="secaoServicos" class="hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">âœ‚ï¸ Gerenciar ServiÃ§os</h2>
      <div class="flex gap-2">
        <button onclick="abrirModalServico()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">â• Adicionar</button>
        <button onclick="carregarServicosAdmin()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">ğŸ”„ Atualizar</button>
      </div>
    </div>
    <div id="listaServicosAdmin" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>

<!-- SeÃ§Ã£o: Produtos -->
<div id="secaoProdutos" class="hidden">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">ğŸ›ï¸ Ponto de Vendas</h2>
      <div class="flex gap-2">
        <button onclick="abrirModalProduto()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">â• Adicionar</button>
        <button onclick="carregarProdutosAdmin()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">ğŸ”„ Atualizar</button>
      </div>
    </div>
    <div id="listaProdutosAdmin" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </div>
</div>

<!-- SeÃ§Ã£o: Faturamento -->
<div id="secaoFaturamento" class="hidden">
  <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">ğŸ’° Faturamento</h2>
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6">
    <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">ğŸ“Š Resumo Mensal</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
        <p class="text-sm text-green-600 dark:text-green-300">Receitas</p>
        <p class="text-2xl font-bold text-green-700 dark:text-green-200" id="totalReceitas">R$ 0,00</p>
      </div>
      <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
        <p class="text-sm text-red-600 dark:text-red-300">Despesas</p>
        <p class="text-2xl font-bold text-red-700 dark:text-red-200" id="totalDespesas">R$ 0,00</p>
      </div>
      <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
        <p class="text-sm text-blue-600 dark:text-blue-300">Lucro</p>
        <p class="text-2xl font-bold text-blue-700 dark:text-blue-200" id="lucroTotal">R$ 0,00</p>
      </div>
    </div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white">ğŸ“‹ Extrato</h3>
      <div class="flex gap-2">
        <button onclick="abrirModalNovaDespesa()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm transition">â• Nova Despesa</button>
        <button onclick="abrirModalDespesasRecorrentes()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition">âš™ï¸ Despesas Recorrentes</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Data</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">DescriÃ§Ã£o</th>
            <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 dark:text-gray-300">Tipo</th>
            <th class="px-4 py-2 text-right text-xs font-semibold text-gray-700 dark:text-gray-300">Valor</th>
          </tr>
        </thead>
        <tbody id="tabelaExtrato" class="divide-y divide-gray-200 dark:divide-gray-700">
          <tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum registro</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Nova Despesa -->
<div id="modalNovaDespesa" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white">â• Nova Despesa</h3>
      <button onclick="fecharModalNovaDespesa()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">âœ•</button>
    </div>
    <form id="formNovaDespesa" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">DescriÃ§Ã£o *</label>
        <input type="text" id="descricaoDespesa" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor (R$) *</label>
        <input type="number" id="valorDespesa" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data *</label>
        <input type="date" id="dataDespesa" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
      </div>
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">Adicionar Despesa</button>
        <button type="button" onclick="fecharModalNovaDespesa()" class="flex-1 bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg transition">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Despesas Recorrentes -->
<div id="modalDespesasRecorrentes" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white">âš™ï¸ Gerenciar Despesas Recorrentes</h3>
      <button onclick="fecharModalDespesasRecorrentes()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">âœ•</button>
    </div>
    
    <!-- FormulÃ¡rio Nova Despesa Recorrente -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
      <h4 class="font-bold text-gray-900 dark:text-white mb-3">â• Adicionar Nova Despesa Recorrente</h4>
      <form id="formDespesaRecorrente" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">DescriÃ§Ã£o *</label>
            <input type="text" id="descricaoRecorrente" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="Ex: Aluguel">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Valor (R$) *</label>
            <input type="number" id="valorRecorrente" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dia de CobranÃ§a *</label>
            <input type="number" id="diaRecorrente" min="1" max="31" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="1 a 31">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
            <select id="statusRecorrente" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
              <option value="ativo">âœ… Ativo</option>
              <option value="inativo">â¸ï¸ Inativo</option>
            </select>
          </div>
        </div>
        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">â• Adicionar Despesa Recorrente</button>
      </form>
    </div>
    
    <!-- Lista de Despesas Recorrentes -->
    <div>
      <h4 class="font-bold text-gray-900 dark:text-white mb-3">ğŸ“‹ Despesas Cadastradas</h4>
      <div id="listaDespesasRecorrentes" class="space-y-2">
        <!-- Preenchido dinamicamente -->
      </div>
    </div>
    
    <div class="mt-4">
      <button onclick="fecharModalDespesasRecorrentes()" class="w-full bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg transition">Fechar</button>
    </div>
  </div>
</div>

  <!-- Modal Novo Agendamento -->
  <div id="modalNovoAgendamento" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">â• Novo Agendamento</h3>
        <button onclick="fecharModalNovoAgendamento()" class="text-2xl hover:text-gray-600">&times;</button>
      </div>
      <form id="formNovoAgendamentoAdmin" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Cliente</label>
          <select id="clienteNovoAgendamento" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
            <option value="">Selecione o cliente</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Profissional *</label>
          <select id="profissionalNovoAgendamento" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
            <option value="">Selecione o profissional</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">ServiÃ§os *</label>
          <div id="gridServicosNovoAgendamento" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">ğŸ›ï¸ Produtos (Opcional)</label>
          <div id="gridProdutosNovoAgendamento" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div id="resumoServicosNovoAgendamento" class="hidden p-4 bg-blue-50 dark:bg-blue-900 rounded-lg"></div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Data</label>
            <input type="date" id="dataNovoAgendamento" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
          </div>
          <div id="containerHorarioNovo" class="hidden">
            <label class="block text-sm font-medium mb-2">HorÃ¡rio</label>
            <select id="horarioNovoAgendamento" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">ObservaÃ§Ãµes</label>
          <textarea id="observacoesNovoAgendamento" rows="3" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
          âœ… Criar Agendamento
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Alterar Senha -->
  <div id="modalAlterarSenha" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ğŸ”’ Alterar Senha do UsuÃ¡rio</h3>
      <p id="usuarioAlterarSenha" class="mb-4 text-gray-600 dark:text-gray-400"></p>
      
      <div class="space-y-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nova Senha</label>
          <input type="password" id="novaSenhaAdmin" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" minlength="6" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar Senha</label>
          <input type="password" id="confirmaSenhaAdmin" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" minlength="6" placeholder="Repita a senha">
        </div>
      </div>
      
      <p class="text-xs text-yellow-600 dark:text-yellow-400 mb-4">
        âš ï¸ Nota: Como nÃ£o hÃ¡ backend Admin SDK, serÃ¡ enviado um email de recuperaÃ§Ã£o para o usuÃ¡rio redefinir a senha.
      </p>
      
      <div class="flex gap-2">
        <button onclick="alterarSenhaUsuario()" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ“§ Enviar Email
        </button>
        <button onclick="fecharModalAlterarSenha()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Cliente -->
  <div id="modalAdicionarCliente" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">â• Adicionar Novo Cliente</h3>
      <form id="formAdicionarCliente" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo *</label>
          <input type="text" id="novoClienteNome" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="JoÃ£o Silva">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email *</label>
          <input type="email" id="novoClienteEmail" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="cliente@email.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone/WhatsApp *</label>
          <input type="tel" id="novoClienteTelefone" required maxlength="15" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="(11) 98765-4321">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha Inicial *</label>
          <input type="password" id="novoClienteSenha" required minlength="6" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <p class="text-xs text-gray-600 dark:text-gray-400">
          â„¹ï¸ O cliente serÃ¡ criado no Firebase Authentication e no Realtime Database.
        </p>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            âœ… Criar Cliente
          </button>
          <button type="button" onclick="fecharModalAdicionarCliente()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Adicionar Membro Equipe -->
  <div id="modalAdicionarMembro" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">â• Adicionar Membro</h3>
      <form id="formAdicionarMembro" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Nome</label>
          <input type="text" id="nomeMembro" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Cargo</label>
          <input type="text" id="cargoMembro" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Bio</label>
          <textarea id="bioMembro" rows="3" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">URL da Foto</label>
          <input type="url" id="fotoMembro" placeholder="https://..." required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            âœ… Adicionar
          </button>
          <button type="button" onclick="fecharModalAdicionarMembro()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
<!-- Modal ServiÃ§o -->
<div id="modalServico" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4" id="tituloModalServico">â• Adicionar ServiÃ§o</h3>
    <form id="formServico" class="space-y-4">
      <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Nome *</label><input type="text" id="nomeServico" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">DescriÃ§Ã£o</label><textarea id="descricaoServico" rows="2" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">PreÃ§o (R$) *</label><input type="number" id="precoServico" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">DuraÃ§Ã£o (min) *</label><input type="number" id="duracaoServico" required min="5" step="5" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Ãcone</label><input type="text" id="iconeServico" placeholder="âœ‚ï¸" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Categoria</label><input type="text" id="categoriaServico" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ğŸ’¾ Salvar</button>
        <button type="button" onclick="fecharModalServico()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Produto -->
<div id="modalProduto" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4" id="tituloModalProduto">â• Adicionar Produto</h3>
    <form id="formProduto" class="space-y-4">
      <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Nome *</label><input type="text" id="nomeProduto" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">DescriÃ§Ã£o</label><textarea id="descricaoProduto" rows="2" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">PreÃ§o (R$) *</label><input type="number" id="precoProduto" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Estoque *</label><input type="number" id="estoqueProduto" required min="0" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Ãcone</label><input type="text" id="iconeProduto" placeholder="ğŸ§´" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
        <div><label class="block text-sm font-medium mb-2 text-gray-900 dark:text-white">Categoria</label><input type="text" id="categoriaProduto" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></div>
      </div>
      <div class="flex gap-2">
        <button type="submit" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg">ğŸ’¾ Salvar</button>
        <button type="button" onclick="fecharModalProduto()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Cancelar</button>
      </div>
    </form>
  </div>
</div>
  <!-- Modal de Chat -->
  <div id="modalChat" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
      <div class="bg-primary text-white p-4 rounded-t-lg flex justify-between items-center">
        <span id="chatTitulo" class="font-bold">ğŸ’¬ Chat com Cliente</span>
        <div class="flex items-center gap-2">
          <button onclick="carregarMensagens()" class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition">
            ğŸ”„ Atualizar
          </button>
          <button onclick="fecharChat()" class="text-2xl hover:text-gray-200">&times;</button>
        </div>
      </div>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 dark:bg-gray-900"></div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." 
               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <button onclick="enviarMensagemChat()" class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
          ğŸ“¤
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de EdiÃ§Ã£o -->
  <div id="modalEditar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">âœï¸ Editar Agendamento</h3>
      <form id="formEditar" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
          <input type="date" id="editarData" required
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">HorÃ¡rio</label>
          <input type="time" id="editarHora" required
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PreÃ§o Original</label>
          <input type="text" id="editarPrecoOriginal" readonly
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-900 dark:text-gray-400">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Desconto (R$)</label>
          <input type="number" id="editarDesconto" min="0" step="0.01" value="0"
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"
                 onchange="atualizarPrecoFinal()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">PreÃ§o Final</label>
          <input type="text" id="editarPrecoFinal" readonly
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-green-100 dark:bg-green-900 dark:text-white font-bold">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
          <select id="editarStatus" required
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            <option value="pendente">Pendente</option>
            <option value="confirmado">Confirmado</option>
            <option value="concluido">ConcluÃ­do</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            ğŸ’¾ Salvar
          </button>
          <button type="button" onclick="fecharModalEditar()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Cancelar Agendamento -->
  <div id="modalCancelar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-red-600 dark:text-red-400 mb-4">âŒ Cancelar Agendamento</h3>
      <p class="text-gray-600 dark:text-gray-400 mb-4">Por favor, informe o motivo do cancelamento:</p>
      <form id="formCancelar" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Motivo do Cancelamento *</label>
          <textarea id="motivoCancelamento" required rows="4" 
                    placeholder="Ex: Cliente desistiu, mudanÃ§a de horÃ¡rio, etc."
                    class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-red-500 dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-300 dark:border-yellow-700 rounded-lg p-3">
          <p class="text-sm text-yellow-800 dark:text-yellow-200">
            âš ï¸ Esta aÃ§Ã£o nÃ£o pode ser desfeita. O agendamento serÃ¡ marcado como cancelado.
          </p>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
            âŒ Confirmar Cancelamento
          </button>
          <button type="button" onclick="fecharModalCancelar()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Voltar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="firebase/session-manager.js"></script>
  <script src="assets/correcoes.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let adminAtual = null;
    let chatAgendamentoId = null;
    let chatListener = null;
    let editandoAgendamentoId = null;
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();
    let dataSelecionada = null;

    // Verificar autenticaÃ§Ã£o e permissÃ£o
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      
      const perfil = await obterPerfilUsuario(user.uid);
      if (!perfil || perfil.role !== 'admin') {
        window.location.href = 'cliente.html';
        return;
      }
      
      adminAtual = user;
      document.getElementById('nomeAdmin').textContent = user.displayName || user.email;
      
      await atualizarEstatisticas();
      await carregarCalendario();
      await carregarClientesAdmin();
    });

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    // Alternar tabs
    function mostrarTab(tab) {
      // Adicionar tabs de serviÃ§os, produtos e faturamento
      const allTabs = ['calendario', 'usuarios', 'clientes', 'equipe', 'servicos', 'produtos', 'faturamento', 'pendentes', 'confirmados', 'concluidos'];
      
      allTabs.forEach(t => {
        const secao = document.getElementById(`secao${t.charAt(0).toUpperCase() + t.slice(1)}`);
        if (secao) secao.classList.add('hidden');
        const tabBtn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
        if (tabBtn) tabBtn.className = 'px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap';
      });
      
      const secaoAtiva = document.getElementById(`secao${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (secaoAtiva) secaoAtiva.classList.remove('hidden');
      const tabAtiva = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (tabAtiva) tabAtiva.className = 'px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap';
      
      // Carregar dados da seÃ§Ã£o
      if (tab === 'pendentes') carregarPendentes();
      else if (tab === 'confirmados') carregarConfirmados();
      else if (tab === 'concluidos') carregarConcluidos();
      else if (tab === 'clientes') carregarClientesAdmin();
      else if (tab === 'equipe') carregarEquipeAdmin();
      else if (tab === 'servicos') carregarServicosAdmin();
      else if (tab === 'produtos') carregarProdutosAdmin();
      else if (tab === 'faturamento') carregarFaturamento();
    }

    // Atualizar estatÃ­sticas
    async function atualizarEstatisticas() {
      try {
        const agendamentos = await listarAgendamentosOnce();
        const todos = Object.values(agendamentos || {});
        
        document.getElementById('totalAgendamentos').textContent = todos.length;
        document.getElementById('totalPendentes').textContent = todos.filter(a => a.status === 'pendente').length;
        document.getElementById('totalConfirmados').textContent = todos.filter(a => a.status === 'confirmado').length;
        document.getElementById('totalConcluidos').textContent = todos.filter(a => a.status === 'concluido').length;
        document.getElementById('totalCancelados').textContent = todos.filter(a => a.status === 'cancelado').length;
      } catch (error) {
        console.error('Erro ao atualizar estatÃ­sticas:', error);
      }
    }

    // CalendÃ¡rio
    function mesAnterior() {
      if (mesAtual === 0) {
        mesAtual = 11;
        anoAtual--;
      } else {
        mesAtual--;
      }
      carregarCalendario();
    }

    function proximoMes() {
      if (mesAtual === 11) {
        mesAtual = 0;
        anoAtual++;
      } else {
        mesAtual++;
      }
      carregarCalendario();
    }

    async function carregarCalendario() {
      const meses = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      document.getElementById('mesAno').textContent = `${meses[mesAtual]} ${anoAtual}`;
      
      const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0).getDate();
      
      const container = document.getElementById('diasCalendario');
      container.innerHTML = '';
      
      // Dias vazios
      for (let i = 0; i < primeiroDia; i++) {
        container.innerHTML += '<div class="p-2"></div>';
      }
      
      // Carregar agendamentos do mÃªs
      const agendamentos = await listarAgendamentosOnce();
      const agendamentosDoMes = Object.entries(agendamentos || {}).filter(([id, a]) => {
        const data = new Date(a.dataHora);
        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
      });
      
      // Dias do mÃªs
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const data = new Date(anoAtual, mesAtual, dia);
        const dataStr = data.toISOString().split('T')[0];
        const agendamentosNoDia = agendamentosDoMes.filter(([id, a]) => a.dataHora.startsWith(dataStr));
        
        const hoje = new Date();
        const ehHoje = dia === hoje.getDate() && mesAtual === hoje.getMonth() && anoAtual === hoje.getFullYear();
        
        container.innerHTML += `
          <div onclick="selecionarDia('${dataStr}')" 
               class="p-2 text-center cursor-pointer rounded hover:bg-primary hover:text-white transition ${ehHoje ? 'bg-primary text-white font-bold' : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'}">
            <div class="text-sm">${dia}</div>
            ${agendamentosNoDia.length > 0 ? `<div class="text-xs mt-1">â—</div>` : ''}
          </div>
        `;
      }
    }

    async function selecionarDia(data) {
      dataSelecionada = data;
      const dataFormatada = new Date(data + 'T00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
      document.getElementById('tituloAgendamentosDia').textContent = `ğŸ“‹ ${dataFormatada}`;
      
      const container = document.getElementById('agendamentosDia');
      container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const agendamentosNoDia = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.dataHora.startsWith(data))
          .sort((a, b) => a[1].dataHora.localeCompare(b[1].dataHora));
        
        if (agendamentosNoDia.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento neste dia</div>';
          return;
        }
        
        container.innerHTML = agendamentosNoDia.map(([id, a]) => `
          <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded border-l-4 ${getStatusColor(a.status)}">
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-semibold text-gray-900 dark:text-white">${a.clienteNome}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} â€¢ ${a.duracaoTotal} min
                </p>
              </div>
              <span class="text-xs px-2 py-1 rounded ${getStatusBadge(a.status)}">
                ${getStatusText(a.status)}
              </span>
            </div>
            <div class="flex gap-2 mt-2">
              <button onclick="abrirChat('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition">
                ğŸ’¬ Chat
              </button>
              <button onclick="abrirModalEditar('${id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-xs transition">
                âœï¸
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        container.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    // Carregar pendentes
    async function carregarPendentes() {
      await carregarAgendamentosPorStatus('pendente', 'listaPendentes');
    }

    async function carregarConfirmados() {
      await carregarAgendamentosPorStatus('confirmado', 'listaConfirmados');
    }

    async function carregarConcluidos() {
      // Carregar concluÃ­dos e cancelados na mesma lista
      const lista = document.getElementById('listaConcluidos');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        // Converter objeto para array de [id, agendamento]
        const filtrados = Object.entries(agendamentos || {})
          .filter(([, a]) => a.status === 'concluido' || a.status === 'cancelado')
          .sort((a, b) => new Date(b[1].dataHora) - new Date(a[1].dataHora));
        
        if (filtrados.length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento concluÃ­do ou cancelado</div>';
          return;
        }
        
        lista.innerHTML = filtrados.map(([id, a]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow ${a.status === 'cancelado' ? 'border-l-4 border-red-500' : ''}">
            <div class="flex justify-between items-start mb-4">
              <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">${a.clienteNome}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  ğŸ“§ ${a.clienteEmail}
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                  ğŸ“… ${a.dataHora ? (() => {
                    try {
                      const [data, hora] = a.dataHora.split('T');
                      const [ano, mes, dia] = data.split('-');
                      return `${dia}/${mes}/${ano} Ã s ${hora}`;
                    } catch {
                      return a.dataHora;
                    }
                  })() : 'Data nÃ£o disponÃ­vel'}
                </p>
                ${a.profissionalNome ? `<p class="text-sm text-gray-600 dark:text-gray-400">ğŸ‘¤ Profissional: ${a.profissionalNome}</p>` : ''}
              </div>
              <div class="text-right">
                ${a.status === 'cancelado' ? `
                  <div class="text-lg font-bold text-red-600 dark:text-red-400 mb-2">
                    âŒ CANCELADO
                  </div>
                ` : ''}
                <div class="text-2xl font-bold ${a.status === 'cancelado' ? 'line-through text-gray-400' : 'text-primary'}">
                  ${a.desconto && a.desconto > 0 && a.status !== 'cancelado' ? `
                    <div class="text-sm line-through text-gray-400">${formatarPreco(a.precoOriginal || a.precoTotal)}</div>
                    <div>${formatarPreco(a.precoTotal)}</div>
                    <div class="text-xs text-green-600">Desconto: ${formatarPreco(a.desconto)}</div>
                  ` : formatarPreco(a.precoTotal)}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${a.duracaoTotal} min</div>
              </div>
            </div>
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ServiÃ§os:</p>
              <div class="flex flex-wrap gap-2">
                ${(a.servicos || []).map(s => `<span class="px-2 py-1 ${a.status === 'cancelado' ? 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' : 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200'} rounded text-sm">${s.nome}</span>`).join('')}
              </div>
            </div>
            ${a.produtos && a.produtos.length > 0 ? `
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Produtos:</p>
              <div class="flex flex-wrap gap-2">
                ${a.produtos.map(p => `<span class="px-2 py-1 ${a.status === 'cancelado' ? 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'} rounded text-sm">ğŸ›ï¸ ${p.nome} - ${formatarPreco(p.preco)}</span>`).join('')}
              </div>
            </div>
            ` : ''}
            ${a.status === 'cancelado' && a.motivoCancelamento ? `
            <div class="mt-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
              <p class="text-sm font-semibold text-red-800 dark:text-red-200 mb-1">Motivo do Cancelamento:</p>
              <p class="text-sm text-red-700 dark:text-red-300">${a.motivoCancelamento}</p>
              ${a.canceladoEm ? `<p class="text-xs text-red-600 dark:text-red-400 mt-1">Cancelado em: ${new Date(a.canceladoEm).toLocaleDateString('pt-BR')}</p>` : ''}
            </div>
            ` : ''}
            ${a.observacoes && a.status !== 'cancelado' ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-4">Obs: ${a.observacoes}</p>` : ''}
            <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
              <button onclick="abrirModalEditar('${id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition">
                âœï¸ Editar
              </button>
              <button onclick="deletarAgendamento('${id}', '${a.clienteNome}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition">
                ğŸ—‘ï¸ Deletar
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar concluÃ­dos/cancelados:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    async function carregarAgendamentosPorStatus(status, containerId) {
      const lista = document.getElementById(containerId);
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const filtrados = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.status === status)
          .sort((a, b) => new Date(b[1].dataHora) - new Date(a[1].dataHora));
        
        if (filtrados.length === 0) {
          lista.innerHTML = `<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento ${status}</div>`;
          return;
        }
        
        lista.innerHTML = filtrados.map(([id, a]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${a.clienteNome}</h3>
                <p class="text-gray-600 dark:text-gray-400">${a.clienteEmail}</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">
                  ${a.dataHora ? `
                    ${new Date(a.dataHora).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })} Ã s 
                    ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                  ` : 'Data nÃ£o disponÃ­vel'}
                </p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-primary">
                  ${a.desconto && a.desconto > 0 ? `
                    <div class="text-sm line-through text-gray-400">${formatarPreco(a.precoOriginal || a.precoTotal)}</div>
                    <div>${formatarPreco(a.precoTotal)}</div>
                    <div class="text-xs text-green-600">Desconto: ${formatarPreco(a.desconto)}</div>
                  ` : formatarPreco(a.precoTotal)}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${a.duracaoTotal} min</div>
              </div>
            </div>
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">ServiÃ§os:</p>
              <div class="flex flex-wrap gap-2">
                ${(a.servicos || []).map(s => `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm">${s.nome}</span>`).join('')}
              </div>
            </div>
            ${a.produtos && a.produtos.length > 0 ? `
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Produtos:</p>
              <div class="flex flex-wrap gap-2">
                ${a.produtos.map(p => `<span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-sm">ğŸ›ï¸ ${p.nome} - ${formatarPreco(p.preco)}</span>`).join('')}
              </div>
            </div>
            ` : ''}
            ${a.observacoes ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Obs: ${a.observacoes}</p>` : ''}
            <div class="flex gap-2">
              <button onclick="abrirChat('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                ğŸ’¬ Chat
              </button>
              <button onclick="abrirModalEditar('${id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                âœï¸ Editar
              </button>
              ${status === 'pendente' ? `
                <button onclick="confirmarAgendamento('${id}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                  âœ… Confirmar
                </button>
                <button onclick="abrirModalCancelar('${id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                  âŒ Cancelar
                </button>
              ` : ''}
              ${status === 'confirmado' ? `
                <button onclick="concluirAgendamento('${id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
                  ğŸ‰ Concluir
                </button>
                <button onclick="abrirModalCancelar('${id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                  âŒ Cancelar
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    // AÃ§Ãµes de agendamento
    async function confirmarAgendamento(id) {
      try {
        await alterarStatusAgendamento(id, 'confirmado');
        await atualizarEstatisticas();
        await carregarPendentes();
        alert('Agendamento confirmado com sucesso!');
      } catch (error) {
        console.error('Erro ao confirmar:', error);
        alert('Erro ao confirmar agendamento. Tente novamente.');
      }
    }

    async function concluirAgendamento(id) {
      try {
        // Obter dados do agendamento para descontar estoque
        const agendamento = await obterAgendamento(id);
        
        // Descontar estoque dos produtos (se houver)
        if (agendamento.produtos && agendamento.produtos.length > 0) {
          for (const produto of agendamento.produtos) {
            await descontarEstoqueProduto(produto.id, 1); // Desconta 1 unidade
          }
        }
        
        // Incrementar totalVisitas do cliente
        if (agendamento.clienteId) {
          await incrementarVisitasCliente(agendamento.clienteId);
        }
        
        await alterarStatusAgendamento(id, 'concluido');
        await atualizarEstatisticas();
        await carregarConfirmados();
        alert('Agendamento concluÃ­do com sucesso! Estoque e visitas atualizados.');
      } catch (error) {
        console.error('Erro ao concluir:', error);
        alert('Erro ao concluir agendamento. Tente novamente.');
      }
    }
    
    // Incrementar visitas do cliente
    async function incrementarVisitasCliente(clienteId) {
      try {
        const clienteRef = firebase.database().ref(`usuarios/${clienteId}`);
        const snapshot = await clienteRef.once('value');
        const cliente = snapshot.val();
        
        if (cliente) {
          const totalVisitas = (cliente.totalVisitas || 0) + 1;
          await clienteRef.update({
            totalVisitas: totalVisitas,
            ultimaVisita: new Date().toISOString(),
            atualizadoEm: new Date().toISOString()
          });
          console.log(`âœ… Visitas do cliente ${cliente.nome} incrementadas: ${totalVisitas}`);
        }
      } catch (error) {
        console.error('Erro ao incrementar visitas:', error);
      }
    }
    
    // Descontar estoque de produto
    async function descontarEstoqueProduto(produtoId, quantidade = 1) {
      try {
        const produtoRef = firebase.database().ref(`produtos/${produtoId}`);
        const snapshot = await produtoRef.once('value');
        const produto = snapshot.val();
        
        if (produto && produto.estoque !== undefined) {
          const novoEstoque = Math.max(0, produto.estoque - quantidade);
          await produtoRef.update({
            estoque: novoEstoque,
            atualizadoEm: new Date().toISOString()
          });
          console.log(`Estoque atualizado: ${produto.nome} - Novo estoque: ${novoEstoque}`);
        }
      } catch (error) {
        console.error('Erro ao descontar estoque:', error);
      }
    }
    
    // Deletar Agendamento
    async function deletarAgendamento(id, clienteNome) {
      if (!confirm(`âš ï¸ Deseja realmente DELETAR o agendamento de "${clienteNome}"?\n\nEsta aÃ§Ã£o NÃƒO pode ser desfeita!`)) {
        return;
      }
      
      try {
        // Deletar agendamento
        await firebase.database().ref(`agendamentos/${id}`).remove();
        
        // Deletar chat associado (se existir)
        await firebase.database().ref(`chats/${id}`).remove();
        
        console.log(`âœ… Agendamento ${id} deletado com sucesso`);
        alert('Agendamento deletado com sucesso!');
        
        // Recarregar lista
        await atualizarEstatisticas();
        await carregarConcluidos();
      } catch (error) {
        console.error('Erro ao deletar agendamento:', error);
        alert('Erro ao deletar agendamento. Tente novamente.');
      }
    }
    
    // Modal de Cancelamento
    let cancelandoAgendamentoId = null;
    
    function abrirModalCancelar(id) {
      cancelandoAgendamentoId = id;
      document.getElementById('motivoCancelamento').value = '';
      document.getElementById('modalCancelar').classList.remove('hidden');
    }
    
    function fecharModalCancelar() {
      cancelandoAgendamentoId = null;
      document.getElementById('modalCancelar').classList.add('hidden');
      document.getElementById('formCancelar').reset();
    }
    
    document.getElementById('formCancelar').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const motivo = document.getElementById('motivoCancelamento').value.trim();
      
      if (!motivo) {
        alert('Por favor, informe o motivo do cancelamento.');
        return;
      }
      
      try {
        await firebase.database().ref(`agendamentos/${cancelandoAgendamentoId}`).update({
          status: 'cancelado',
          motivoCancelamento: motivo,
          canceladoEm: new Date().toISOString(),
          atualizadoEm: new Date().toISOString()
        });
        
        alert('Agendamento cancelado com sucesso.');
        fecharModalCancelar();
        await atualizarEstatisticas();
        await carregarCalendario();
        
        // Recarregar a lista apropriada
        if (dataSelecionada) await selecionarDia(dataSelecionada);
      } catch (error) {
        console.error('Erro ao cancelar agendamento:', error);
        alert('Erro ao cancelar agendamento. Tente novamente.');
      }
    });

    // Modal de ediÃ§Ã£o
    function abrirModalEditar(id) {
      editandoAgendamentoId = id;
      obterAgendamento(id).then(agendamento => {
        const [data, hora] = agendamento.dataHora.split('T');
        document.getElementById('editarData').value = data;
        document.getElementById('editarHora').value = hora;
        document.getElementById('editarStatus').value = agendamento.status;
        
        // PreÃ§os
        const precoOriginal = agendamento.precoOriginal || agendamento.precoTotal || 0;
        const desconto = agendamento.desconto || 0;
        const precoFinal = precoOriginal - desconto;
        
        document.getElementById('editarPrecoOriginal').value = formatarPreco(precoOriginal);
        document.getElementById('editarDesconto').value = desconto;
        document.getElementById('editarPrecoFinal').value = formatarPreco(precoFinal);
        
        document.getElementById('modalEditar').classList.remove('hidden');
      });
    }
    
    function atualizarPrecoFinal() {
      const precoOriginalText = document.getElementById('editarPrecoOriginal').value;
      // Corrigir parsing: remover R$, trocar vÃ­rgula por ponto, remover pontos de milhar
      const precoOriginal = parseFloat(precoOriginalText.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
      const desconto = parseFloat(document.getElementById('editarDesconto').value) || 0;
      const precoFinal = Math.max(0, precoOriginal - desconto);
      document.getElementById('editarPrecoFinal').value = formatarPreco(precoFinal);
    }

    function fecharModalEditar() {
      document.getElementById('modalEditar').classList.add('hidden');
      editandoAgendamentoId = null;
    }

    document.getElementById('formEditar').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = document.getElementById('editarData').value;
      const hora = document.getElementById('editarHora').value;
      const status = document.getElementById('editarStatus').value;
      
      // Calcular preÃ§os
      const precoOriginalText = document.getElementById('editarPrecoOriginal').value;
      // Corrigir parsing: remover R$, remover TODOS os pontos (milhar), trocar vÃ­rgula por ponto
      const precoOriginal = parseFloat(precoOriginalText.replace('R$', '').replace(/\./g, '').replace(',', '.').trim()) || 0;
      const desconto = parseFloat(document.getElementById('editarDesconto').value) || 0;
      const precoTotal = Math.max(0, precoOriginal - desconto);
      
      try {
        await atualizarAgendamento(editandoAgendamentoId, {
          dataHora: `${data}T${hora}`,
          status: status,
          precoOriginal: precoOriginal,
          desconto: desconto,
          precoTotal: precoTotal,
          atualizadoEm: new Date().toISOString()
        });
        
        fecharModalEditar();
        await atualizarEstatisticas();
        await carregarCalendario();
        if (dataSelecionada) await selecionarDia(dataSelecionada);
        alert('Agendamento atualizado com sucesso!');
      } catch (error) {
        console.error('Erro ao atualizar:', error);
        alert('Erro ao atualizar agendamento. Tente novamente.');
      }
    });

    // Chat
    function abrirChat(agendamentoId) {
      chatAgendamentoId = agendamentoId;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagens();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      if (chatListener) chatListener();
      chatAgendamentoId = null;
    }

    function carregarMensagens() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      chatListener = listarMensagens(chatAgendamentoId, (mensagens) => {
        if (!mensagens || Object.keys(mensagens).length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Nenhuma mensagem ainda</div>';
          return;
        }
        
        const msgs = Object.values(mensagens).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        container.innerHTML = msgs.map(m => {
          const isAdmin = m.userId === adminAtual.uid;
          const nome = m.nome || 'UsuÃ¡rio';
          const texto = m.texto || '';
          const data = m.timestamp ? new Date(m.timestamp) : new Date();
          const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          
          return `
            <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
              <div class="max-w-xs px-4 py-2 rounded-lg ${isAdmin ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'}">
                <p class="text-xs font-semibold mb-1">${nome}</p>
                <p>${texto}</p>
                <p class="text-xs opacity-75 mt-1">${horaFormatada}</p>
              </div>
            </div>
          `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const texto = input.value.trim();
      if (!texto) return;
      
      try {
        await enviarMensagem(chatAgendamentoId, {
          userId: adminAtual.uid,
          nome: 'Admin',
          texto: texto,
          timestamp: Date.now()
        });
        input.value = '';
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem. Tente novamente.');
      }
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarMensagemChat();
    });

    // Gerenciar Clientes
    async function carregarClientesAdmin() {
      const lista = document.getElementById('listaClientesAdmin');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        // Buscar usuÃ¡rios do Realtime Database
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuariosDB = snapshot.val() || {};
        
        // Buscar todos os usuÃ¡rios do Authentication (se for admin)
        // Nota: Firebase Admin SDK Ã© necessÃ¡rio no backend para listar todos os usuÃ¡rios
        // Por enquanto, vamos usar apenas os do Database
        
        if (Object.keys(usuariosDB).length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum usuÃ¡rio cadastrado</div>';
          return;
        }
        
        // Filtrar apenas clientes (role !== admin) e ordenar por data de criaÃ§Ã£o
        const clientes = Object.entries(usuariosDB)
          .filter(([id, u]) => u.role !== 'admin')
          .sort(([, a], [, b]) => {
            const dataA = new Date(a.criadoEm || 0);
            const dataB = new Date(b.criadoEm || 0);
            return dataB - dataA; // Mais recente primeiro
          });
        
        if (clientes.length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum cliente cadastrado</div>';
          return;
        }
        
        lista.innerHTML = clientes.map(([id, u]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">${u.nome || u.nomeCompleto || 'Sem nome'}</h3>
                <p class="text-gray-600 dark:text-gray-400 mt-1">ğŸ“§ ${u.email}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ğŸ“± ${u.whatsapp || u.telefone || 'Sem telefone'}</p>
                <div class="mt-3 space-y-1">
                  <p class="text-sm text-gray-500 dark:text-gray-400">ğŸ‘¥ Total de Visitas: <span class="font-semibold">${u.totalVisitas || 0}</span></p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">ğŸ“… Ãšltima Visita: <span class="font-semibold">${u.ultimaVisita ? new Date(u.ultimaVisita).toLocaleDateString('pt-BR') : 'Nunca'}</span></p>
                  <p class="text-sm text-gray-500 dark:text-gray-400">ğŸ“ Cadastrado em: <span class="font-semibold">${u.criadoEm ? new Date(u.criadoEm).toLocaleDateString('pt-BR') : 'Data desconhecida'}</span></p>
                </div>
                <span class="inline-block mt-3 px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                  ğŸ‘¤ Cliente
                </span>
              </div>
              <div class="flex flex-col gap-2 ml-4">
                <button onclick="editarCliente('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">
                  âœï¸ Editar
                </button>
                <button onclick="modalAlterarSenhaUsuario('${id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition text-sm">
                  ğŸ”’ Senha
                </button>
                <button onclick="deletarCliente('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm">
                  ğŸ—‘ï¸ Excluir
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar clientes</div>';
      }
    }

    let usuarioIdSenha = null;
    function modalAlterarSenhaUsuario(userId) {
      usuarioIdSenha = userId;
      obterPerfilUsuario(userId).then(perfil => {
        document.getElementById('usuarioAlterarSenha').textContent = 
          `UsuÃ¡rio: ${perfil.nome || perfil.nomeCompleto || 'Sem nome'} (${perfil.email})`;
        document.getElementById('modalAlterarSenha').classList.remove('hidden');
      });
    }

    function fecharModalAlterarSenha() {
      document.getElementById('modalAlterarSenha').classList.add('hidden');
      document.getElementById('novaSenhaAdmin').value = '';
      document.getElementById('confirmaSenhaAdmin').value = '';
      usuarioIdSenha = null;
    }

    async function alterarSenhaUsuario() {
      const novaSenha = document.getElementById('novaSenhaAdmin').value;
      const confirmaSenha = document.getElementById('confirmaSenhaAdmin').value;
      
      if (!novaSenha || novaSenha.length < 6) {
        alert('A senha deve ter no mÃ­nimo 6 caracteres.');
        return;
      }
      
      if (novaSenha !== confirmaSenha) {
        alert('As senhas nÃ£o coincidem!');
        return;
      }
      
      try {
        const perfil = await obterPerfilUsuario(usuarioIdSenha);
        
        // Atualizar senha no Authentication (requer Admin SDK no backend)
        // Como nÃ£o temos backend, vamos apenas enviar email de reset
        await firebase.auth().sendPasswordResetEmail(perfil.email);
        
        alert(`Email de redefiniÃ§Ã£o de senha enviado para ${perfil.email}.\n\nNota: Para alterar a senha diretamente sem email, Ã© necessÃ¡rio usar o Admin SDK no backend.`);
        fecharModalAlterarSenha();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao processar alteraÃ§Ã£o de senha: ' + error.message);
      }
    }

    async function enviarEmailRecuperacao() {
      try {
        const perfil = await obterPerfilUsuario(usuarioIdSenha);
        await firebase.auth().sendPasswordResetEmail(perfil.email);
        alert('Email de recuperaÃ§Ã£o enviado com sucesso!');
        fecharModalAlterarSenha();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao enviar email de recuperaÃ§Ã£o.');
      }
    }

    // Adicionar Cliente
    function abrirModalAdicionarCliente() {
      document.getElementById('modalAdicionarCliente').classList.remove('hidden');
      document.getElementById('formAdicionarCliente').reset();
    }

    function fecharModalAdicionarCliente() {
      document.getElementById('modalAdicionarCliente').classList.add('hidden');
      document.getElementById('formAdicionarCliente').reset();
    }

    // Aplicar mÃ¡scara de telefone no campo de novo cliente
    document.getElementById('novoClienteTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      } else if (value.length > 0) {
        value = `(${value}`;
      }
      
      e.target.value = value;
    });

    document.getElementById('formAdicionarCliente').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nome = document.getElementById('novoClienteNome').value;
      const email = document.getElementById('novoClienteEmail').value;
      const telefone = document.getElementById('novoClienteTelefone').value;
      const senha = document.getElementById('novoClienteSenha').value;
      
      try {
        console.log('ğŸ”§ Criando usuÃ¡rio no Authentication...');
        
        // Verificar se Firebase Database estÃ¡ disponÃ­vel
        if (!firebase.database) {
          throw new Error('Firebase Database nÃ£o estÃ¡ disponÃ­vel!');
        }
        
        // Salvar sessÃ£o atual do admin
        const currentUser = firebase.auth().currentUser;
        if (!currentUser) {
          alert('âŒ VocÃª precisa estar logado como admin para criar usuÃ¡rios.');
          return;
        }
        
        console.log('ğŸ‘¤ Admin atual:', currentUser.email);
        
        // Criar usuÃ¡rio no Firebase Authentication
        console.log('ğŸ“§ Criando usuÃ¡rio:', email);
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, senha);
        const user = userCredential.user;
        
        console.log('âœ… UsuÃ¡rio criado no Authentication');
        console.log('ğŸ†” UID:', user.uid);
        console.log('ğŸ“§ Email:', user.email);
        
        // Atualizar displayName
        await user.updateProfile({ displayName: nome });
        console.log('âœ… DisplayName atualizado para:', nome);
        
        // Criar perfil no Realtime Database
        const perfil = {
          nome: nome,
          nomeCompleto: nome,
          email: email,
          telefone: telefone,
          whatsapp: telefone,
          role: 'cliente',
          totalVisitas: 0,
          ultimaVisita: null,
          criadoEm: new Date().toISOString(),
          atualizadoEm: new Date().toISOString()
        };
        
        console.log('ğŸ“ Dados do perfil:', JSON.stringify(perfil, null, 2));
        console.log('ğŸ’¾ Salvando em: /usuarios/' + user.uid);
        
        const db = firebase.database();
        const dbRef = db.ref('usuarios/' + user.uid);
        
        await dbRef.set(perfil);
        console.log('âœ… Comando set() executado');
        
        // Aguardar um momento
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Verificar se foi salvo
        const snapshot = await dbRef.once('value');
        const dadosSalvos = snapshot.val();
        
        if (dadosSalvos) {
          console.log('âœ…âœ…âœ… VERIFICADO! Dados no Firebase:', JSON.stringify(dadosSalvos, null, 2));
        } else {
          console.error('âŒ ERRO! Dados nÃ£o foram encontrados no Firebase!');
        }
        
        // Fazer logout do novo usuÃ¡rio criado
        await firebase.auth().signOut();
        console.log('ğŸ”“ Logout do novo usuÃ¡rio realizado');
        
        alert(`âœ… Cliente "${nome}" criado com sucesso!\n\nğŸ“§ Email: ${email}\nğŸ”‘ UID: ${user.uid}\n\nâš ï¸ VocÃª serÃ¡ redirecionado para fazer login novamente como admin.`);
        
        fecharModalAdicionarCliente();
        
        // Redirecionar para login
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        
      } catch (error) {
        console.error('âŒ Erro ao criar cliente:', error);
        let mensagem = 'Erro ao criar cliente: ' + error.message;
        
        if (error.code === 'auth/email-already-in-use') {
          mensagem = 'âš ï¸ Este email jÃ¡ estÃ¡ em uso.';
        } else if (error.code === 'auth/invalid-email') {
          mensagem = 'âš ï¸ Email invÃ¡lido.';
        } else if (error.code === 'auth/weak-password') {
          mensagem = 'âš ï¸ Senha muito fraca. Use no mÃ­nimo 6 caracteres.';
        }
        
        alert(mensagem);
      }
    });

    // Editar Cliente
    async function editarCliente(userId) {
      try {
        const perfil = await obterPerfilUsuario(userId);
        const nome = prompt('Nome:', perfil.nome || '');
        if (nome === null) return;
        
        const telefone = prompt('Telefone/WhatsApp:', perfil.telefone || perfil.whatsapp || '');
        if (telefone === null) return;
        
        await atualizarPerfilUsuario(userId, {
          nome: nome,
          telefone: telefone,
          whatsapp: telefone,
          atualizadoEm: new Date().toISOString()
        });
        
        alert('Cliente atualizado com sucesso!');
        await carregarClientesAdmin();
      } catch (error) {
        console.error('Erro ao editar cliente:', error);
        alert('Erro ao editar cliente: ' + error.message);
      }
    }

    // Deletar Cliente
    async function deletarCliente(userId) {
      try {
        const perfil = await obterPerfilUsuario(userId);
        
        if (!confirm(`Deseja realmente excluir o cliente "${perfil.nome}"?\n\nâš ï¸ ATENÃ‡ÃƒO: Esta aÃ§Ã£o NÃƒO pode ser desfeita!\n\nSerÃ£o excluÃ­dos:\n- Dados do cliente\n- Todos os agendamentos\n- Todas as mensagens de chat\n\nO usuÃ¡rio ainda poderÃ¡ fazer login (Authentication), mas nÃ£o terÃ¡ mais acesso ao sistema.`)) {
          return;
        }
        
        // Deletar dados do Realtime Database
        await firebase.database().ref(`usuarios/${userId}`).remove();
        
        // Buscar e deletar agendamentos do usuÃ¡rio
        const agendamentos = await firebase.database().ref('agendamentos')
          .orderByChild('clienteId')
          .equalTo(userId)
          .once('value');
        
        const promises = [];
        agendamentos.forEach((child) => {
          promises.push(firebase.database().ref(`agendamentos/${child.key}`).remove());
          // Deletar chats associados
          promises.push(firebase.database().ref(`chats/${child.key}`).remove());
        });
        
        await Promise.all(promises);
        
        alert('Cliente excluÃ­do com sucesso!\n\nNota: O usuÃ¡rio ainda existe no Authentication. Para excluir completamente, Ã© necessÃ¡rio usar o Admin SDK no backend.');
        await carregarClientesAdmin();
      } catch (error) {
        console.error('Erro ao deletar cliente:', error);
        alert('Erro ao deletar cliente: ' + error.message);
      }
    }

    // Equipe Admin
    async function carregarEquipeAdmin() {
      const lista = document.getElementById('listaEquipeAdmin');
      try {
        const equipe = await listarEquipe();
        
        if (!equipe || Object.keys(equipe).length === 0) {
          lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Nenhum membro cadastrado</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(equipe).map(([id, m]) => `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <img src="${m.foto}" class="w-32 h-32 rounded-full mx-auto mb-3 object-cover">
            <h4 class="text-center font-bold text-lg text-gray-900 dark:text-white">${m.nome}</h4>
            <p class="text-center text-sm text-primary">${m.cargo}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${m.bio}</p>
            <div class="flex justify-between items-center mt-4">
              <span class="text-sm">â¤ï¸ ${m.curtidas || 0} curtidas</span>
              <div class="flex gap-2">
                <button onclick="editarMembro('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                  âœï¸
                </button>
                <button onclick="deletarMembro('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar equipe:', error);
        lista.innerHTML = '<div class="col-span-3 text-center py-8 text-red-600">Erro ao carregar equipe</div>';
      }
    }

    function abrirModalAdicionarMembro() {
      document.getElementById('modalAdicionarMembro').classList.remove('hidden');
    }

    function fecharModalAdicionarMembro() {
      document.getElementById('modalAdicionarMembro').classList.add('hidden');
      document.getElementById('formAdicionarMembro').reset();
    }

    document.getElementById('formAdicionarMembro').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const editId = form.dataset.editId;
      
      const dados = {
        nome: document.getElementById('nomeMembro').value,
        cargo: document.getElementById('cargoMembro').value,
        bio: document.getElementById('bioMembro').value,
        foto: document.getElementById('fotoMembro').value
      };
      
      try {
        if (editId) {
          // Atualizar membro existente
          await atualizarMembroEquipe(editId, dados);
          alert('Membro atualizado com sucesso!');
          delete form.dataset.editId;
        } else {
          // Adicionar novo membro
          await adicionarMembroEquipe(dados);
          alert('Membro adicionado com sucesso!');
        }
        fecharModalAdicionarMembro();
        await carregarEquipeAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar membro.');
      }
    });

    async function editarMembro(id) {
      try {
        const equipe = await listarEquipe();
        const membro = equipe[id];
        if (!membro) return;
        
        // Preencher o formulÃ¡rio com os dados do membro
        document.getElementById('nomeMembro').value = membro.nome || '';
        document.getElementById('cargoMembro').value = membro.cargo || '';
        document.getElementById('bioMembro').value = membro.bio || '';
        document.getElementById('fotoMembro').value = membro.foto || '';
        
        // Abrir modal
        document.getElementById('modalAdicionarMembro').classList.remove('hidden');
        
        // Alterar comportamento do submit para atualizar ao invÃ©s de adicionar
        const form = document.getElementById('formAdicionarMembro');
        form.dataset.editId = id;
      } catch (error) {
        console.error('Erro ao editar membro:', error);
        alert('Erro ao carregar dados do membro.');
      }
    }

    async function deletarMembro(id) {
      if (!confirm('Deseja realmente deletar este membro?')) return;
      try {
        await deletarMembroEquipe(id);
        alert('Membro deletado!');
        await carregarEquipeAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar membro.');
      }
    }

    // Gerenciar ServiÃ§os
    async function carregarServicosAdmin() {
      const lista = document.getElementById('listaServicosAdmin');
      if (!lista) {
        console.warn('Elemento listaServicosAdmin nÃ£o encontrado');
        return;
      }
      
      try {
        lista.innerHTML = '<div class="col-span-3 text-center py-8">Carregando serviÃ§os...</div>';
        
        const snapshot = await firebase.database().ref('servicos').once('value');
        const servicosData = snapshot.val();
        
        if (!servicosData || Object.keys(servicosData).length === 0) {
          lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Nenhum serviÃ§o cadastrado</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(servicosData).map(([id, s]) => `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <div class="flex items-start gap-3">
              <span class="text-3xl">${s.icone || 'âœ‚ï¸'}</span>
              <div class="flex-1">
                <h4 class="font-bold text-lg text-gray-900 dark:text-white">${s.nome}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${s.descricao || ''}</p>
                <div class="flex gap-4 mt-2 text-sm">
                  <span class="text-primary font-bold">${formatarPreco(s.preco)}</span>
                  <span class="text-gray-600 dark:text-gray-400">${s.duracao} min</span>
                  <span class="px-2 py-1 rounded text-xs ${s.ativo !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${s.ativo !== false ? 'Ativo' : 'Inativo'}
                  </span>
                </div>
              </div>
            </div>
            <div class="flex gap-2 mt-3">
              <button onclick="editarServico('${id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                âœï¸ Editar
              </button>
              <button onclick="toggleServicoAtivo('${id}', ${s.ativo !== false})" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">
                ${s.ativo !== false ? 'â¸ï¸ Desativar' : 'â–¶ï¸ Ativar'}
              </button>
              <button onclick="deletarServico('${id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                ğŸ—‘ï¸ Deletar
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar serviÃ§os:', error);
        lista.innerHTML = '<div class="col-span-3 text-center py-8 text-red-600">Erro ao carregar serviÃ§os</div>';
      }
    }

    // ============================================
    // CRUD DE SERVIÃ‡OS
    // ============================================
    
    let servicoEditandoId = null;
    
    function abrirModalServico() {
      servicoEditandoId = null;
      document.getElementById('tituloModalServico').textContent = 'â• Adicionar ServiÃ§o';
      document.getElementById('formServico').reset();
      document.getElementById('modalServico').classList.remove('hidden');
    }
    
    function fecharModalServico() {
      servicoEditandoId = null;
      document.getElementById('formServico').reset();
      document.getElementById('modalServico').classList.add('hidden');
    }
    
    async function editarServico(id) {
      try {
        const snapshot = await firebase.database().ref(`servicos/${id}`).once('value');
        const servico = snapshot.val();
        
        if (!servico) {
          alert('ServiÃ§o nÃ£o encontrado!');
          return;
        }
        
        servicoEditandoId = id;
        document.getElementById('tituloModalServico').textContent = 'âœï¸ Editar ServiÃ§o';
        document.getElementById('nomeServico').value = servico.nome || '';
        document.getElementById('descricaoServico').value = servico.descricao || '';
        document.getElementById('precoServico').value = servico.preco || '';
        document.getElementById('duracaoServico').value = servico.duracao || '';
        document.getElementById('iconeServico').value = servico.icone || '';
        document.getElementById('categoriaServico').value = servico.categoria || '';
        
        document.getElementById('modalServico').classList.remove('hidden');
      } catch (error) {
        console.error('Erro ao carregar serviÃ§o:', error);
        alert('Erro ao carregar dados do serviÃ§o.');
      }
    }
    
    document.getElementById('formServico').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const dados = {
        nome: document.getElementById('nomeServico').value.trim(),
        descricao: document.getElementById('descricaoServico').value.trim(),
        preco: parseFloat(document.getElementById('precoServico').value),
        duracao: parseInt(document.getElementById('duracaoServico').value),
        icone: document.getElementById('iconeServico').value.trim() || 'âœ‚ï¸',
        categoria: document.getElementById('categoriaServico').value.trim(),
        ativo: true,
        atualizadoEm: new Date().toISOString()
      };
      
      try {
        if (servicoEditandoId) {
          // Atualizar serviÃ§o existente
          await firebase.database().ref(`servicos/${servicoEditandoId}`).update(dados);
          alert('ServiÃ§o atualizado com sucesso!');
        } else {
          // Criar novo serviÃ§o
          dados.criadoEm = new Date().toISOString();
          const novoId = dados.nome.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
          await firebase.database().ref(`servicos/${novoId}`).set(dados);
          alert('ServiÃ§o criado com sucesso!');
        }
        
        fecharModalServico();
        await carregarServicosAdmin();
      } catch (error) {
        console.error('Erro ao salvar serviÃ§o:', error);
        alert('Erro ao salvar serviÃ§o. Tente novamente.');
      }
    });

    async function toggleServicoAtivo(id, ativoAtual) {
      try {
        await firebase.database().ref(`servicos/${id}`).update({
          ativo: !ativoAtual,
          atualizadoEm: new Date().toISOString()
        });
        await carregarServicosAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar serviÃ§o.');
      }
    }

    async function deletarServico(id) {
      if (!confirm('Deseja realmente deletar este serviÃ§o?')) return;
      try {
        await firebase.database().ref(`servicos/${id}`).remove();
        alert('ServiÃ§o deletado!');
        await carregarServicosAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar serviÃ§o.');
      }
    }

    // Gerenciar Produtos (Ponto de Vendas)
    async function carregarProdutosAdmin() {
      const lista = document.getElementById('listaProdutosAdmin');
      if (!lista) {
        console.warn('Elemento listaProdutosAdmin nÃ£o encontrado');
        return;
      }
      
      try {
        lista.innerHTML = '<div class="col-span-3 text-center py-8">Carregando produtos...</div>';
        
        const snapshot = await firebase.database().ref('produtos').once('value');
        const produtosData = snapshot.val();
        
        if (!produtosData || Object.keys(produtosData).length === 0) {
          lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Nenhum produto cadastrado</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(produtosData).map(([id, p]) => `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <div class="flex items-start gap-3">
              <span class="text-3xl">${p.icone || 'ğŸ›ï¸'}</span>
              <div class="flex-1">
                <h4 class="font-bold text-lg text-gray-900 dark:text-white">${p.nome}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${p.descricao || ''}</p>
                <div class="flex gap-4 mt-2 text-sm">
                  <span class="text-primary font-bold">${formatarPreco(p.preco)}</span>
                  ${p.estoque !== undefined ? `<span class="text-gray-600 dark:text-gray-400">Estoque: ${p.estoque}</span>` : ''}
                  <span class="px-2 py-1 rounded text-xs ${p.ativo !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${p.ativo !== false ? 'Ativo' : 'Inativo'}
                  </span>
                </div>
              </div>
            </div>
            <div class="flex gap-2 mt-3">
              <button onclick="editarProduto('${id}')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                âœï¸ Editar
              </button>
              <button onclick="toggleProdutoAtivo('${id}', ${p.ativo !== false})" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-sm">
                ${p.ativo !== false ? 'â¸ï¸ Desativar' : 'â–¶ï¸ Ativar'}
              </button>
              <button onclick="deletarProduto('${id}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                ğŸ—‘ï¸ Deletar
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        lista.innerHTML = '<div class="col-span-3 text-center py-8 text-red-600">Erro ao carregar produtos</div>';
      }
    }

    // ============================================
    // CRUD DE PRODUTOS
    // ============================================
    
    let produtoEditandoId = null;
    
    function abrirModalProduto() {
      produtoEditandoId = null;
      document.getElementById('tituloModalProduto').textContent = 'â• Adicionar Produto';
      document.getElementById('formProduto').reset();
      document.getElementById('modalProduto').classList.remove('hidden');
    }
    
    function fecharModalProduto() {
      produtoEditandoId = null;
      document.getElementById('formProduto').reset();
      document.getElementById('modalProduto').classList.add('hidden');
    }
    
    async function editarProduto(id) {
      try {
        const snapshot = await firebase.database().ref(`produtos/${id}`).once('value');
        const produto = snapshot.val();
        
        if (!produto) {
          alert('Produto nÃ£o encontrado!');
          return;
        }
        
        produtoEditandoId = id;
        document.getElementById('tituloModalProduto').textContent = 'âœï¸ Editar Produto';
        document.getElementById('nomeProduto').value = produto.nome || '';
        document.getElementById('descricaoProduto').value = produto.descricao || '';
        document.getElementById('precoProduto').value = produto.preco || '';
        document.getElementById('estoqueProduto').value = produto.estoque || '';
        document.getElementById('iconeProduto').value = produto.icone || '';
        document.getElementById('categoriaProduto').value = produto.categoria || '';
        
        document.getElementById('modalProduto').classList.remove('hidden');
      } catch (error) {
        console.error('Erro ao carregar produto:', error);
        alert('Erro ao carregar dados do produto.');
      }
    }
    
    document.getElementById('formProduto').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const dados = {
        nome: document.getElementById('nomeProduto').value.trim(),
        descricao: document.getElementById('descricaoProduto').value.trim(),
        preco: parseFloat(document.getElementById('precoProduto').value),
        estoque: parseInt(document.getElementById('estoqueProduto').value),
        icone: document.getElementById('iconeProduto').value.trim() || 'ğŸ›ï¸',
        categoria: document.getElementById('categoriaProduto').value.trim(),
        ativo: true,
        atualizadoEm: new Date().toISOString()
      };
      
      try {
        if (produtoEditandoId) {
          // Atualizar produto existente
          await firebase.database().ref(`produtos/${produtoEditandoId}`).update(dados);
          alert('Produto atualizado com sucesso!');
        } else {
          // Criar novo produto
          dados.criadoEm = new Date().toISOString();
          const novoId = dados.nome.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
          await firebase.database().ref(`produtos/${novoId}`).set(dados);
          alert('Produto criado com sucesso!');
        }
        
        fecharModalProduto();
        await carregarProdutosAdmin();
      } catch (error) {
        console.error('Erro ao salvar produto:', error);
        alert('Erro ao salvar produto. Tente novamente.');
      }
    });

    async function toggleProdutoAtivo(id, ativoAtual) {
      try {
        await firebase.database().ref(`produtos/${id}`).update({
          ativo: !ativoAtual,
          atualizadoEm: new Date().toISOString()
        });
        await carregarProdutosAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao atualizar produto.');
      }
    }

    async function deletarProduto(id) {
      if (!confirm('Deseja realmente deletar este produto?')) return;
      try {
        await firebase.database().ref(`produtos/${id}`).remove();
        alert('Produto deletado!');
        await carregarProdutosAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar produto.');
      }
    }

    // Faturamento
    async function carregarFaturamento() {
      const tabelaExtrato = document.getElementById('tabelaExtrato');
      if (!tabelaExtrato) {
        console.warn('Elemento tabelaExtrato nÃ£o encontrado');
        return;
      }
      
      try {
        tabelaExtrato.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Carregando...</td></tr>';
        
        // Processar despesas recorrentes antes de carregar
        await processarDespesasRecorrentes();
        
        // Gerar faturamento automaticamente a partir dos agendamentos concluÃ­dos
        await gerarFaturamentoAutomatico();
        
        const snapshot = await firebase.database().ref('faturamento/extrato').once('value');
        const extrato = snapshot.val();
        
        if (!extrato || Object.keys(extrato).length === 0) {
          tabelaExtrato.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Nenhum registro</td></tr>';
          return;
        }
        
        // Ordenar por data (mais recente primeiro)
        const extratoArray = Object.entries(extrato).sort(([, a], [, b]) => {
          return new Date(b.data) - new Date(a.data);
        });
        
        let html = '';
        extratoArray.forEach(([id, e]) => {
          const data = new Date(e.data).toLocaleDateString('pt-BR');
          const tipo = e.tipo === 'receita' ? '+ Receita' : '- Despesa';
          const corBadge = e.tipo === 'receita' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
          const corValor = e.tipo === 'receita' ? 'text-green-600' : 'text-red-600';
          
          html += `
            <tr>
              <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${data}</td>
              <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">${e.descricao}</td>
              <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 rounded-full text-xs font-semibold ${corBadge}">
                  ${tipo}
                </span>
              </td>
              <td class="px-4 py-3 text-sm text-right font-bold ${corValor}">${formatarPreco(e.valor)}</td>
            </tr>
          `;
        });
        
        tabelaExtrato.innerHTML = html;
        
        // Atualizar totais
        const valores = Object.values(extrato);
        const receitas = valores.filter(e => e.tipo === 'receita').reduce((sum, e) => sum + e.valor, 0);
        const despesas = valores.filter(e => e.tipo === 'despesa').reduce((sum, e) => sum + e.valor, 0);
        const lucro = receitas - despesas;
        
        const totalReceitas = document.getElementById('totalReceitas');
        const totalDespesas = document.getElementById('totalDespesas');
        const lucroTotal = document.getElementById('lucroTotal');
        
        if (totalReceitas) totalReceitas.textContent = formatarPreco(receitas);
        if (totalDespesas) totalDespesas.textContent = formatarPreco(despesas);
        if (lucroTotal) lucroTotal.textContent = formatarPreco(lucro);
      } catch (error) {
        console.error('Erro ao carregar faturamento:', error);
        tabelaExtrato.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-600">Erro ao carregar dados</td></tr>';
      }
    }
    
    // Gerar faturamento automaticamente a partir de agendamentos concluÃ­dos
    async function gerarFaturamentoAutomatico() {
      try {
        const snapshot = await firebase.database().ref('agendamentos').once('value');
        const agendamentos = snapshot.val() || {};
        
        // Filtrar apenas concluÃ­dos
        const concluidos = Object.entries(agendamentos).filter(([, a]) => a.status === 'concluido');
        
        for (const [id, agendamento] of concluidos) {
          // Verificar se jÃ¡ existe entrada no faturamento para este agendamento
          const extratoRef = firebase.database().ref(`faturamento/extrato/${id}`);
          const extratoSnapshot = await extratoRef.once('value');
          
          if (!extratoSnapshot.exists()) {
            // Calcular valor final considerando desconto
            const precoOriginal = agendamento.precoOriginal || agendamento.precoTotal || 0;
            const desconto = agendamento.desconto || 0;
            const valorFinal = Math.max(0, precoOriginal - desconto);
            
            // Criar entrada de receita no faturamento
            const entrada = {
              tipo: 'receita',
              descricao: `Agendamento - ${agendamento.clienteNome || 'Cliente'}`,
              valor: valorFinal,
              data: agendamento.dataHora || new Date().toISOString(),
              clienteId: agendamento.clienteId || '',
              agendamentoId: id,
              criadoEm: new Date().toISOString()
            };
            
            await extratoRef.set(entrada);
            console.log(`Faturamento gerado para agendamento ${id}`);
          }
        }
      } catch (error) {
        console.error('Erro ao gerar faturamento automÃ¡tico:', error);
      }
    }
    
    // ============================================
    // DESPESAS MANUAIS E RECORRENTES
    // ============================================
    
    // Modal Nova Despesa
    function abrirModalNovaDespesa() {
      document.getElementById('dataDespesa').valueAsDate = new Date();
      document.getElementById('modalNovaDespesa').classList.remove('hidden');
    }
    
    function fecharModalNovaDespesa() {
      document.getElementById('modalNovaDespesa').classList.add('hidden');
      document.getElementById('formNovaDespesa').reset();
    }
    
    document.getElementById('formNovaDespesa').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const descricao = document.getElementById('descricaoDespesa').value.trim();
      const valor = parseFloat(document.getElementById('valorDespesa').value);
      const data = document.getElementById('dataDespesa').value;
      
      try {
        const despesa = {
          tipo: 'despesa',
          descricao: descricao,
          valor: valor,
          data: new Date(data + 'T12:00:00').toISOString(),
          criadoEm: new Date().toISOString(),
          manual: true
        };
        
        const novaRef = firebase.database().ref('faturamento/extrato').push();
        await novaRef.set(despesa);
        
        alert('Despesa adicionada com sucesso!');
        fecharModalNovaDespesa();
        await carregarFaturamento();
      } catch (error) {
        console.error('Erro ao adicionar despesa:', error);
        alert('Erro ao adicionar despesa. Tente novamente.');
      }
    });
    
    // Modal Despesas Recorrentes
    function abrirModalDespesasRecorrentes() {
      document.getElementById('modalDespesasRecorrentes').classList.remove('hidden');
      carregarDespesasRecorrentes();
    }
    
    function fecharModalDespesasRecorrentes() {
      document.getElementById('modalDespesasRecorrentes').classList.add('hidden');
      document.getElementById('formDespesaRecorrente').reset();
    }
    
    async function carregarDespesasRecorrentes() {
      const lista = document.getElementById('listaDespesasRecorrentes');
      lista.innerHTML = '<div class="text-center py-4 text-gray-500">Carregando...</div>';
      
      try {
        const snapshot = await firebase.database().ref('faturamento/despesasRecorrentes').once('value');
        const despesas = snapshot.val() || {};
        
        if (Object.keys(despesas).length === 0) {
          lista.innerHTML = '<div class="text-center py-4 text-gray-500">Nenhuma despesa recorrente cadastrada</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(despesas).map(([id, d]) => `
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg border ${d.status === 'ativo' ? 'border-green-300' : 'border-gray-300'}">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <h5 class="font-bold text-gray-900 dark:text-white">${d.descricao}</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ğŸ’° Valor: ${formatarPreco(d.valor)}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">ğŸ“… Dia de cobranÃ§a: Todo dia ${d.diaCobranca}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">ğŸ“Š Ãšltima cobranÃ§a: ${d.ultimaCobranca ? new Date(d.ultimaCobranca).toLocaleDateString('pt-BR') : 'Nunca'}</p>
                <span class="inline-block mt-2 px-2 py-1 rounded text-xs font-semibold ${d.status === 'ativo' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                  ${d.status === 'ativo' ? 'âœ… Ativo' : 'â¸ï¸ Inativo'}
                </span>
              </div>
              <div class="flex flex-col gap-2 ml-4">
                <button onclick="toggleDespesaRecorrente('${id}', '${d.status}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
                  ${d.status === 'ativo' ? 'â¸ï¸ Desativar' : 'â–¶ï¸ Ativar'}
                </button>
                <button onclick="deletarDespesaRecorrente('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                  ğŸ—‘ï¸ Excluir
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar despesas recorrentes:', error);
        lista.innerHTML = '<div class="text-center py-4 text-red-600">Erro ao carregar despesas</div>';
      }
    }
    
    document.getElementById('formDespesaRecorrente').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const descricao = document.getElementById('descricaoRecorrente').value.trim();
      const valor = parseFloat(document.getElementById('valorRecorrente').value);
      const dia = parseInt(document.getElementById('diaRecorrente').value);
      const status = document.getElementById('statusRecorrente').value;
      
      if (dia < 1 || dia > 31) {
        alert('O dia de cobranÃ§a deve estar entre 1 e 31.');
        return;
      }
      
      try {
        const despesa = {
          descricao: descricao,
          valor: valor,
          diaCobranca: dia,
          status: status,
          criadoEm: new Date().toISOString(),
          ultimaCobranca: null
        };
        
        await firebase.database().ref('faturamento/despesasRecorrentes').push(despesa);
        
        alert('Despesa recorrente adicionada com sucesso!');
        document.getElementById('formDespesaRecorrente').reset();
        await carregarDespesasRecorrentes();
      } catch (error) {
        console.error('Erro ao adicionar despesa recorrente:', error);
        alert('Erro ao adicionar despesa recorrente. Tente novamente.');
      }
    });
    
    async function toggleDespesaRecorrente(id, statusAtual) {
      try {
        const novoStatus = statusAtual === 'ativo' ? 'inativo' : 'ativo';
        await firebase.database().ref(`faturamento/despesasRecorrentes/${id}`).update({
          status: novoStatus,
          atualizadoEm: new Date().toISOString()
        });
        await carregarDespesasRecorrentes();
      } catch (error) {
        console.error('Erro ao atualizar status:', error);
        alert('Erro ao atualizar status da despesa.');
      }
    }
    
    async function deletarDespesaRecorrente(id) {
      if (!confirm('Deseja realmente excluir esta despesa recorrente?')) return;
      
      try {
        await firebase.database().ref(`faturamento/despesasRecorrentes/${id}`).remove();
        alert('Despesa recorrente excluÃ­da com sucesso!');
        await carregarDespesasRecorrentes();
      } catch (error) {
        console.error('Erro ao excluir despesa:', error);
        alert('Erro ao excluir despesa recorrente.');
      }
    }
    
    // Processar despesas recorrentes do mÃªs atual
    async function processarDespesasRecorrentes() {
      try {
        const snapshot = await firebase.database().ref('faturamento/despesasRecorrentes').once('value');
        const despesas = snapshot.val() || {};
        
        const hoje = new Date();
        const diaAtual = hoje.getDate();
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();
        
        for (const [id, despesa] of Object.entries(despesas)) {
          if (despesa.status !== 'ativo') continue;
          
          // Verificar se jÃ¡ foi cobrada este mÃªs
          const ultimaCobranca = despesa.ultimaCobranca ? new Date(despesa.ultimaCobranca) : null;
          if (ultimaCobranca && ultimaCobranca.getMonth() === mesAtual && ultimaCobranca.getFullYear() === anoAtual) {
            continue; // JÃ¡ cobrada este mÃªs
          }
          
          // Verificar se chegou o dia de cobranÃ§a
          if (diaAtual >= despesa.diaCobranca) {
            // Adicionar despesa no extrato
            const dataCobranca = new Date(anoAtual, mesAtual, despesa.diaCobranca);
            const entrada = {
              tipo: 'despesa',
              descricao: `${despesa.descricao} (Recorrente)`,
              valor: despesa.valor,
              data: dataCobranca.toISOString(),
              recorrente: true,
              despesaRecorrenteId: id,
              criadoEm: new Date().toISOString()
            };
            
            await firebase.database().ref('faturamento/extrato').push(entrada);
            
            // Atualizar Ãºltima cobranÃ§a
            await firebase.database().ref(`faturamento/despesasRecorrentes/${id}`).update({
              ultimaCobranca: dataCobranca.toISOString()
            });
            
            console.log(`Despesa recorrente processada: ${despesa.descricao}`);
          }
        }
      } catch (error) {
        console.error('Erro ao processar despesas recorrentes:', error);
      }
    }

    // Novo Agendamento Admin
    let servicosSelecionadosNovo = [];
    let produtosSelecionadosNovo = [];
    
    function abrirModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.remove('hidden');
      carregarClientesSelect();
      carregarProfissionaisSelect();
      carregarServicosNovo();
      carregarProdutosNovo();
    }

    function fecharModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.add('hidden');
      document.getElementById('formNovoAgendamentoAdmin').reset();
      servicosSelecionadosNovo = [];
      produtosSelecionadosNovo = [];
    }

    async function carregarClientesSelect() {
      const select = document.getElementById('clienteNovoAgendamento');
      try {
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        select.innerHTML = '<option value="">Selecione o cliente</option>' + 
          Object.entries(usuarios)
            .filter(([id, u]) => u.role === 'cliente')
            .map(([id, u]) => `<option value="${id}">${u.nome || u.nomeCompleto} (${u.email})</option>`)
            .join('');
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
      }
    }
    
    async function carregarProfissionaisSelect() {
      const select = document.getElementById('profissionalNovoAgendamento');
      try {
        const snapshot = await firebase.database().ref('equipe').once('value');
        const equipe = snapshot.val() || {};
        
        select.innerHTML = '<option value="">Selecione o profissional</option>' + 
          Object.entries(equipe)
            .map(([id, p]) => `<option value="${id}">${p.nome} - ${p.cargo || 'Profissional'}</option>`)
            .join('');
      } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
      }
    }

    async function carregarServicosNovo() {
      const grid = document.getElementById('gridServicosNovoAgendamento');
      grid.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-600 dark:text-gray-400">Carregando serviÃ§os...</div>';
      
      try {
        // Buscar todos os serviÃ§os e filtrar localmente
        const snapshot = await firebase.database().ref('servicos').once('value');
        const servicosData = snapshot.val();
        const servicos = [];
        
        if (servicosData) {
          Object.entries(servicosData).forEach(([id, data]) => {
            // Filtrar apenas serviÃ§os ativos (ou sem campo ativo definido)
            if (data.ativo !== false) {
              servicos.push({
                id,
                nome: data.nome,
                descricao: data.descricao,
                preco: data.preco,
                duracao: data.duracao,
                icone: data.icone || 'âœ‚ï¸',
                ativo: data.ativo !== false
              });
            }
          });
        }
        
        console.log('ServiÃ§os carregados:', servicos.length);
        
        if (servicos.length === 0) {
          grid.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-600 dark:text-gray-400">Nenhum serviÃ§o disponÃ­vel</div>';
          return;
        }
        
        grid.innerHTML = servicos.map(s => `
          <div onclick="toggleServicoNovo('${s.id}')" id="servico-novo-${s.id}" 
               class="cursor-pointer p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition">
            <div class="flex items-center gap-2 mb-1">
              <input type="checkbox" id="check-novo-${s.id}" class="pointer-events-none">
              <span class="text-lg">${s.icone}</span>
            </div>
            <p class="text-sm font-semibold text-gray-900 dark:text-white">${s.nome}</p>
            <p class="text-xs text-primary">${formatarPreco(s.preco)}</p>
            <p class="text-xs text-gray-500">${s.duracao} min</p>
          </div>
        `).join('');
        
        // Armazenar serviÃ§os globalmente para toggleServicoNovo
        window.SERVICOS_ADMIN = servicos;
      } catch (error) {
        console.error('Erro ao carregar serviÃ§os:', error);
        grid.innerHTML = '<div class="col-span-2 text-center py-4 text-red-600">Erro ao carregar serviÃ§os</div>';
      }
    }

    function toggleServicoNovo(id) {
      const servico = window.SERVICOS_ADMIN.find(s => s.id === id);
      if (!servico) return;
      
      const index = servicosSelecionadosNovo.findIndex(s => s.id === id);
      const card = document.getElementById(`servico-novo-${id}`);
      const check = document.getElementById(`check-novo-${id}`);
      
      if (index > -1) {
        servicosSelecionadosNovo.splice(index, 1);
        card.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = false;
      } else {
        servicosSelecionadosNovo.push(servico);
        card.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = true;
      }
      
      atualizarResumoNovo();
    }

    async function carregarProdutosNovo() {
      const grid = document.getElementById('gridProdutosNovoAgendamento');
      grid.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-600 dark:text-gray-400">Carregando produtos...</div>';
      
      try {
        // Buscar todos os produtos e filtrar localmente
        const snapshot = await firebase.database().ref('produtos').once('value');
        const produtosData = snapshot.val();
        const produtos = [];
        
        if (produtosData) {
          Object.entries(produtosData).forEach(([id, data]) => {
            // Filtrar apenas produtos ativos (ou sem campo ativo definido)
            if (data.ativo !== false) {
              produtos.push({
                id,
                nome: data.nome,
                descricao: data.descricao,
                preco: data.preco,
                estoque: data.estoque,
                icone: data.icone || 'ğŸ›ï¸',
                ativo: data.ativo !== false
              });
            }
          });
        }
        
        console.log('Produtos carregados:', produtos.length);
        
        if (produtos.length === 0) {
          grid.innerHTML = '<div class="col-span-2 text-center py-4 text-gray-600 dark:text-gray-400">Nenhum produto disponÃ­vel</div>';
          return;
        }
        
        grid.innerHTML = produtos.map(p => `
          <div onclick="toggleProdutoNovo('${p.id}')" id="produto-novo-${p.id}" 
               class="cursor-pointer p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition">
            <div class="flex items-center gap-2 mb-1">
              <input type="checkbox" id="check-produto-novo-${p.id}" class="pointer-events-none">
              <span class="text-lg">${p.icone}</span>
            </div>
            <p class="text-sm font-semibold text-gray-900 dark:text-white">${p.nome}</p>
            <p class="text-xs text-primary">${formatarPreco(p.preco)}</p>
            ${p.estoque ? `<p class="text-xs text-gray-500">Estoque: ${p.estoque}</p>` : ''}
          </div>
        `).join('');
        
        // Armazenar produtos globalmente
        window.PRODUTOS_ADMIN = produtos;
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        grid.innerHTML = '<div class="col-span-2 text-center py-4 text-red-600">Erro ao carregar produtos</div>';
      }
    }

    function toggleProdutoNovo(id) {
      const produto = window.PRODUTOS_ADMIN.find(p => p.id === id);
      if (!produto) return;
      
      const index = produtosSelecionadosNovo.findIndex(p => p.id === id);
      const card = document.getElementById(`produto-novo-${id}`);
      const check = document.getElementById(`check-produto-novo-${id}`);
      
      if (index > -1) {
        produtosSelecionadosNovo.splice(index, 1);
        card.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = false;
      } else {
        produtosSelecionadosNovo.push(produto);
        card.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = true;
      }
    }

    function atualizarResumoNovo() {
      const resumo = document.getElementById('resumoServicosNovoAgendamento');
      if (servicosSelecionadosNovo.length === 0) {
        resumo.classList.add('hidden');
        document.getElementById('containerHorarioNovo').classList.add('hidden');
        return;
      }
      
      const totalPreco = servicosSelecionadosNovo.reduce((sum, s) => sum + s.preco, 0);
      const totalDuracao = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
      
      resumo.classList.remove('hidden');
      resumo.innerHTML = `
        <p class="font-semibold mb-2">ServiÃ§os Selecionados:</p>
        ${servicosSelecionadosNovo.map(s => `<p class="text-sm">${s.nome} - ${formatarPreco(s.preco)}</p>`).join('')}
        <div class="mt-2 pt-2 border-t border-blue-300 dark:border-blue-700">
          <div class="flex justify-between font-bold">
            <span>Total:</span>
            <span>${formatarPreco(totalPreco)} (${totalDuracao} min)</span>
          </div>
        </div>
      `;
    }

    document.getElementById('dataNovoAgendamento').addEventListener('change', async (e) => {
      const data = e.target.value;
      if (!data || servicosSelecionadosNovo.length === 0) return;
      
      const duracaoTotal = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
      const container = document.getElementById('containerHorarioNovo');
      const select = document.getElementById('horarioNovoAgendamento');
      
      container.classList.remove('hidden');
      select.innerHTML = '<option value="">Carregando...</option>';
      
      try {
        const horarios = await gerarHorariosDisponiveisCorrigidos(data, duracaoTotal);
        select.innerHTML = '<option value="">Selecione o horÃ¡rio</option>' +
          horarios.map(h => `<option value="${h}">${h}</option>`).join('');
      } catch (error) {
        select.innerHTML = '<option value="">Erro ao carregar horÃ¡rios</option>';
      }
    });

    document.getElementById('formNovoAgendamentoAdmin').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const clienteId = document.getElementById('clienteNovoAgendamento').value;
      const profissionalId = document.getElementById('profissionalNovoAgendamento').value;
      const data = document.getElementById('dataNovoAgendamento').value;
      const horario = document.getElementById('horarioNovoAgendamento').value;
      const obs = document.getElementById('observacoesNovoAgendamento').value;
      
      if (servicosSelecionadosNovo.length === 0) {
        alert('Selecione pelo menos um serviÃ§o!');
        return;
      }
      
      if (!profissionalId) {
        alert('Selecione um profissional!');
        return;
      }
      
      try {
        const perfil = await obterPerfilUsuario(clienteId);
        
        // Buscar dados do profissional
        const profissionalSnapshot = await firebase.database().ref(`equipe/${profissionalId}`).once('value');
        const profissional = profissionalSnapshot.val();
        
        const totalPreco = servicosSelecionadosNovo.reduce((sum, s) => sum + s.preco, 0) +
                          produtosSelecionadosNovo.reduce((sum, p) => sum + p.preco, 0);
        const totalDuracao = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
        
        const agendamento = {
          clienteId: clienteId,
          clienteNome: perfil.nome || perfil.nomeCompleto,
          clienteEmail: perfil.email,
          clienteTelefone: perfil.telefone || '',
          profissionalId: profissionalId,
          profissionalNome: profissional ? profissional.nome : 'NÃ£o especificado',
          servicos: servicosSelecionadosNovo.map(s => ({
            id: s.id,
            nome: s.nome,
            preco: s.preco,
            duracao: s.duracao
          })),
          dataHora: `${data}T${horario}`,
          duracaoTotal: totalDuracao,
          precoOriginal: totalPreco,  // Adicionar precoOriginal
          precoTotal: totalPreco,
          desconto: 0,  // Inicializar desconto
          observacoes: obs,
          status: 'pendente',
          agendadoPor: 'admin'
        };
        
        // Adicionar produtos se houver
        if (produtosSelecionadosNovo.length > 0) {
          agendamento.produtos = produtosSelecionadosNovo.map(p => ({
            id: p.id,
            nome: p.nome,
            preco: p.preco
          }));
        }
        
        await salvarAgendamento(agendamento);
        
        alert('Agendamento criado com sucesso!');
        fecharModalNovoAgendamento();
        await atualizarEstatisticas();
        await carregarCalendario();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao criar agendamento.');
      }
    });

    // Firebase - FunÃ§Ãµes Auxiliares de Agendamentos
    async function listarAgendamentosOnce() {
      const snapshot = await firebase.database().ref('agendamentos').once('value');
      return snapshot.val() || {};
    }

    async function obterAgendamento(id) {
      const snapshot = await firebase.database().ref(`agendamentos/${id}`).once('value');
      return snapshot.val();
    }

    async function salvarAgendamento(agendamento) {
      const novoId = firebase.database().ref('agendamentos').push().key;
      agendamento.criadoEm = agendamento.criadoEm || new Date().toISOString();
      agendamento.timestamp = agendamento.timestamp || Date.now();
      await firebase.database().ref(`agendamentos/${novoId}`).set(agendamento);
      return novoId;
    }

    async function atualizarAgendamento(id, dados) {
      dados.atualizadoEm = new Date().toISOString();
      await firebase.database().ref(`agendamentos/${id}`).update(dados);
    }

    async function alterarStatusAgendamento(id, novoStatus) {
      await firebase.database().ref(`agendamentos/${id}`).update({
        status: novoStatus,
        atualizadoEm: new Date().toISOString()
      });
    }

    async function obterPerfilUsuario(userId) {
      const snapshot = await firebase.database().ref(`usuarios/${userId}`).once('value');
      return snapshot.val();
    }

    async function listarEquipe() {
      const snapshot = await firebase.database().ref('equipe').once('value');
      return snapshot.val() || {};
    }

    // Helpers
    function formatarPreco(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    function getStatusColor(status) {
      const colors = {
        'pendente': 'border-yellow-500',
        'confirmado': 'border-green-500',
        'concluido': 'border-blue-500',
        'cancelado': 'border-red-500'
      };
      return colors[status] || 'border-gray-500';
    }

    function getStatusBadge(status) {
      const badges = {
        'pendente': 'bg-yellow-100 text-yellow-800',
        'confirmado': 'bg-green-100 text-green-800',
        'concluido': 'bg-blue-100 text-blue-800',
        'cancelado': 'bg-red-100 text-red-800'
      };
      return badges[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
      const texts = {
        'pendente': 'â³ Pendente',
        'confirmado': 'âœ… Confirmado',
        'concluido': 'ğŸ‰ ConcluÃ­do',
        'cancelado': 'âŒ Cancelado'
      };
      return texts[status] || status;
    }

  </script>
</body>
</html>
