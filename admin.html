<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <!-- NavegaÃ§Ã£o -->
  <nav class="nav-bar">
    <div class="nav-container">
      <a href="#" class="nav-logo">ğŸ› ï¸ Painel Admin</a>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span id="nomeAdmin" style="color: var(--text-secondary); font-size: 14px;"></span>
        <button class="btn btn-sm btn-ghost" onclick="logout()">Sair</button>
      </div>
    </div>
  </nav>

  <!-- Container Principal -->
  <div class="container container-wide" style="margin-top: 20px;">
    
    <!-- EstatÃ­sticas -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;" id="totalAgendamentos">0</div>
        <div>Total de Agendamentos</div>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;" id="totalPendentes">0</div>
        <div>Pendentes</div>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;" id="totalConfirmados">0</div>
        <div>Confirmados</div>
      </div>
      <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; text-align: center;">
        <div style="font-size: 36px; font-weight: bold;" id="totalConcluidos">0</div>
        <div>ConcluÃ­dos</div>
      </div>
    </div>

    <!-- Tabs de Filtro -->
    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color);">
      <button class="btn btn-ghost" id="tabCalendario" onclick="mostrarTab('calendario')" style="border-radius: 0; border-bottom: 3px solid var(--primary-color);">
        ğŸ“… CalendÃ¡rio
      </button>
      <button class="btn btn-ghost" id="tabPendentes" onclick="mostrarTab('pendentes')" style="border-radius: 0;">
        â³ Pendentes
      </button>
      <button class="btn btn-ghost" id="tabConfirmados" onclick="mostrarTab('confirmados')" style="border-radius: 0;">
        âœ… Confirmados
      </button>
      <button class="btn btn-ghost" id="tabConcluidos" onclick="mostrarTab('concluidos')" style="border-radius: 0;">
        ğŸ‰ ConcluÃ­dos
      </button>
    </div>

    <!-- SeÃ§Ã£o: CalendÃ¡rio -->
    <div id="secaoCalendario">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- CalendÃ¡rio -->
        <div class="card">
          <h3>ğŸ“… CalendÃ¡rio de Agendamentos</h3>
          <div id="calendario" class="mt-2">
            <div class="calendar-header">
              <button class="btn btn-sm btn-ghost" onclick="mesAnterior()">â†</button>
              <h4 id="mesAno" style="margin: 0;"></h4>
              <button class="btn btn-sm btn-ghost" onclick="proximoMes()">â†’</button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 16px; text-align: center; font-weight: 600; font-size: 12px;">
              <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div>
            </div>
            <div id="diasCalendario" class="calendar-grid mt-1"></div>
          </div>
        </div>

        <!-- Agendamentos do Dia Selecionado -->
        <div class="card">
          <h3 id="tituloAgendamentosDia">ğŸ“‹ Selecione uma data</h3>
          <div id="agendamentosDia" class="mt-2">
            <p style="color: var(--text-secondary); text-align: center;">Clique em uma data no calendÃ¡rio</p>
          </div>
        </div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: Pendentes -->
    <div id="secaoPendentes" class="hidden">
      <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>â³ Agendamentos Pendentes</h3>
        <button class="btn btn-sm btn-primary" onclick="carregarPendentes()">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaPendentes">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: Confirmados -->
    <div id="secaoConfirmados" class="hidden">
      <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>âœ… Agendamentos Confirmados</h3>
        <button class="btn btn-sm btn-primary" onclick="carregarConfirmados()">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaConfirmados">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: ConcluÃ­dos -->
    <div id="secaoConcluidos" class="hidden">
      <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h3>ğŸ‰ Agendamentos ConcluÃ­dos</h3>
        <button class="btn btn-sm btn-primary" onclick="carregarConcluidos()">
          ğŸ”„ Atualizar
        </button>
      </div>
      <div id="listaConcluidos">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="modalChat" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="width: 90%; max-width: 600px;">
      <div class="chat-container">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span id="chatTitulo">ğŸ’¬ Chat</span>
          <button onclick="fecharChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input form-input" id="chatInput" placeholder="Digite sua mensagem..." style="margin: 0;">
          <button class="btn btn-primary" onclick="enviarMensagemChat()">ğŸ“¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmar Agendamento -->
  <div id="modalConfirmar" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 400px;">
      <h3>âœ… Confirmar Agendamento</h3>
      <form id="formConfirmar">
        <div class="form-group">
          <label class="form-label">PreÃ§o Final (R$)</label>
          <input class="form-input" type="number" id="precoFinal" step="0.01" min="0" required>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="btn btn-success" style="flex: 1;">
            âœ… Confirmar
          </button>
          <button type="button" class="btn btn-ghost" onclick="fecharModalConfirmar()" style="flex: 1;">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let usuarioAtual = null;
    let agendamentoAtualChat = null;
    let agendamentoParaConfirmar = null;
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();
    let dataSelecionada = null;
    let todosAgendamentos = [];

    // Inicializar
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      usuarioAtual = user;
      
      // Verificar se Ã© admin
      const isAdminUser = await isAdmin(user.uid);
      if (!isAdminUser) {
        alert('âŒ Acesso negado! Esta Ã¡rea Ã© exclusiva para administradores.');
        window.location.href = 'cliente.html';
        return;
      }

      const perfil = await obterPerfilUsuario(user.uid);
      document.getElementById('nomeAdmin').textContent = perfil?.nome || user.email;

      carregarTodosAgendamentos();
      renderizarCalendario();
    });

    // Carregar todos os agendamentos
    async function carregarTodosAgendamentos() {
      try {
        const agendamentos = await listarAgendamentosOnce();
        todosAgendamentos = Object.entries(agendamentos || {}).map(([id, ag]) => ({ id, ...ag }));
        atualizarEstatisticas();
        renderizarCalendario();
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
      }
    }

    // Atualizar estatÃ­sticas
    function atualizarEstatisticas() {
      const total = todosAgendamentos.length;
      const pendentes = todosAgendamentos.filter(ag => ag.status === 'pendente').length;
      const confirmados = todosAgendamentos.filter(ag => ag.status === 'confirmado').length;
      const concluidos = todosAgendamentos.filter(ag => ag.status === 'concluido').length;

      document.getElementById('totalAgendamentos').textContent = total;
      document.getElementById('totalPendentes').textContent = pendentes;
      document.getElementById('totalConfirmados').textContent = confirmados;
      document.getElementById('totalConcluidos').textContent = concluidos;
    }

    // NavegaÃ§Ã£o entre tabs
    function mostrarTab(tab) {
      // Ocultar todas
      document.getElementById('secaoCalendario').classList.add('hidden');
      document.getElementById('secaoPendentes').classList.add('hidden');
      document.getElementById('secaoConfirmados').classList.add('hidden');
      document.getElementById('secaoConcluidos').classList.add('hidden');

      // Remover destaque
      document.querySelectorAll('[id^="tab"]').forEach(t => {
        t.style.borderBottom = 'none';
      });

      // Mostrar seÃ§Ã£o
      if (tab === 'calendario') {
        document.getElementById('secaoCalendario').classList.remove('hidden');
        document.getElementById('tabCalendario').style.borderBottom = '3px solid var(--primary-color)';
      } else if (tab === 'pendentes') {
        document.getElementById('secaoPendentes').classList.remove('hidden');
        document.getElementById('tabPendentes').style.borderBottom = '3px solid var(--primary-color)';
        carregarPendentes();
      } else if (tab === 'confirmados') {
        document.getElementById('secaoConfirmados').classList.remove('hidden');
        document.getElementById('tabConfirmados').style.borderBottom = '3px solid var(--primary-color)';
        carregarConfirmados();
      } else if (tab === 'concluidos') {
        document.getElementById('secaoConcluidos').classList.remove('hidden');
        document.getElementById('tabConcluidos').style.borderBottom = '3px solid var(--primary-color)';
        carregarConcluidos();
      }
    }

    // CalendÃ¡rio
    const meses = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

    function renderizarCalendario() {
      document.getElementById('mesAno').textContent = `${meses[mesAtual]} ${anoAtual}`;

      const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0).getDate();

      const container = document.getElementById('diasCalendario');
      container.innerHTML = '';

      // Dias vazios
      for (let i = 0; i < primeiroDia; i++) {
        const vazio = document.createElement('div');
        vazio.className = 'calendar-day disabled';
        container.appendChild(vazio);
      }

      // Dias do mÃªs
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const divDia = document.createElement('div');
        divDia.className = 'calendar-day';
        divDia.textContent = dia;

        const dataAtual = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        
        // Verificar se tem agendamentos neste dia
        const temAgendamento = todosAgendamentos.some(ag => ag.dataHora.startsWith(dataAtual));
        if (temAgendamento) {
          divDia.classList.add('has-booking');
        }

        // Marcar se Ã© hoje
        const hoje = new Date();
        if (dia === hoje.getDate() && mesAtual === hoje.getMonth() && anoAtual === hoje.getFullYear()) {
          divDia.style.border = '2px solid var(--primary-color)';
        }

        divDia.onclick = () => selecionarDia(dataAtual, divDia);
        container.appendChild(divDia);
      }
    }

    function mesAnterior() {
      mesAtual--;
      if (mesAtual < 0) {
        mesAtual = 11;
        anoAtual--;
      }
      renderizarCalendario();
    }

    function proximoMes() {
      mesAtual++;
      if (mesAtual > 11) {
        mesAtual = 0;
        anoAtual++;
      }
      renderizarCalendario();
    }

    function selecionarDia(data, elemento) {
      // Remover seleÃ§Ã£o anterior
      document.querySelectorAll('.calendar-day').forEach(d => {
        d.classList.remove('selected');
      });

      elemento.classList.add('selected');
      dataSelecionada = data;

      // Mostrar agendamentos do dia
      const agendamentosDia = todosAgendamentos.filter(ag => ag.dataHora.startsWith(data));
      
      const dataFormatada = new Date(data + 'T00:00').toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long' 
      });

      document.getElementById('tituloAgendamentosDia').textContent = `ğŸ“‹ ${dataFormatada}`;
      
      const container = document.getElementById('agendamentosDia');
      
      if (agendamentosDia.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Nenhum agendamento nesta data</p>';
        return;
      }

      container.innerHTML = '';
      agendamentosDia.sort((a, b) => a.dataHora.localeCompare(b.dataHora));
      
      agendamentosDia.forEach(ag => {
        const hora = ag.dataHora.split('T')[1];
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.style.padding = '12px';
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">ğŸ• ${hora} - ${ag.servico}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">ğŸ‘¤ ${ag.nome}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">ğŸ’° ${formatarPreco(ag.preco)}</div>
            </div>
            <span class="badge badge-${ag.status === 'pendente' ? 'warning' : ag.status === 'confirmado' ? 'primary' : 'success'}">
              ${ag.status === 'pendente' ? 'â³' : ag.status === 'confirmado' ? 'âœ…' : 'ğŸ‰'} ${ag.status}
            </span>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Carregar pendentes
    async function carregarPendentes() {
      const container = document.getElementById('listaPendentes');
      container.innerHTML = '<div class="spinner"></div>';

      await carregarTodosAgendamentos();
      
      const pendentes = todosAgendamentos.filter(ag => ag.status === 'pendente');

      if (pendentes.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento pendente</p>';
        return;
      }

      container.innerHTML = '';
      pendentes.forEach(ag => {
        const card = criarCardAgendamento(ag, 'pendente');
        container.appendChild(card);
      });
    }

    // Carregar confirmados
    async function carregarConfirmados() {
      const container = document.getElementById('listaConfirmados');
      container.innerHTML = '<div class="spinner"></div>';

      await carregarTodosAgendamentos();
      
      const confirmados = todosAgendamentos.filter(ag => ag.status === 'confirmado');

      if (confirmados.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento confirmado</p>';
        return;
      }

      container.innerHTML = '';
      confirmados.forEach(ag => {
        const card = criarCardAgendamento(ag, 'confirmado');
        container.appendChild(card);
      });
    }

    // Carregar concluÃ­dos
    async function carregarConcluidos() {
      const container = document.getElementById('listaConcluidos');
      container.innerHTML = '<div class="spinner"></div>';

      await carregarTodosAgendamentos();
      
      const concluidos = todosAgendamentos.filter(ag => ag.status === 'concluido');

      if (concluidos.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento concluÃ­do</p>';
        return;
      }

      container.innerHTML = '';
      concluidos.forEach(ag => {
        const card = criarCardAgendamento(ag, 'concluido');
        container.appendChild(card);
      });
    }

    // Criar card de agendamento
    function criarCardAgendamento(ag, status) {
      const card = document.createElement('div');
      card.className = 'card mb-2';
      
      const data = new Date(ag.dataHora);
      const dataFormatada = data.toLocaleDateString('pt-BR');
      const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

      let acoes = '';
      if (status === 'pendente') {
        acoes = `
          <button class="btn btn-sm btn-success" onclick="abrirModalConfirmar('${ag.id}', ${ag.preco})">
            âœ… Confirmar
          </button>
          <button class="btn btn-sm btn-danger" onclick="cancelarAgendamento('${ag.id}')">
            âŒ Cancelar
          </button>
        `;
      } else if (status === 'confirmado') {
        acoes = `
          <button class="btn btn-sm btn-success" onclick="concluirAgendamento('${ag.id}')">
            ğŸ‰ Concluir
          </button>
        `;
      }

      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; gap: 16px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span class="badge badge-${status === 'pendente' ? 'warning' : status === 'confirmado' ? 'primary' : 'success'}">
                ${status === 'pendente' ? 'â³ Pendente' : status === 'confirmado' ? 'âœ… Confirmado' : 'ğŸ‰ ConcluÃ­do'}
              </span>
            </div>
            <h4 style="margin: 8px 0;">${ag.servico}</h4>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              ğŸ‘¤ ${ag.nome} | ğŸ“ ${ag.telefone}
            </p>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              ğŸ“… ${dataFormatada} Ã s ${horaFormatada} | â±ï¸ ${formatarDuracao(ag.duracao)}
            </p>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              ğŸ’° ${formatarPreco(ag.precoFinal || ag.preco)}
            </p>
            ${ag.observacoes !== 'Nenhuma' ? `<p style="font-size: 13px; color: var(--text-tertiary); margin-top: 8px;">ğŸ’¬ ${ag.observacoes}</p>` : ''}
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${acoes}
            <button class="btn btn-sm btn-primary" onclick="abrirChat('${ag.id}', '${ag.nome}')">
              ğŸ’¬ Chat
            </button>
          </div>
        </div>
      `;
      
      return card;
    }

    // Modal confirmar
    function abrirModalConfirmar(id, precoSugerido) {
      agendamentoParaConfirmar = id;
      document.getElementById('precoFinal').value = precoSugerido;
      document.getElementById('modalConfirmar').classList.remove('hidden');
    }

    function fecharModalConfirmar() {
      document.getElementById('modalConfirmar').classList.add('hidden');
      agendamentoParaConfirmar = null;
    }

    document.getElementById('formConfirmar').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const precoFinal = parseFloat(document.getElementById('precoFinal').value);
      
      try {
        await atualizarAgendamento(agendamentoParaConfirmar, {
          status: 'confirmado',
          precoFinal
        });
        
        fecharModalConfirmar();
        alert('âœ… Agendamento confirmado com sucesso!');
        carregarTodosAgendamentos();
        carregarPendentes();
      } catch (error) {
        console.error('Erro:', error);
        alert('âŒ Erro ao confirmar agendamento');
      }
    });

    // Concluir agendamento
    async function concluirAgendamento(id) {
      if (!confirm('Confirmar conclusÃ£o deste agendamento?')) return;

      try {
        await alterarStatusAgendamento(id, 'concluido');
        alert('âœ… Agendamento concluÃ­do!');
        carregarTodosAgendamentos();
        carregarConfirmados();
      } catch (error) {
        console.error('Erro:', error);
        alert('âŒ Erro ao concluir agendamento');
      }
    }

    // Cancelar agendamento
    async function cancelarAgendamento(id) {
      if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;

      try {
        await alterarStatusAgendamento(id, 'cancelado');
        alert('âœ… Agendamento cancelado');
        carregarTodosAgendamentos();
        carregarPendentes();
      } catch (error) {
        console.error('Erro:', error);
        alert('âŒ Erro ao cancelar agendamento');
      }
    }

    // Chat
    function abrirChat(agendamentoId, nomeCliente) {
      agendamentoAtualChat = agendamentoId;
      document.getElementById('chatTitulo').textContent = `ğŸ’¬ Chat com ${nomeCliente}`;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagensChat();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      agendamentoAtualChat = null;
    }

    function carregarMensagensChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';

      listarMensagens(agendamentoAtualChat, (mensagens) => {
        container.innerHTML = '';
        mensagens.forEach(msg => {
          const div = document.createElement('div');
          div.className = msg.userId === usuarioAtual.uid ? 'chat-message sent' : 'chat-message received';
          div.innerHTML = `
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${msg.userNome}</div>
            <div>${msg.mensagem}</div>
            <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">
              ${new Date(msg.timestamp).toLocaleTimeString('pt-BR')}
            </div>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const mensagem = input.value.trim();
      
      if (!mensagem) return;

      const perfil = await obterPerfilUsuario(usuarioAtual.uid);
      
      await enviarMensagem(agendamentoAtualChat, {
        userId: usuarioAtual.uid,
        userNome: perfil.nome || 'Admin',
        mensagem
      });

      input.value = '';
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        enviarMensagemChat();
      }
    });

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'index.html';
      });
    }

    // AtualizaÃ§Ã£o automÃ¡tica a cada 30 segundos
    setInterval(carregarTodosAgendamentos, 30000);
  </script>
</body>
</html>
