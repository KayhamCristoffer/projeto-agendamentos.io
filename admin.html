<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">


</head>

<body>
  <nav class="nav-bar">
    <div class="nav-container">
      <a href="#" class="nav-logo">ğŸ› ï¸ Painel Admin</a>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span id="nomeAdmin" style="color: var(--text-secondary); font-size: 14px;"></span>
        <button class="btn btn-sm btn-ghost" onclick="logout()">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container container-wide" style="margin-top: 20px;">

    <div
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <div class="dashboard-stat" style="border-left: 5px solid var(--primary-color);">
        <div class="stat-number" id="totalAgendamentos">0</div>
        <div class="stat-label">Total de Agendamentos</div>
      </div>
      <div class="dashboard-stat" style="border-left: 5px solid var(--warning);">
        <div class="stat-number" id="pendentesHoje">0</div>
        <div class="stat-label">Agendamentos Pendentes (Hoje)</div>
      </div>
      <div class="dashboard-stat" style="border-left: 5px solid var(--success);">
        <div class="stat-number" id="confirmadosHoje">0</div>
        <div class="stat-label">Agendamentos Confirmados (Hoje)</div>
      </div>
      <div class="dashboard-stat" style="border-left: 5px solid var(--danger);">
        <div class="stat-number" id="naoLidas">0</div>
        <div class="stat-label">Mensagens NÃ£o Lidas</div>
      </div>
    </div>

    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); overflow-x: auto;">
      <button class="btn btn-ghost" id="tabPendentes" onclick="mostrarSecao('pendentes')"
        style="border-radius: 0; border-bottom: 3px solid var(--warning); white-space: nowrap;">
        â³ Pendentes
      </button>
      <button class="btn btn-ghost" id="tabConfirmados" onclick="mostrarSecao('confirmados')"
        style="border-radius: 0; white-space: nowrap;">
        âœ… Confirmados
      </button>
      <button class="btn btn-ghost" id="tabHistorico" onclick="mostrarSecao('historico')"
        style="border-radius: 0; white-space: nowrap;">
        ğŸ“œ HistÃ³rico
      </button>
      <button class="btn btn-ghost" id="tabCalendario" onclick="mostrarSecao('calendario')"
        style="border-radius: 0; white-space: nowrap;">
        ğŸ“… CalendÃ¡rio
      </button>
      <button class="btn btn-ghost" id="tabClientes" onclick="mostrarSecao('clientes')"
        style="border-radius: 0; white-space: nowrap;">
        ğŸ‘¥ Clientes
      </button>
      <button class="btn btn-ghost" id="tabUsuarios" onclick="mostrarSecao('usuarios')"
        style="border-radius: 0; white-space: nowrap;">
        ğŸ‘¤ UsuÃ¡rios
      </button>
      <button class="btn btn-ghost" id="tabConfig" onclick="mostrarSecao('config')"
        style="border-radius: 0; white-space: nowrap;">
        âš™ï¸ ConfiguraÃ§Ãµes
      </button>
    </div>

    <div id="secaoPendentes" class="fade-in">
      <h3>â³ Agendamentos Pendentes (Aguardando ConfirmaÃ§Ã£o)</h3>
      <div id="listaPendentes" class="mt-3">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="secaoConfirmados" class="hidden">
      <h3>âœ… Agendamentos Confirmados</h3>
      <div id="listaConfirmados" class="mt-3">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="secaoHistorico" class="hidden">
      <h3>ğŸ“œ HistÃ³rico de Agendamentos (ConcluÃ­dos/Cancelados)</h3>
      <div id="listaHistorico" class="mt-3">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: CalendÃ¡rio -->
    <div id="secaoCalendario" class="hidden">
      <h3>ğŸ“… CalendÃ¡rio de Agendamentos</h3>
      <div class="card mt-3">
        <div class="calendar-header">
          <button class="btn btn-sm btn-ghost" onclick="mesAnterior()">â†</button>
          <h4 id="mesAnoAdmin" style="margin: 0;"></h4>
          <button class="btn btn-sm btn-ghost" onclick="proximoMes()">â†’</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 16px; text-align: center; font-weight: 600; font-size: 12px;">
          <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>SÃ¡b</div>
        </div>
        <div id="diasCalendarioAdmin" class="calendar-grid mt-1"></div>
      </div>
      
      <div class="card mt-3">
        <h4 id="tituloAgendamentosDia">Selecione uma data</h4>
        <div id="agendamentosDia" class="mt-2">
          <p style="color: var(--text-secondary); text-align: center;">Clique em uma data no calendÃ¡rio</p>
        </div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: Clientes -->
    <div id="secaoClientes" class="hidden">
      <h3>ğŸ‘¥ Gerenciar Clientes</h3>
      <p style="color: var(--text-secondary);">Visualize e gerencie os dados dos clientes</p>
      <div id="listaClientes" class="mt-3">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- SeÃ§Ã£o: UsuÃ¡rios -->
    <div id="secaoUsuarios" class="hidden">
      <h3>ğŸ‘¤ Gerenciar UsuÃ¡rios</h3>
      <p style="color: var(--text-secondary);">Altere roles e gerencie permissÃµes</p>
      
      <button class="btn btn-primary mb-3" onclick="mostrarModalNovoUsuario()">
        â• Criar Novo UsuÃ¡rio
      </button>
      
      <div id="listaUsuarios" class="mt-3">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="secaoConfig" class="hidden">
      <h3>âš™ï¸ ConfiguraÃ§Ãµes de Funcionamento</h3>

      <div class="card mt-3">
        <h4>HorÃ¡rios da Semana</h4>
        <p style="color: var(--text-secondary); font-size: 14px;">Defina os horÃ¡rios de inÃ­cio, fim e a duraÃ§Ã£o dos
          slots de agendamento.</p>

        <form id="formHorarios" class="mt-3">
          <div class="form-group">
            <label class="form-label">DuraÃ§Ã£o PadrÃ£o do Slot (minutos)</label>
            <input class="form-input" type="number" id="slotDuracao" required min="5" max="60" step="5">
          </div>

          <table class="horarios-table">
            <thead>
              <tr>
                <th>Dia da Semana</th>
                <th>Abre Ã s</th>
                <th>Fecha Ã s</th>
                <th>Funcionando</th>
              </tr>
            </thead>
            <tbody id="horariosBody">
            </tbody>
          </table>
          <button type="submit" class="btn btn-primary mt-3">
            ğŸ’¾ Salvar ConfiguraÃ§Ãµes
          </button>
          <div id="mensagemConfig" class="mt-2" style="display: none;"></div>
        </form>
      </div>
    </div>
  </div>

  <div id="modalChat" class="hidden"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="width: 90%; max-width: 600px;">
      <div class="chat-container">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>ğŸ’¬ Chat com <strong id="chatNomeCliente">Cliente</strong></span>
          <button onclick="fecharChat()"
            style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">Ã—</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input form-input" id="chatInput" placeholder="Digite sua mensagem..."
            style="margin: 0;">
          <button class="btn btn-primary" onclick="enviarMensagemChat()">ğŸ“¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Chat -->
  <div id="modalChat" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="chatTitulo">ğŸ’¬ Chat</h3>
        <button class="btn-close" onclick="fecharModalChat()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="chat-messages" id="chatMessages" style="max-height: 400px; overflow-y: auto; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 16px;">
          <!-- Mensagens aqui -->
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" class="form-input" id="chatInputMensagem" placeholder="Digite sua mensagem..." style="flex: 1; margin: 0;">
          <button class="btn btn-primary" onclick="enviarMensagemChat()">ğŸ“¤ Enviar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar Agendamento -->
  <div id="modalConfirmar" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœ… Confirmar Agendamento</h3>
        <button class="btn-close" onclick="fecharModalConfirmar()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="formConfirmar">
          <div class="form-group">
            <label class="form-label">PreÃ§o Final (R$)</label>
            <input class="form-input" type="number" id="precoFinal" step="0.01" min="0" required>
            <small class="form-help">Ajuste o preÃ§o final se necessÃ¡rio</small>
          </div>
          <div style="display: flex; gap: 8px;">
            <button type="submit" class="btn btn-success" style="flex: 1;">âœ… Confirmar</button>
            <button type="button" class="btn btn-ghost" onclick="fecharModalConfirmar()" style="flex: 1;">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Novo UsuÃ¡rio -->
  <div id="modalNovoUsuario" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>â• Criar Novo UsuÃ¡rio</h3>
        <button class="btn-close" onclick="fecharModalNovoUsuario()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="formNovoUsuario">
          <div class="form-group">
            <label class="form-label">Nome Completo</label>
            <input class="form-input" type="text" id="novoNome" required>
          </div>
          <div class="form-group">
            <label class="form-label">E-mail</label>
            <input class="form-input" type="email" id="novoEmail" required>
          </div>
          <div class="form-group">
            <label class="form-label">Telefone</label>
            <input class="form-input" type="tel" id="novoTelefone" placeholder="(00) 00000-0000" required>
          </div>
          <div class="form-group">
            <label class="form-label">Senha</label>
            <input class="form-input" type="password" id="novoSenha" minlength="6" required>
          </div>
          <div class="form-group">
            <label class="form-label">Role</label>
            <select class="form-input" id="novoRole" required>
              <option value="cliente">Cliente</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div id="mensagemNovoUsuario" class="mt-2"></div>
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">â• Criar</button>
            <button type="button" class="btn btn-ghost" onclick="fecharModalNovoUsuario()" style="flex: 1;">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal: Editar Role -->
  <div id="modalEditarRole" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœï¸ Alterar PermissÃ£o de UsuÃ¡rio</h3>
        <button class="btn-close" onclick="fecharModalEditarRole()">Ã—</button>
      </div>
      <div class="modal-body">
        <form id="formEditarRole">
          <p style="margin-bottom: 16px;">UsuÃ¡rio: <strong id="editarRoleNome"></strong></p>
          <div class="form-group">
            <label class="form-label">Nova Role</label>
            <select class="form-input" id="editarRoleSelect" required>
              <option value="cliente">Cliente</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div id="mensagemEditarRole" class="mt-2"></div>
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ Salvar</button>
            <button type="button" class="btn btn-ghost" onclick="fecharModalEditarRole()" style="flex: 1;">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let usuarioAtual = null;
    let perfilAdmin = {};
    let agendamentoAtualChat = null;
    let agendamentosCache = {}; // Cache para todos os agendamentos
    let agendamentoParaConfirmar = null;
    let usuarioParaEditar = null;
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();

    // ===============================================
    // AUTENTICAÃ‡ÃƒO E INICIALIZAÃ‡ÃƒO
    // ===============================================

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      usuarioAtual = user;

      // 1. Verificar se Ã© admin
      const perfil = await obterPerfilUsuario(user.uid);
      if (!perfil || perfil.role !== 'admin') {
        alert('Acesso negado. VocÃª nÃ£o Ã© um administrador.');
        window.location.href = 'cliente.html';
        return;
      }

      perfilAdmin = perfil;
      document.getElementById('nomeAdmin').textContent = perfil.nomeCompleto || perfil.email;

      // 2. Configurar o listener de agendamentos para manter a lista atualizada
      // O listarAgendamentos Ã© uma funÃ§Ã£o em database.js que mantÃ©m a conexÃ£o em tempo real
      listarAgendamentos((dados) => {
        agendamentosCache = dados || {};
        renderizarTodasSecoes();
        atualizarDashboard();
      });

      // 3. Inicializar configuraÃ§Ãµes e seÃ§Ã£o principal
      carregarConfiguracoesHorario();
      mostrarSecao('pendentes');
    });

    // ===============================================
    // FUNÃ‡Ã•ES DE EXIBIÃ‡ÃƒO E RENDERIZAÃ‡ÃƒO
    // ===============================================

    // NavegaÃ§Ã£o entre seÃ§Ãµes
    function mostrarSecao(secao) {
      // Ocultar todas
      document.getElementById('secaoPendentes').classList.add('hidden');
      document.getElementById('secaoConfirmados').classList.add('hidden');
      document.getElementById('secaoHistorico').classList.add('hidden');
      document.getElementById('secaoCalendario').classList.add('hidden');
      document.getElementById('secaoClientes').classList.add('hidden');
      document.getElementById('secaoUsuarios').classList.add('hidden');
      document.getElementById('secaoConfig').classList.add('hidden');

      // Remover destaque dos tabs
      document.querySelectorAll('[id^="tab"]').forEach(tab => {
        tab.style.borderBottom = 'none';
      });

      // Mostrar seÃ§Ã£o selecionada
      const secaoElement = document.getElementById(`secao${secao.charAt(0).toUpperCase() + secao.slice(1)}`);
      const tabElement = document.getElementById(`tab${secao.charAt(0).toUpperCase() + secao.slice(1)}`);

      if (secaoElement) secaoElement.classList.remove('hidden');
      if (tabElement) tabElement.style.borderBottom = '3px solid var(--primary-color)';

      // Corrigir cor da tab de pendentes
      if (secao === 'pendentes') tabElement.style.borderBottom = '3px solid var(--warning)';
      if (secao === 'confirmados') tabElement.style.borderBottom = '3px solid var(--success)';
      if (secao === 'historico') tabElement.style.borderBottom = '3px solid var(--info)';
      if (secao === 'config') tabElement.style.borderBottom = '3px solid var(--danger)';
      
      // Carregar dados especÃ­ficos da seÃ§Ã£o
      if (secao === 'calendario') {
        renderizarCalendario();
      } else if (secao === 'clientes') {
        carregarClientes();
      } else if (secao === 'usuarios') {
        carregarUsuarios();
      }
    }

    // Renderizar todas as seÃ§Ãµes (chamada pelo listener do Firebase)
    function renderizarTodasSecoes() {
      const agendamentosArray = Object.entries(agendamentosCache)
        .map(([id, ag]) => ({ id, ...ag }))
        .sort((a, b) => new Date(a.dataHora) - new Date(b.dataHora));

      const pendentes = agendamentosArray.filter(ag => ag.status === 'pendente');
      const confirmados = agendamentosArray.filter(ag => ag.status === 'confirmado');
      const historico = agendamentosArray.filter(ag => ag.status === 'concluido' || ag.status === 'cancelado');

      renderizarLista(document.getElementById('listaPendentes'), pendentes, true);
      renderizarLista(document.getElementById('listaConfirmados'), confirmados, true);
      renderizarLista(document.getElementById('listaHistorico'), historico, false);
    }

    // Renderizar a lista de agendamentos em uma seÃ§Ã£o
    function renderizarLista(container, lista, showActions) {
      container.innerHTML = '';
      if (lista.length === 0) {
        container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento nesta lista.</p>';
        return;
      }

      lista.forEach(ag => {
        const card = criarCardAgendamentoAdmin(ag, showActions);
        container.appendChild(card);
      });
    }

    // Criar o card de agendamento para o Admin (Atualizado para multi-serviÃ§o)
    function criarCardAgendamentoAdmin(ag, showActions) {
      const card = document.createElement('div');
      card.className = `agendamento-card ${ag.status}`;

      const data = new Date(ag.dataHora);
      const dataFormatada = data.toLocaleDateString('pt-BR');
      const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

      // Mapeia o array de serviÃ§os para uma lista bonita (usando a nova estrutura)
      const listaServicos = (ag.servicos || [{ nome: ag.servico || 'ServiÃ§o Indefinido' }])
        .map(s => `<li>${s.nome} (${formatarPreco(s.preco)})</li>`)
        .join('');

      const precoDisplay = formatarPreco(ag.precoTotal || ag.preco || 0);
      const duracaoDisplay = formatarDuracao(ag.duracaoTotal || ag.duracao || 0);

      let statusBadge = '';
      if (ag.status === 'pendente') statusBadge = `<span class="badge badge-warning">â³ Pendente</span>`;
      if (ag.status === 'confirmado') statusBadge = `<span class="badge badge-success">âœ… Confirmado</span>`;
      if (ag.status === 'concluido') statusBadge = `<span class="badge badge-info">âœ… ConcluÃ­do</span>`;
      if (ag.status === 'cancelado') statusBadge = `<span class="badge badge-danger">âŒ Cancelado</span>`;

      card.innerHTML = `
            <div class="agendamento-header">
                <h4 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    ${ag.clienteNome || ag.nomeCompleto || ag.email || 'Cliente'}
                    ${statusBadge}
                </h4>
                <div class="agendamento-actions">
                    <button class="btn btn-sm btn-primary" onclick="abrirModalChat('${ag.id}', '${ag.clienteNome || ag.nomeCompleto || 'Cliente'}')">
                        ğŸ’¬ Chat
                    </button>
                    ${showActions && ag.status === 'pendente' ? `
                        <button class="btn btn-sm btn-success" onclick="abrirModalConfirmar('${ag.id}', ${ag.precoTotal || ag.preco || 0})">
                            âœ… Confirmar
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="alterarStatusAgendamentoAdmin('${ag.id}', 'cancelado')">
                            âŒ Recusar
                        </button>
                    ` : ''}
                    ${showActions && ag.status === 'confirmado' ? `
                        <button class="btn btn-sm btn-info" onclick="alterarStatusAgendamentoAdmin('${ag.id}', 'concluido')">
                            ğŸ‘ Concluir
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="alterarStatusAgendamentoAdmin('${ag.id}', 'cancelado')">
                            âŒ Cancelar
                        </button>
                    ` : ''}
                </div>
            </div>
            <div class="agendamento-details">
                <p><strong>ğŸ“… Data/Hora:</strong> ${dataFormatada} Ã s ${horaFormatada}</p>
                <p><strong>ğŸ‘¤ Cliente:</strong> ${ag.clienteNome || ag.nomeCompleto || 'N/A'}</p>
                <p><strong>ğŸ“ Telefone:</strong> ${ag.clienteTelefone || ag.telefone || 'N/A'}</p>
                <p><strong>ğŸ“§ Email:</strong> ${ag.clienteEmail || ag.email || 'N/A'}</p>
                <p><strong>ğŸ’° PreÃ§o Total:</strong> ${precoDisplay}</p>
                <p><strong>â±ï¸ DuraÃ§Ã£o Total:</strong> ${duracaoDisplay}</p>
                <p><strong>âœ¨ ServiÃ§os:</strong></p>
                <ul style="margin-top: 5px;">${listaServicos}</ul>
                ${ag.observacoes && ag.observacoes !== '' ? `<p style="margin-top: 10px;"><strong>ğŸ’¬ Obs:</strong> ${ag.observacoes}</p>` : ''}
            </div>
        `;

      return card;
    }

    // Atualizar o Dashboard
    async function atualizarDashboard() {
      // As contagens sÃ£o fÃ¡ceis com o cache de agendamentos
      const agendamentosArray = Object.entries(agendamentosCache)
        .map(([id, ag]) => ({ id, ...ag }));

      const hoje = new Date().toISOString().split('T')[0];

      const total = agendamentosArray.length;
      const pendentesHoje = agendamentosArray.filter(ag => ag.status === 'pendente' && ag.dataHora.startsWith(hoje)).length;
      const confirmadosHoje = agendamentosArray.filter(ag => ag.status === 'confirmado' && ag.dataHora.startsWith(hoje)).length;

      // Chamada assÃ­ncrona para mensagens nÃ£o lidas
      const naoLidas = await contarMensagensNaoLidas();

      document.getElementById('totalAgendamentos').textContent = total;
      document.getElementById('pendentesHoje').textContent = pendentesHoje;
      document.getElementById('confirmadosHoje').textContent = confirmadosHoje;
      document.getElementById('naoLidas').textContent = naoLidas;
    }

    // ===============================================
    // FUNÃ‡Ã•ES DE AÃ‡ÃƒO DO ADMIN
    // ===============================================

    // FunÃ§Ã£o para alterar o status do agendamento
    async function alterarStatusAgendamentoAdmin(id, novoStatus) {
      if (!confirm(`Tem certeza que deseja alterar o status do agendamento ${id} para '${novoStatus}'?`)) return;

      try {
        await alterarStatusAgendamento(id, novoStatus); // funÃ§Ã£o em database.js
        alert(`âœ… Agendamento ${id} alterado para ${novoStatus}!`);
        // O listener do Firebase se encarrega de chamar o renderizarTodasSecoes
      } catch (error) {
        console.error('Erro:', error);
        alert('âŒ Erro ao alterar status do agendamento');
      }
    }

    // ===============================================
    // FUNÃ‡Ã•ES DE CHAT
    // ===============================================

    function abrirChat(agendamentoId, clienteNome) {
      agendamentoAtualChat = agendamentoId;
      document.getElementById('chatNomeCliente').textContent = clienteNome;
      document.getElementById('modalChat').classList.remove('hidden');
      marcarComoLido(agendamentoId); // Marcar como lido ao abrir
      carregarMensagensChat();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      agendamentoAtualChat = null;
      atualizarDashboard(); // Atualiza a contagem de nÃ£o lidas
    }

    function carregarMensagensChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';

      // listarMensagens (em database.js)
      listarMensagens(agendamentoAtualChat, (mensagens) => {
        container.innerHTML = '';
        mensagens.forEach(msg => {
          const div = document.createElement('div');
          // Se o userId for o do Admin (usuarioAtual.uid), Ã© "sent", senÃ£o Ã© "received"
          div.className = msg.userId === usuarioAtual.uid ? 'chat-message sent' : 'chat-message received';
          div.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${msg.userNome}</div>
                    <div>${msg.mensagem}</div>
                    <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">
                        ${new Date(msg.timestamp).toLocaleTimeString('pt-BR')}
                    </div>
                `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const mensagem = input.value.trim();

      if (!mensagem) return;

      await enviarMensagem(agendamentoAtualChat, {
        userId: usuarioAtual.uid,
        userNome: perfilAdmin.nomeCompleto || 'Admin', // Usar nome do Admin
        mensagem
      });

      input.value = '';
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        enviarMensagemChat();
      }
    });

    // ===============================================
    // FUNÃ‡Ã•ES DE CONFIGURAÃ‡ÃƒO (HorÃ¡rios)
    // ===============================================

    // Injeta a tabela de horÃ¡rios
    function carregarConfiguracoesHorario() {
      // BUSINESS_HOURS vem de services-config.js
      // admin.html, linha ~419
      const {
        dias_semana_nome,
        slot_duracao,
        dias_funcionamento,
        inicio: horario_inicio, // Renomeado
        fim: horario_fim // Renomeado
      } = BUSINESS_HOURS;
      // Preenche duraÃ§Ã£o do slot
      document.getElementById('slotDuracao').value = slot_duracao;

      dias_semana_nome.forEach((dia, index) => {
        const tr = document.createElement('tr');
        const isFunciona = dias_funcionamento.includes(index);

        tr.innerHTML = `
                <td>${dia}</td>
                <td><input type="time" class="form-input" name="inicio_${index}" value="${horario_inicio}" ${!isFunciona ? 'disabled' : ''}></td>
                <td><input type="time" class="form-input" name="fim_${index}" value="${horario_fim}" ${!isFunciona ? 'disabled' : ''}></td>
                <td>
                    <input type="checkbox" data-dia="${index}" onchange="toggleHorarios(this, ${index})" ${isFunciona ? 'checked' : ''}>
                </td>
            `;
        document.querySelector("#tabelaHorarios tbody").appendChild(tr);
      });
    }

    // Habilita/Desabilita os campos de horÃ¡rio
    function toggleHorarios(checkbox, diaIndex) {
      const inputs = document.querySelectorAll(`input[name$="_${diaIndex}"]`);
      inputs.forEach(input => {
        if (input.type === 'time') {
          input.disabled = !checkbox.checked;
        }
      });
    }

    // Salvar configuraÃ§Ãµes de horÃ¡rio
    document.getElementById('formHorarios').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const dados = {};

      dados.slot_duracao = parseInt(document.getElementById('slotDuracao').value);
      dados.horario_inicio = form.querySelector('input[name="inicio_1"]').value; // Assume segunda
      dados.horario_fim = form.querySelector('input[name="fim_1"]').value; // Assume segunda
      dados.dias_funcionamento = [];

      // Coleta os dias selecionados
      form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        if (checkbox.checked) {
          dados.dias_funcionamento.push(parseInt(checkbox.dataset.dia));
        }
      });

      // SalvarHorariosFuncionamento (a ser implementado em database.js)
      try {
        // Por enquanto, apenas atualizamos a variÃ¡vel global (nÃ£o persiste)
        Object.assign(BUSINESS_HOURS, dados);

        // Chamamos a funÃ§Ã£o de persistÃªncia (que precisarÃ¡ ser criada)
        await salvarConfiguracaoHorarios(dados); // <<-- Esta funÃ§Ã£o deve ser criada em database.js

        mostrarMensagemConfig('âœ… HorÃ¡rios de funcionamento atualizados com sucesso!', 'sucesso');
        carregarConfiguracoesHorario(); // Recarrega
      } catch (error) {
        console.error('Erro ao salvar horÃ¡rios:', error);
        mostrarMensagemConfig('âŒ Erro ao salvar horÃ¡rios: ' + error.message, 'erro');
      }
    });

    function mostrarMensagemConfig(texto, tipo) {
      const msg = document.getElementById('mensagemConfig');
      msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
      msg.textContent = texto;
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 5000);
    }

    // ===============================================
    // FUNÃ‡Ã•ES DE MODAL - CHAT
    // ===============================================

    function abrirModalChat(agendamentoId, nomeCliente) {
      agendamentoAtualChat = agendamentoId;
      document.getElementById('chatTitulo').textContent = `ğŸ’¬ Chat com ${nomeCliente}`;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagensChat();
    }

    function fecharModalChat() {
      document.getElementById('modalChat').classList.add('hidden');
      agendamentoAtualChat = null;
    }

    function carregarMensagensChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '<div class="spinner"></div>';

      listarMensagens(agendamentoAtualChat, (mensagens) => {
        container.innerHTML = '';
        mensagens.forEach(msg => {
          const div = document.createElement('div');
          div.style.cssText = `
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            ${msg.userId === usuarioAtual.uid ? 
              'background: var(--primary-color); color: white; margin-left: 40px; text-align: right;' : 
              'background: var(--bg-secondary); margin-right: 40px;'}
          `;
          div.innerHTML = `
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${msg.nome || 'UsuÃ¡rio'}</div>
            <div>${msg.texto}</div>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 4px;">
              ${new Date(msg.timestamp).toLocaleString('pt-BR')}
            </div>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const mensagem = input.value.trim();
      
      if (!mensagem) return;

      try {
        await enviarMensagem(agendamentoAtualChat, {
          userId: usuarioAtual.uid,
          nome: perfilAdmin.nomeCompleto || 'Admin',
          texto: mensagem
        });

        input.value = '';
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem');
      }
    }

    // Enter para enviar
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        enviarMensagemChat();
      }
    });

    // ===============================================
    // FUNÃ‡Ã•ES DE MODAL - CONFIRMAR AGENDAMENTO
    // ===============================================

    function abrirModalConfirmar(agendamentoId, precoSugerido) {
      agendamentoParaConfirmar = agendamentoId;
      document.getElementById('precoFinal').value = precoSugerido;
      document.getElementById('modalConfirmar').classList.remove('hidden');
    }

    function fecharModalConfirmar() {
      document.getElementById('modalConfirmar').classList.add('hidden');
      agendamentoParaConfirmar = null;
    }

    document.getElementById('formConfirmar').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const precoFinal = parseFloat(document.getElementById('precoFinal').value);
      
      try {
        await atualizarAgendamento(agendamentoParaConfirmar, {
          status: 'confirmado',
          precoFinal: precoFinal
        });
        
        fecharModalConfirmar();
        alert('âœ… Agendamento confirmado com sucesso!');
      } catch (error) {
        console.error('Erro ao confirmar:', error);
        alert('âŒ Erro ao confirmar agendamento');
      }
    });

    // ===============================================
    // FUNÃ‡Ã•ES DE MODAL - NOVO USUÃRIO
    // ===============================================

    function mostrarModalNovoUsuario() {
      document.getElementById('modalNovoUsuario').classList.remove('hidden');
      document.getElementById('formNovoUsuario').reset();
      document.getElementById('mensagemNovoUsuario').innerHTML = '';
    }

    function fecharModalNovoUsuario() {
      document.getElementById('modalNovoUsuario').classList.add('hidden');
    }

    document.getElementById('formNovoUsuario').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const dados = {
        email: document.getElementById('novoEmail').value,
        senha: document.getElementById('novoSenha').value,
        nomeCompleto: document.getElementById('novoNome').value,
        telefone: document.getElementById('novoTelefone').value,
        role: document.getElementById('novoRole').value
      };

      const msgEl = document.getElementById('mensagemNovoUsuario');
      
      try {
        // Criar usuÃ¡rio no Authentication
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(dados.email, dados.senha);
        
        // Salvar perfil no database
        await salvarPerfilUsuario(userCredential.user.uid, {
          nomeCompleto: dados.nomeCompleto,
          telefone: dados.telefone,
          email: dados.email,
          role: dados.role,
          criadoEm: new Date().toISOString()
        });

        msgEl.className = 'alert alert-success';
        msgEl.textContent = 'âœ… UsuÃ¡rio criado com sucesso!';
        
        setTimeout(() => {
          fecharModalNovoUsuario();
          carregarUsuarios();
        }, 1500);
        
      } catch (error) {
        console.error('Erro ao criar usuÃ¡rio:', error);
        msgEl.className = 'alert alert-error';
        msgEl.textContent = `âŒ Erro: ${error.message}`;
      }
    });

    // ===============================================
    // FUNÃ‡Ã•ES DE MODAL - EDITAR ROLE
    // ===============================================

    function abrirModalEditarRole(userId, nomeUsuario, roleAtual) {
      usuarioParaEditar = userId;
      document.getElementById('editarRoleNome').textContent = nomeUsuario;
      document.getElementById('editarRoleSelect').value = roleAtual;
      document.getElementById('modalEditarRole').classList.remove('hidden');
      document.getElementById('mensagemEditarRole').innerHTML = '';
    }

    function fecharModalEditarRole() {
      document.getElementById('modalEditarRole').classList.add('hidden');
      usuarioParaEditar = null;
    }

    document.getElementById('formEditarRole').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const novaRole = document.getElementById('editarRoleSelect').value;
      const msgEl = document.getElementById('mensagemEditarRole');
      
      try {
        await atualizarPerfilUsuario(usuarioParaEditar, {
          role: novaRole
        });

        msgEl.className = 'alert alert-success';
        msgEl.textContent = 'âœ… Role atualizada com sucesso!';
        
        setTimeout(() => {
          fecharModalEditarRole();
          carregarUsuarios();
        }, 1500);
        
      } catch (error) {
        console.error('Erro ao atualizar role:', error);
        msgEl.className = 'alert alert-error';
        msgEl.textContent = `âŒ Erro: ${error.message}`;
      }
    });

    // ===============================================
    // FUNÃ‡Ã•ES - CALENDÃRIO
    // ===============================================

    const mesesNome = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];

    function renderizarCalendario() {
      document.getElementById('mesAnoAdmin').textContent = `${mesesNome[mesAtual]} ${anoAtual}`;

      const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0).getDate();

      const container = document.getElementById('diasCalendarioAdmin');
      container.innerHTML = '';

      // Dias vazios
      for (let i = 0; i < primeiroDia; i++) {
        const vazio = document.createElement('div');
        vazio.className = 'calendar-day disabled';
        container.appendChild(vazio);
      }

      // Dias do mÃªs
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const divDia = document.createElement('div');
        divDia.className = 'calendar-day';
        divDia.textContent = dia;

        const dataStr = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        
        // Verificar se tem agendamentos neste dia
        const agendamentosDia = Object.values(agendamentosCache).filter(ag => 
          ag.dataHora.startsWith(dataStr)
        );
        
        if (agendamentosDia.length > 0) {
          divDia.classList.add('has-booking');
          divDia.title = `${agendamentosDia.length} agendamento(s)`;
        }

        divDia.onclick = () => selecionarDiaCalendario(dataStr, divDia);
        container.appendChild(divDia);
      }
    }

    function mesAnterior() {
      mesAtual--;
      if (mesAtual < 0) {
        mesAtual = 11;
        anoAtual--;
      }
      renderizarCalendario();
    }

    function proximoMes() {
      mesAtual++;
      if (mesAtual > 11) {
        mesAtual = 0;
        anoAtual++;
      }
      renderizarCalendario();
    }

    function selecionarDiaCalendario(data, elemento) {
      // Remover seleÃ§Ã£o anterior
      document.querySelectorAll('#diasCalendarioAdmin .calendar-day').forEach(d => {
        d.classList.remove('selected');
      });

      elemento.classList.add('selected');

      // Mostrar agendamentos do dia
      const agendamentosDia = Object.entries(agendamentosCache)
        .map(([id, ag]) => ({ id, ...ag }))
        .filter(ag => ag.dataHora.startsWith(data))
        .sort((a, b) => a.dataHora.localeCompare(b.dataHora));
      
      const dataFormatada = new Date(data + 'T00:00').toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long' 
      });

      document.getElementById('tituloAgendamentosDia').textContent = `ğŸ“… ${dataFormatada}`;
      
      const container = document.getElementById('agendamentosDia');
      
      if (agendamentosDia.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Nenhum agendamento nesta data</p>';
        return;
      }

      container.innerHTML = '';
      agendamentosDia.forEach(ag => {
        const hora = ag.dataHora.split('T')[1].substring(0, 5);
        const card = document.createElement('div');
        card.className = 'card mb-2';
        card.style.padding = '12px';
        
        const servicosTexto = ag.servicos ? 
          ag.servicos.map(s => s.nome).join(', ') : 
          ag.servico || 'N/A';
        
        const statusBadge = ag.status === 'pendente' ? 'badge-warning' :
                           ag.status === 'confirmado' ? 'badge-primary' :
                           ag.status === 'concluido' ? 'badge-success' : 'badge-danger';
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">ğŸ• ${hora} - ${servicosTexto}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">ğŸ‘¤ ${ag.clienteNome || ag.nome}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">ğŸ’° ${formatarPreco(ag.precoTotal || ag.preco)}</div>
            </div>
            <span class="badge ${statusBadge}">
              ${ag.status}
            </span>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // ===============================================
    // FUNÃ‡Ã•ES - CLIENTES
    // ===============================================

    async function carregarClientes() {
      const container = document.getElementById('listaClientes');
      container.innerHTML = '<div class="spinner"></div>';

      try {
        // Buscar todos os usuÃ¡rios
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        // Filtrar apenas clientes
        const clientes = Object.entries(usuarios)
          .filter(([uid, dados]) => dados.role === 'cliente')
          .map(([uid, dados]) => ({ uid, ...dados }));

        if (clientes.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum cliente cadastrado</p>';
          return;
        }

        container.innerHTML = '';
        
        for (const cliente of clientes) {
          // Contar agendamentos do cliente
          const agendamentosCliente = Object.values(agendamentosCache).filter(ag => ag.clienteId === cliente.uid);
          
          const card = document.createElement('div');
          card.className = 'card mb-2';
          card.innerHTML = `
            <h4>${cliente.nomeCompleto}</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
              <div>
                <strong>ğŸ“§ Email:</strong><br>${cliente.email}
              </div>
              <div>
                <strong>ğŸ“ Telefone:</strong><br>${cliente.telefone || 'NÃ£o informado'}
              </div>
              <div>
                <strong>ğŸ“… Agendamentos:</strong><br>${agendamentosCliente.length} total(s)
              </div>
              <div>
                <strong>ğŸ“† Cadastro:</strong><br>${new Date(cliente.criadoEm).toLocaleDateString('pt-BR')}
              </div>
            </div>
          `;
          container.appendChild(card);
        }
        
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar clientes</p>';
      }
    }

    // ===============================================
    // FUNÃ‡Ã•ES - USUÃRIOS
    // ===============================================

    async function carregarUsuarios() {
      const container = document.getElementById('listaUsuarios');
      container.innerHTML = '<div class="spinner"></div>';

      try {
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        const usuariosArray = Object.entries(usuarios).map(([uid, dados]) => ({ uid, ...dados }));

        if (usuariosArray.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Nenhum usuÃ¡rio cadastrado</p>';
          return;
        }

        container.innerHTML = '';
        
        usuariosArray.forEach(usuario => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          
          const isAdmin = usuario.role === 'admin';
          const roleBadge = isAdmin ? 'badge-danger' : 'badge-primary';
          
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
              <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <h4 style="margin: 0;">${usuario.nomeCompleto}</h4>
                  <span class="badge ${roleBadge}">
                    ${isAdmin ? 'ğŸ‘‘ Admin' : 'ğŸ‘¤ Cliente'}
                  </span>
                </div>
                <div style="color: var(--text-secondary); font-size: 14px;">
                  <div>ğŸ“§ ${usuario.email}</div>
                  <div>ğŸ“ ${usuario.telefone || 'NÃ£o informado'}</div>
                  <div>ğŸ“† Cadastro: ${new Date(usuario.criadoEm).toLocaleDateString('pt-BR')}</div>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-sm btn-primary" onclick="abrirModalEditarRole('${usuario.uid}', '${usuario.nomeCompleto}', '${usuario.role}')">
                  âœï¸ Editar Role
                </button>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
        
      } catch (error) {
        console.error('Erro ao carregar usuÃ¡rios:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar usuÃ¡rios</p>';
      }
    }

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'index.html';
      });
    }
  </script>
</body>

</html>