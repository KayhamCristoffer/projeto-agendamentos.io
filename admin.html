<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Sistema de Agendamentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  
  <!-- Navbar -->
  <nav class="bg-white dark:bg-gray-800 shadow-lg fixed w-full top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">üõ†Ô∏è</span>
          <span class="text-xl font-bold text-gray-900 dark:text-white">Painel Admin</span>
        </div>
        <div class="flex items-center space-x-4">
          <span id="nomeAdmin" class="text-gray-600 dark:text-gray-300 text-sm hidden md:block"></span>
          <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <span id="themeIcon" class="text-xl">üåô</span>
          </button>
          <a href="cliente.html" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition text-sm">
            üë§ √Årea Cliente
          </a>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
            Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="pt-20 pb-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
    
    <!-- Estat√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalAgendamentos" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Total</div>
      </div>
      <div class="bg-gradient-to-br from-yellow-500 to-orange-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalPendentes" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Pendentes</div>
      </div>
      <div class="bg-gradient-to-br from-blue-500 to-cyan-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalConfirmados" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Confirmados</div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-teal-600 text-white p-6 rounded-lg shadow-lg text-center">
        <div id="totalConcluidos" class="text-4xl font-bold mb-1">0</div>
        <div class="text-sm opacity-90">Conclu√≠dos</div>
      </div>
    </div>

    <!-- Bot√£o Novo Agendamento -->
    <div class="mb-6">
      <button onclick="abrirModalNovoAgendamento()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition transform hover:scale-105">
        ‚ûï Novo Agendamento
      </button>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-6 overflow-x-auto border-b-2 border-gray-200 dark:border-gray-700">
      <button onclick="mostrarTab('calendario')" id="tabCalendario" class="px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap">
        üìÖ Calend√°rio
      </button>
      <button onclick="mostrarTab('usuarios')" id="tabUsuarios" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üë• Usu√°rios
      </button>
      <button onclick="mostrarTab('clientes')" id="tabClientes" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üë• Gerenciar Clientes
      </button>
      <button onclick="mostrarTab('equipe')" id="tabEquipe" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üë• Equipe
      </button>
      <button onclick="mostrarTab('pendentes')" id="tabPendentes" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ‚è≥ Pendentes
      </button>
      <button onclick="mostrarTab('confirmados')" id="tabConfirmados" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ‚úÖ Confirmados
      </button>
      <button onclick="mostrarTab('concluidos')" id="tabConcluidos" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üéâ Conclu√≠dos
      </button>
    </div>

    <!-- Se√ß√£o: Calend√°rio -->
    <div id="secaoCalendario">
      <div class="grid md:grid-cols-2 gap-6">
        <!-- Calend√°rio -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white">üìÖ Calend√°rio</h2>
            <button onclick="carregarCalendario()" class="bg-primary hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition">
              üîÑ Atualizar
            </button>
          </div>
          <div class="flex justify-between items-center mb-4">
            <button onclick="mesAnterior()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">‚Üê</button>
            <h3 id="mesAno" class="font-semibold text-gray-900 dark:text-white"></h3>
            <button onclick="proximoMes()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">‚Üí</button>
          </div>
          <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">
            <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>S√°b</div>
          </div>
          <div id="diasCalendario" class="grid grid-cols-7 gap-1"></div>
        </div>

        <!-- Agendamentos do Dia -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div class="flex justify-between items-center mb-4">
            <h2 id="tituloAgendamentosDia" class="text-xl font-bold text-gray-900 dark:text-white">üìã Selecione uma data</h2>
            <button onclick="abrirModalNovoAgendamento()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition">
              ‚ûï Novo
            </button>
          </div>
          <div id="agendamentosDia" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Usu√°rios -->
    <div id="secaoUsuarios" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">üë• Usu√°rios Cadastrados</h2>
        <button onclick="carregarUsuarios()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          üîÑ Atualizar
        </button>
      </div>
      <div id="listaUsuarios" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Pendentes -->
    <div id="secaoPendentes" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">‚è≥ Agendamentos Pendentes</h2>
        <button onclick="carregarPendentes()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          üîÑ Atualizar
        </button>
      </div>
      <div id="listaPendentes" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Confirmados -->
    <div id="secaoConfirmados" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">‚úÖ Agendamentos Confirmados</h2>
        <button onclick="carregarConfirmados()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          üîÑ Atualizar
        </button>
      </div>
      <div id="listaConfirmados" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Conclu√≠dos -->
    <div id="secaoConcluidos" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">üéâ Agendamentos Conclu√≠dos</h2>
        <button onclick="carregarConcluidos()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          üîÑ Atualizar
        </button>
      </div>
      <div id="listaConcluidos" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Gerenciar Clientes -->
    <div id="secaoClientes" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">üë• Gerenciar Clientes</h2>
      <button onclick="carregarClientesAdmin()" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
        üîÑ Atualizar
      </button>
    </div>
    <div id="listaClientesAdmin" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Equipe -->
    <div id="secaoEquipe" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">üë• Nossa Equipe</h2>
      <button onclick="abrirModalAdicionarMembro()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
        ‚ûï Adicionar Membro
      </button>
    </div>
    <div id="listaEquipeAdmin" class="grid md:grid-cols-3 gap-4"></div>
    </div>
  </div>

  <!-- Modal Novo Agendamento -->
  <div id="modalNovoAgendamento" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white">‚ûï Novo Agendamento</h3>
        <button onclick="fecharModalNovoAgendamento()" class="text-2xl hover:text-gray-600">&times;</button>
      </div>
      <form id="formNovoAgendamentoAdmin" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Cliente</label>
          <select id="clienteNovoAgendamento" required class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white">
            <option value="">Selecione o cliente</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Servi√ßos</label>
          <div id="gridServicosNovoAgendamento" class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div id="resumoServicosNovoAgendamento" class="hidden p-4 bg-blue-50 dark:bg-blue-900 rounded-lg"></div>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">Data</label>
            <input type="date" id="dataNovoAgendamento" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
          </div>
          <div id="containerHorarioNovo" class="hidden">
            <label class="block text-sm font-medium mb-2">Hor√°rio</label>
            <select id="horarioNovoAgendamento" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Observa√ß√µes</label>
          <textarea id="observacoesNovoAgendamento" rows="3" class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <button type="submit" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
          ‚úÖ Criar Agendamento
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Alterar Senha -->
  <div id="modalAlterarSenha" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">üîí Alterar Senha do Usu√°rio</h3>
      <p id="usuarioAlterarSenha" class="mb-4 text-gray-600 dark:text-gray-400"></p>
      <p class="text-sm text-gray-500 dark:text-gray-500 mb-4">
        Ser√° enviado um email de recupera√ß√£o de senha para o usu√°rio.
      </p>
      <div class="flex gap-2">
        <button onclick="enviarEmailRecuperacao()" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          üìß Enviar Email
        </button>
        <button onclick="fecharModalAlterarSenha()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Adicionar Membro Equipe -->
  <div id="modalAdicionarMembro" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">‚ûï Adicionar Membro</h3>
      <form id="formAdicionarMembro" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Nome</label>
          <input type="text" id="nomeMembro" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Cargo</label>
          <input type="text" id="cargoMembro" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Bio</label>
          <textarea id="bioMembro" rows="3" required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">URL da Foto</label>
          <input type="url" id="fotoMembro" placeholder="https://..." required class="w-full px-4 py-2 border rounded-lg dark:bg-gray-700 dark:text-white">
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
            ‚úÖ Adicionar
          </button>
          <button type="button" onclick="fecharModalAdicionarMembro()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="modalChat" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
      <div class="bg-primary text-white p-4 rounded-t-lg flex justify-between items-center">
        <span id="chatTitulo" class="font-bold">üí¨ Chat com Cliente</span>
        <div class="flex items-center gap-2">
          <button onclick="carregarMensagens()" class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition">
            üîÑ Atualizar
          </button>
          <button onclick="fecharChat()" class="text-2xl hover:text-gray-200">&times;</button>
        </div>
      </div>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 dark:bg-gray-900"></div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." 
               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <button onclick="enviarMensagemChat()" class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
          üì§
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modalEditar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">‚úèÔ∏è Editar Agendamento</h3>
      <form id="formEditar" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
          <input type="date" id="editarData" required
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hor√°rio</label>
          <input type="time" id="editarHora" required
                 class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
          <select id="editarStatus" required
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            <option value="pendente">Pendente</option>
            <option value="confirmado">Confirmado</option>
            <option value="concluido">Conclu√≠do</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
            üíæ Salvar
          </button>
          <button type="button" onclick="fecharModalEditar()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/correcoes.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let adminAtual = null;
    let chatAgendamentoId = null;
    let chatListener = null;
    let editandoAgendamentoId = null;
    let mesAtual = new Date().getMonth();
    let anoAtual = new Date().getFullYear();
    let dataSelecionada = null;

    // Verificar autentica√ß√£o e permiss√£o
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      
      const perfil = await obterPerfilUsuario(user.uid);
      if (!perfil || perfil.role !== 'admin') {
        window.location.href = 'cliente.html';
        return;
      }
      
      adminAtual = user;
      document.getElementById('nomeAdmin').textContent = user.displayName || user.email;
      
      await atualizarEstatisticas();
      await carregarCalendario();
      await carregarUsuarios();
    });

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    // Alternar tabs
    function mostrarTab(tab) {
      ['calendario', 'usuarios', 'clientes', 'equipe', 'pendentes', 'confirmados', 'concluidos'].forEach(t => {
        const secao = document.getElementById(`secao${t.charAt(0).toUpperCase() + t.slice(1)}`);
        if (secao) secao.classList.add('hidden');
        const tabBtn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`);
        if (tabBtn) tabBtn.className = 'px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap';
      });
      
      const secaoAtiva = document.getElementById(`secao${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (secaoAtiva) secaoAtiva.classList.remove('hidden');
      const tabAtiva = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
      if (tabAtiva) tabAtiva.className = 'px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap';
      
      // Carregar dados da se√ß√£o
      if (tab === 'pendentes') carregarPendentes();
      else if (tab === 'confirmados') carregarConfirmados();
      else if (tab === 'concluidos') carregarConcluidos();
      else if (tab === 'usuarios') carregarUsuarios();
      else if (tab === 'clientes') carregarClientesAdmin();
      else if (tab === 'equipe') carregarEquipeAdmin();
    }

    // Atualizar estat√≠sticas
    async function atualizarEstatisticas() {
      try {
        const agendamentos = await listarAgendamentosOnce();
        const todos = Object.values(agendamentos || {});
        
        document.getElementById('totalAgendamentos').textContent = todos.length;
        document.getElementById('totalPendentes').textContent = todos.filter(a => a.status === 'pendente').length;
        document.getElementById('totalConfirmados').textContent = todos.filter(a => a.status === 'confirmado').length;
        document.getElementById('totalConcluidos').textContent = todos.filter(a => a.status === 'concluido').length;
      } catch (error) {
        console.error('Erro ao atualizar estat√≠sticas:', error);
      }
    }

    // Calend√°rio
    function mesAnterior() {
      if (mesAtual === 0) {
        mesAtual = 11;
        anoAtual--;
      } else {
        mesAtual--;
      }
      carregarCalendario();
    }

    function proximoMes() {
      if (mesAtual === 11) {
        mesAtual = 0;
        anoAtual++;
      } else {
        mesAtual++;
      }
      carregarCalendario();
    }

    async function carregarCalendario() {
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      document.getElementById('mesAno').textContent = `${meses[mesAtual]} ${anoAtual}`;
      
      const primeiroDia = new Date(anoAtual, mesAtual, 1).getDay();
      const ultimoDia = new Date(anoAtual, mesAtual + 1, 0).getDate();
      
      const container = document.getElementById('diasCalendario');
      container.innerHTML = '';
      
      // Dias vazios
      for (let i = 0; i < primeiroDia; i++) {
        container.innerHTML += '<div class="p-2"></div>';
      }
      
      // Carregar agendamentos do m√™s
      const agendamentos = await listarAgendamentosOnce();
      const agendamentosDoMes = Object.entries(agendamentos || {}).filter(([id, a]) => {
        const data = new Date(a.dataHora);
        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
      });
      
      // Dias do m√™s
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const data = new Date(anoAtual, mesAtual, dia);
        const dataStr = data.toISOString().split('T')[0];
        const agendamentosNoDia = agendamentosDoMes.filter(([id, a]) => a.dataHora.startsWith(dataStr));
        
        const hoje = new Date();
        const ehHoje = dia === hoje.getDate() && mesAtual === hoje.getMonth() && anoAtual === hoje.getFullYear();
        
        container.innerHTML += `
          <div onclick="selecionarDia('${dataStr}')" 
               class="p-2 text-center cursor-pointer rounded hover:bg-primary hover:text-white transition ${ehHoje ? 'bg-primary text-white font-bold' : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'}">
            <div class="text-sm">${dia}</div>
            ${agendamentosNoDia.length > 0 ? `<div class="text-xs mt-1">‚óè</div>` : ''}
          </div>
        `;
      }
    }

    async function selecionarDia(data) {
      dataSelecionada = data;
      const dataFormatada = new Date(data + 'T00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
      document.getElementById('tituloAgendamentosDia').textContent = `üìã ${dataFormatada}`;
      
      const container = document.getElementById('agendamentosDia');
      container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const agendamentosNoDia = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.dataHora.startsWith(data))
          .sort((a, b) => a[1].dataHora.localeCompare(b[1].dataHora));
        
        if (agendamentosNoDia.length === 0) {
          container.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento neste dia</div>';
          return;
        }
        
        container.innerHTML = agendamentosNoDia.map(([id, a]) => `
          <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded border-l-4 ${getStatusColor(a.status)}">
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-semibold text-gray-900 dark:text-white">${a.clienteNome}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} ‚Ä¢ ${a.duracaoTotal} min
                </p>
              </div>
              <span class="text-xs px-2 py-1 rounded ${getStatusBadge(a.status)}">
                ${getStatusText(a.status)}
              </span>
            </div>
            <div class="flex gap-2 mt-2">
              <button onclick="abrirChat('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs transition">
                üí¨ Chat
              </button>
              <button onclick="abrirModalEditar('${id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-1 rounded text-xs transition">
                ‚úèÔ∏è
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        container.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    // Carregar usu√°rios
    async function carregarUsuarios() {
      const lista = document.getElementById('listaUsuarios');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        const usuariosArray = Object.entries(usuarios);
        
        if (usuariosArray.length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum usu√°rio cadastrado</div>';
          return;
        }
        
        lista.innerHTML = usuariosArray.map(([id, u]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">${u.nome}</h3>
                <p class="text-gray-600 dark:text-gray-400">${u.email}</p>
                <p class="text-sm text-gray-500 dark:text-gray-500">${u.telefone || 'Sem telefone'}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-semibold ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                ${u.role === 'admin' ? 'üëë Admin' : 'üë§ Cliente'}
              </span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-500 mt-2">
              Cadastrado em: ${new Date(u.criadoEm).toLocaleDateString('pt-BR')}
            </p>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar usu√°rios:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar usu√°rios</div>';
      }
    }

    // Carregar pendentes
    async function carregarPendentes() {
      await carregarAgendamentosPorStatus('pendente', 'listaPendentes');
    }

    async function carregarConfirmados() {
      await carregarAgendamentosPorStatus('confirmado', 'listaConfirmados');
    }

    async function carregarConcluidos() {
      await carregarAgendamentosPorStatus('concluido', 'listaConcluidos');
    }

    async function carregarAgendamentosPorStatus(status, containerId) {
      const lista = document.getElementById(containerId);
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const filtrados = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.status === status)
          .sort((a, b) => new Date(b[1].dataHora) - new Date(a[1].dataHora));
        
        if (filtrados.length === 0) {
          lista.innerHTML = `<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento ${status}</div>`;
          return;
        }
        
        lista.innerHTML = filtrados.map(([id, a]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">${a.clienteNome}</h3>
                <p class="text-gray-600 dark:text-gray-400">${a.clienteEmail}</p>
                <p class="text-sm text-gray-500 dark:text-gray-500 mt-2">
                  ${new Date(a.dataHora).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })} √†s 
                  ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}
                </p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-primary">${formatarPreco(a.precoTotal)}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${a.duracaoTotal} min</div>
              </div>
            </div>
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Servi√ßos:</p>
              <div class="flex flex-wrap gap-2">
                ${(a.servicos || []).map(s => `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm">${s.nome}</span>`).join('')}
              </div>
            </div>
            ${a.observacoes ? `<p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Obs: ${a.observacoes}</p>` : ''}
            <div class="flex gap-2">
              <button onclick="abrirChat('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                üí¨ Chat
              </button>
              <button onclick="abrirModalEditar('${id}')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                ‚úèÔ∏è Editar
              </button>
              ${status === 'pendente' ? `
                <button onclick="confirmarAgendamento('${id}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition">
                  ‚úÖ Confirmar
                </button>
              ` : ''}
              ${status === 'confirmado' ? `
                <button onclick="concluirAgendamento('${id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
                  üéâ Concluir
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    // A√ß√µes de agendamento
    async function confirmarAgendamento(id) {
      try {
        await alterarStatusAgendamento(id, 'confirmado');
        await atualizarEstatisticas();
        await carregarPendentes();
        alert('Agendamento confirmado com sucesso!');
      } catch (error) {
        console.error('Erro ao confirmar:', error);
        alert('Erro ao confirmar agendamento. Tente novamente.');
      }
    }

    async function concluirAgendamento(id) {
      try {
        await alterarStatusAgendamento(id, 'concluido');
        await atualizarEstatisticas();
        await carregarConfirmados();
        alert('Agendamento conclu√≠do com sucesso!');
      } catch (error) {
        console.error('Erro ao concluir:', error);
        alert('Erro ao concluir agendamento. Tente novamente.');
      }
    }

    // Modal de edi√ß√£o
    function abrirModalEditar(id) {
      editandoAgendamentoId = id;
      obterAgendamento(id).then(agendamento => {
        const [data, hora] = agendamento.dataHora.split('T');
        document.getElementById('editarData').value = data;
        document.getElementById('editarHora').value = hora;
        document.getElementById('editarStatus').value = agendamento.status;
        document.getElementById('modalEditar').classList.remove('hidden');
      });
    }

    function fecharModalEditar() {
      document.getElementById('modalEditar').classList.add('hidden');
      editandoAgendamentoId = null;
    }

    document.getElementById('formEditar').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = document.getElementById('editarData').value;
      const hora = document.getElementById('editarHora').value;
      const status = document.getElementById('editarStatus').value;
      
      try {
        await atualizarAgendamento(editandoAgendamentoId, {
          dataHora: `${data}T${hora}`,
          status: status
        });
        
        fecharModalEditar();
        await atualizarEstatisticas();
        await carregarCalendario();
        if (dataSelecionada) await selecionarDia(dataSelecionada);
        alert('Agendamento atualizado com sucesso!');
      } catch (error) {
        console.error('Erro ao atualizar:', error);
        alert('Erro ao atualizar agendamento. Tente novamente.');
      }
    });

    // Chat
    function abrirChat(agendamentoId) {
      chatAgendamentoId = agendamentoId;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagens();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      if (chatListener) chatListener();
      chatAgendamentoId = null;
    }

    function carregarMensagens() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      chatListener = listarMensagens(chatAgendamentoId, (mensagens) => {
        if (!mensagens || Object.keys(mensagens).length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Nenhuma mensagem ainda</div>';
          return;
        }
        
        const msgs = Object.values(mensagens).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        container.innerHTML = msgs.map(m => {
          const isAdmin = m.userId === adminAtual.uid;
          const nome = m.nome || 'Usu√°rio';
          const texto = m.texto || '';
          const data = m.timestamp ? new Date(m.timestamp) : new Date();
          const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          
          return `
            <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
              <div class="max-w-xs px-4 py-2 rounded-lg ${isAdmin ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'}">
                <p class="text-xs font-semibold mb-1">${nome}</p>
                <p>${texto}</p>
                <p class="text-xs opacity-75 mt-1">${horaFormatada}</p>
              </div>
            </div>
          `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const texto = input.value.trim();
      if (!texto) return;
      
      try {
        await enviarMensagem(chatAgendamentoId, {
          userId: adminAtual.uid,
          nome: 'Admin',
          texto: texto,
          timestamp: Date.now()
        });
        input.value = '';
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem. Tente novamente.');
      }
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarMensagemChat();
    });

    // Gerenciar Clientes
    async function carregarClientesAdmin() {
      const lista = document.getElementById('listaClientesAdmin');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        lista.innerHTML = Object.entries(usuarios).map(([id, u]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">${u.nome || u.nomeCompleto || 'Sem nome'}</h3>
                <p class="text-gray-600 dark:text-gray-400">${u.email}</p>
                <p class="text-sm text-gray-500">${u.telefone || 'Sem telefone'}</p>
                <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">
                  ${u.role === 'admin' ? 'üëë Admin' : 'üë§ Cliente'}
                </span>
              </div>
              <button onclick="modalAlterarSenhaUsuario('${id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition">
                üîí Alterar Senha
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar clientes</div>';
      }
    }

    let usuarioIdSenha = null;
    function modalAlterarSenhaUsuario(userId) {
      usuarioIdSenha = userId;
      obterPerfilUsuario(userId).then(perfil => {
        document.getElementById('usuarioAlterarSenha').textContent = 
          `Usu√°rio: ${perfil.nome || perfil.nomeCompleto || 'Sem nome'} (${perfil.email})`;
        document.getElementById('modalAlterarSenha').classList.remove('hidden');
      });
    }

    function fecharModalAlterarSenha() {
      document.getElementById('modalAlterarSenha').classList.add('hidden');
      usuarioIdSenha = null;
    }

    async function enviarEmailRecuperacao() {
      try {
        const perfil = await obterPerfilUsuario(usuarioIdSenha);
        await firebase.auth().sendPasswordResetEmail(perfil.email);
        alert('Email de recupera√ß√£o enviado com sucesso!');
        fecharModalAlterarSenha();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao enviar email de recupera√ß√£o.');
      }
    }

    // Equipe Admin
    async function carregarEquipeAdmin() {
      const lista = document.getElementById('listaEquipeAdmin');
      try {
        const equipe = await listarEquipe();
        
        if (!equipe || Object.keys(equipe).length === 0) {
          lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Nenhum membro cadastrado</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(equipe).map(([id, m]) => `
          <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
            <img src="${m.foto}" class="w-32 h-32 rounded-full mx-auto mb-3 object-cover">
            <h4 class="text-center font-bold text-lg text-gray-900 dark:text-white">${m.nome}</h4>
            <p class="text-center text-sm text-primary">${m.cargo}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${m.bio}</p>
            <div class="flex justify-between items-center mt-4">
              <span class="text-sm">‚ù§Ô∏è ${m.curtidas || 0} curtidas</span>
              <div class="flex gap-2">
                <button onclick="editarMembro('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                  ‚úèÔ∏è
                </button>
                <button onclick="deletarMembro('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar equipe:', error);
        lista.innerHTML = '<div class="col-span-3 text-center py-8 text-red-600">Erro ao carregar equipe</div>';
      }
    }

    function abrirModalAdicionarMembro() {
      document.getElementById('modalAdicionarMembro').classList.remove('hidden');
    }

    function fecharModalAdicionarMembro() {
      document.getElementById('modalAdicionarMembro').classList.add('hidden');
      document.getElementById('formAdicionarMembro').reset();
    }

    document.getElementById('formAdicionarMembro').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const editId = form.dataset.editId;
      
      const dados = {
        nome: document.getElementById('nomeMembro').value,
        cargo: document.getElementById('cargoMembro').value,
        bio: document.getElementById('bioMembro').value,
        foto: document.getElementById('fotoMembro').value
      };
      
      try {
        if (editId) {
          // Atualizar membro existente
          await atualizarMembroEquipe(editId, dados);
          alert('Membro atualizado com sucesso!');
          delete form.dataset.editId;
        } else {
          // Adicionar novo membro
          await adicionarMembroEquipe(dados);
          alert('Membro adicionado com sucesso!');
        }
        fecharModalAdicionarMembro();
        await carregarEquipeAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar membro.');
      }
    });
        alert('Erro ao adicionar membro.');
      }
    });

    async function editarMembro(id) {
      try {
        const equipe = await listarEquipe();
        const membro = equipe[id];
        if (!membro) return;
        
        // Preencher o formul√°rio com os dados do membro
        document.getElementById('nomeMembro').value = membro.nome || '';
        document.getElementById('cargoMembro').value = membro.cargo || '';
        document.getElementById('bioMembro').value = membro.bio || '';
        document.getElementById('fotoMembro').value = membro.foto || '';
        
        // Abrir modal
        document.getElementById('modalAdicionarMembro').classList.remove('hidden');
        
        // Alterar comportamento do submit para atualizar ao inv√©s de adicionar
        const form = document.getElementById('formAdicionarMembro');
        form.dataset.editId = id;
      } catch (error) {
        console.error('Erro ao editar membro:', error);
        alert('Erro ao carregar dados do membro.');
      }
    }

    async function deletarMembro(id) {
      if (!confirm('Deseja realmente deletar este membro?')) return;
      try {
        await deletarMembroEquipe(id);
        alert('Membro deletado!');
        await carregarEquipeAdmin();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao deletar membro.');
      }
    }

    // Novo Agendamento Admin
    let servicosSelecionadosNovo = [];
    
    function abrirModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.remove('hidden');
      carregarClientesSelect();
      carregarServicosNovo();
    }

    function fecharModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.add('hidden');
      document.getElementById('formNovoAgendamentoAdmin').reset();
      servicosSelecionadosNovo = [];
    }

    async function carregarClientesSelect() {
      const select = document.getElementById('clienteNovoAgendamento');
      try {
        const snapshot = await firebase.database().ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        select.innerHTML = '<option value="">Selecione o cliente</option>' + 
          Object.entries(usuarios)
            .filter(([id, u]) => u.role === 'cliente')
            .map(([id, u]) => `<option value="${id}">${u.nome || u.nomeCompleto} (${u.email})</option>`)
            .join('');
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
      }
    }

    function carregarServicosNovo() {
      const grid = document.getElementById('gridServicosNovoAgendamento');
      grid.innerHTML = window.SERVICOS.map(s => `
        <div onclick="toggleServicoNovo('${s.id}')" id="servico-novo-${s.id}" 
             class="cursor-pointer p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition">
          <div class="flex items-center gap-2 mb-1">
            <input type="checkbox" id="check-novo-${s.id}" class="pointer-events-none">
            <span class="text-lg">${s.icone}</span>
          </div>
          <p class="text-sm font-semibold">${s.nome}</p>
          <p class="text-xs text-primary">${formatarPreco(s.preco)}</p>
        </div>
      `).join('');
    }

    function toggleServicoNovo(id) {
      const servico = window.SERVICOS.find(s => s.id === id);
      const index = servicosSelecionadosNovo.findIndex(s => s.id === id);
      const card = document.getElementById(`servico-novo-${id}`);
      const check = document.getElementById(`check-novo-${id}`);
      
      if (index > -1) {
        servicosSelecionadosNovo.splice(index, 1);
        card.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = false;
      } else {
        servicosSelecionadosNovo.push(servico);
        card.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = true;
      }
      
      atualizarResumoNovo();
    }

    function atualizarResumoNovo() {
      const resumo = document.getElementById('resumoServicosNovoAgendamento');
      if (servicosSelecionadosNovo.length === 0) {
        resumo.classList.add('hidden');
        document.getElementById('containerHorarioNovo').classList.add('hidden');
        return;
      }
      
      const totalPreco = servicosSelecionadosNovo.reduce((sum, s) => sum + s.preco, 0);
      const totalDuracao = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
      
      resumo.classList.remove('hidden');
      resumo.innerHTML = `
        <p class="font-semibold mb-2">Servi√ßos Selecionados:</p>
        ${servicosSelecionadosNovo.map(s => `<p class="text-sm">${s.nome} - ${formatarPreco(s.preco)}</p>`).join('')}
        <div class="mt-2 pt-2 border-t border-blue-300 dark:border-blue-700">
          <div class="flex justify-between font-bold">
            <span>Total:</span>
            <span>${formatarPreco(totalPreco)} (${totalDuracao} min)</span>
          </div>
        </div>
      `;
    }

    document.getElementById('dataNovoAgendamento').addEventListener('change', async (e) => {
      const data = e.target.value;
      if (!data || servicosSelecionadosNovo.length === 0) return;
      
      const duracaoTotal = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
      const container = document.getElementById('containerHorarioNovo');
      const select = document.getElementById('horarioNovoAgendamento');
      
      container.classList.remove('hidden');
      select.innerHTML = '<option value="">Carregando...</option>';
      
      try {
        const horarios = await gerarHorariosDisponiveisCorrigidos(data, duracaoTotal);
        select.innerHTML = '<option value="">Selecione o hor√°rio</option>' +
          horarios.map(h => `<option value="${h}">${h}</option>`).join('');
      } catch (error) {
        select.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
      }
    });

    document.getElementById('formNovoAgendamentoAdmin').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const clienteId = document.getElementById('clienteNovoAgendamento').value;
      const data = document.getElementById('dataNovoAgendamento').value;
      const horario = document.getElementById('horarioNovoAgendamento').value;
      const obs = document.getElementById('observacoesNovoAgendamento').value;
      
      if (servicosSelecionadosNovo.length === 0) {
        alert('Selecione pelo menos um servi√ßo!');
        return;
      }
      
      try {
        const perfil = await obterPerfilUsuario(clienteId);
        const totalPreco = servicosSelecionadosNovo.reduce((sum, s) => sum + s.preco, 0);
        const totalDuracao = servicosSelecionadosNovo.reduce((sum, s) => sum + s.duracao, 0);
        
        await salvarAgendamento({
          clienteId: clienteId,
          clienteNome: perfil.nome || perfil.nomeCompleto,
          clienteEmail: perfil.email,
          clienteTelefone: perfil.telefone || '',
          servicos: servicosSelecionadosNovo.map(s => ({
            id: s.id,
            nome: s.nome,
            preco: s.preco,
            duracao: s.duracao
          })),
          dataHora: `${data}T${horario}`,
          duracaoTotal: totalDuracao,
          precoTotal: totalPreco,
          observacoes: obs,
          status: 'pendente',
          agendadoPor: 'admin'
        });
        
        alert('Agendamento criado com sucesso!');
        fecharModalNovoAgendamento();
        await atualizarEstatisticas();
        await carregarCalendario();
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao criar agendamento.');
      }
    });

    // Helpers
    function formatarPreco(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    function getStatusColor(status) {
      const colors = {
        'pendente': 'border-yellow-500',
        'confirmado': 'border-green-500',
        'concluido': 'border-blue-500',
        'cancelado': 'border-red-500'
      };
      return colors[status] || 'border-gray-500';
    }

    function getStatusBadge(status) {
      const badges = {
        'pendente': 'bg-yellow-100 text-yellow-800',
        'confirmado': 'bg-green-100 text-green-800',
        'concluido': 'bg-blue-100 text-blue-800',
        'cancelado': 'bg-red-100 text-red-800'
      };
      return badges[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusText(status) {
      const texts = {
        'pendente': '‚è≥ Pendente',
        'confirmado': '‚úÖ Confirmado',
        'concluido': 'üéâ Conclu√≠do',
        'cancelado': '‚ùå Cancelado'
      };
      return texts[status] || status;
    }

    // ============================================
    // FUN√á√ïES DO MODAL DE NOVO AGENDAMENTO
    // ============================================
    
    let servicosAdminSelecionados = [];
    
    async function abrirModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.remove('hidden');
      await carregarClientesParaAgendamento();
      carregarServicosParaAgendamento();
    }
    
    function fecharModalNovoAgendamento() {
      document.getElementById('modalNovoAgendamento').classList.add('hidden');
      document.getElementById('formNovoAgendamentoAdmin').reset();
      servicosAdminSelecionados = [];
      document.getElementById('resumoServicosNovoAgendamento').classList.add('hidden');
    }
    
    async function carregarClientesParaAgendamento() {
      const select = document.getElementById('clienteNovoAgendamento');
      try {
        const snapshot = await firebase.database().ref('usuarios').orderByChild('role').equalTo('cliente').once('value');
        const clientes = snapshot.val() || {};
        
        select.innerHTML = '<option value="">Selecione o cliente</option>';
        Object.entries(clientes).forEach(([id, cliente]) => {
          select.innerHTML += `<option value="${id}" data-nome="${cliente.nome}" data-email="${cliente.email}">${cliente.nome} (${cliente.email})</option>`;
        });
      } catch (error) {
        console.error('Erro ao carregar clientes:', error);
      }
    }
    
    function carregarServicosParaAgendamento() {
      const grid = document.getElementById('gridServicosNovoAgendamento');
      grid.innerHTML = window.SERVICOS.map(s => `
        <div onclick="toggleServicoAdmin('${s.id}')" id="servicoAdmin-${s.id}" 
             class="cursor-pointer p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition">
          <div class="flex justify-between items-start mb-1">
            <span class="text-xl">${s.icone}</span>
            <input type="checkbox" id="checkAdmin-${s.id}" class="pointer-events-none">
          </div>
          <h4 class="font-bold text-sm text-gray-900 dark:text-white mb-1">${s.nome}</h4>
          <div class="flex justify-between text-xs">
            <span class="font-bold text-primary">${formatarPreco(s.preco)}</span>
            <span class="text-gray-600 dark:text-gray-400">${s.duracao} min</span>
          </div>
        </div>
      `).join('');
    }
    
    function toggleServicoAdmin(id) {
      const servico = window.SERVICOS.find(s => s.id === id);
      const index = servicosAdminSelecionados.findIndex(s => s.id === id);
      
      if (index > -1) {
        servicosAdminSelecionados.splice(index, 1);
        document.getElementById(`servicoAdmin-${id}`).classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        document.getElementById(`checkAdmin-${id}`).checked = false;
      } else {
        servicosAdminSelecionados.push(servico);
        document.getElementById(`servicoAdmin-${id}`).classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        document.getElementById(`checkAdmin-${id}`).checked = true;
      }
      
      atualizarResumoAdmin();
    }
    
    function atualizarResumoAdmin() {
      const resumo = document.getElementById('resumoServicosNovoAgendamento');
      
      if (servicosAdminSelecionados.length === 0) {
        resumo.classList.add('hidden');
        document.getElementById('containerHorarioNovo').classList.add('hidden');
        return;
      }
      
      const total = servicosAdminSelecionados.reduce((sum, s) => sum + s.preco, 0);
      const duracao = servicosAdminSelecionados.reduce((sum, s) => sum + s.duracao, 0);
      
      resumo.classList.remove('hidden');
      resumo.innerHTML = `
        <div class="flex justify-between items-center">
          <div>
            <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">Servi√ßos selecionados:</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">${servicosAdminSelecionados.map(s => s.nome).join(', ')}</p>
          </div>
          <div class="text-right">
            <p class="text-lg font-bold text-primary">${formatarPreco(total)}</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">${duracao} min</p>
          </div>
        </div>
      `;
    }
    
    // Event listener para data de novo agendamento
    document.addEventListener('DOMContentLoaded', () => {
      const dataInput = document.getElementById('dataNovoAgendamento');
      if (dataInput) {
        dataInput.addEventListener('change', async function() {
          if (servicosAdminSelecionados.length === 0) {
            alert('Selecione pelo menos um servi√ßo primeiro');
            this.value = '';
            return;
          }
          
          const data = this.value;
          const duracaoTotal = servicosAdminSelecionados.reduce((sum, s) => sum + s.duracao, 0);
          
          document.getElementById('containerHorarioNovo').classList.remove('hidden');
          const selectHorario = document.getElementById('horarioNovoAgendamento');
          selectHorario.innerHTML = '<option value="">Carregando hor√°rios...</option>';
          
          try {
            const agendamentos = await listarAgendamentosOnce();
            const horariosOcupados = Object.values(agendamentos || {})
              .filter(a => a.dataHora.startsWith(data) && a.status !== 'cancelado')
              .map(a => ({
                inicio: new Date(a.dataHora),
                fim: new Date(new Date(a.dataHora).getTime() + a.duracaoTotal * 60000)
              }));
            
            const slots = window.gerarSlotsHorario(data, duracaoTotal);
            const horariosDisponiveis = slots.filter(slot => {
              const inicioSlot = new Date(slot);
              const fimSlot = new Date(inicioSlot.getTime() + duracaoTotal * 60000);
              
              return !horariosOcupados.some(ocupado => 
                (inicioSlot >= ocupado.inicio && inicioSlot < ocupado.fim) ||
                (fimSlot > ocupado.inicio && fimSlot <= ocupado.fim) ||
                (inicioSlot <= ocupado.inicio && fimSlot >= ocupado.fim)
              );
            });
            
            if (horariosDisponiveis.length === 0) {
              selectHorario.innerHTML = '<option value="">Nenhum hor√°rio dispon√≠vel nesta data</option>';
            } else {
              selectHorario.innerHTML = '<option value="">Selecione o hor√°rio</option>' +
                horariosDisponiveis.map(h => {
                  const hora = new Date(h).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                  return `<option value="${h}">${hora}</option>`;
                }).join('');
            }
          } catch (error) {
            console.error('Erro ao carregar hor√°rios:', error);
            selectHorario.innerHTML = '<option value="">Erro ao carregar hor√°rios</option>';
          }
        });
      }
    });
    
    // Submiss√£o do formul√°rio de novo agendamento
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('formNovoAgendamentoAdmin');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const clienteId = document.getElementById('clienteNovoAgendamento').value;
          const clienteOption = document.getElementById('clienteNovoAgendamento').selectedOptions[0];
          const clienteNome = clienteOption.dataset.nome;
          const clienteEmail = clienteOption.dataset.email;
          const dataHora = document.getElementById('horarioNovoAgendamento').value;
          const obs = document.getElementById('observacoesNovoAgendamento').value;
          
          if (!clienteId || !dataHora || servicosAdminSelecionados.length === 0) {
            alert('Preencha todos os campos obrigat√≥rios');
            return;
          }
          
          const totalPreco = servicosAdminSelecionados.reduce((sum, s) => sum + s.preco, 0);
          const totalDuracao = servicosAdminSelecionados.reduce((sum, s) => sum + s.duracao, 0);
          
          try {
            await salvarAgendamento({
              clienteId: clienteId,
              clienteNome: clienteNome,
              clienteEmail: clienteEmail,
              servicos: servicosAdminSelecionados.map(s => ({ 
                id: s.id, 
                nome: s.nome, 
                preco: s.preco, 
                duracao: s.duracao 
              })),
              dataHora: dataHora,
              duracaoTotal: totalDuracao,
              precoTotal: totalPreco,
              observacoes: obs,
              status: 'confirmado',
              agendadoPor: 'admin'
            });
            
            alert('Agendamento criado com sucesso!');
            fecharModalNovoAgendamento();
            carregarCalendario();
            carregarConfirmados();
          } catch (error) {
            console.error('Erro ao criar agendamento:', error);
            alert('Erro ao criar agendamento. Tente novamente.');
          }
        });
      }
    });
  </script>
</body>
</html>
