<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√Årea do Cliente - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">

</head>

<body>
  <nav class="nav-bar">
    <div class="nav-container">
      <a href="#" class="nav-logo">üìÖ Agendamentos</a>
      <div style="display: flex; align-items: center; gap: 16px;">
        <span id="nomeUsuario" style="color: var(--text-secondary); font-size: 14px;"></span>
        <button class="btn btn-sm btn-ghost" onclick="logout()">Sair</button>
      </div>
    </div>
  </nav>

  <div class="container container-wide" style="margin-top: 20px;">
    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); overflow-x: auto;">
      <button class="btn btn-ghost" id="tabAgendar" onclick="mostrarSecao('agendar')" style="border-radius: 0; border-bottom: 3px solid var(--primary-color); white-space: nowrap;">
        üìÖ Agendar Novo
      </button>
      <button class="btn btn-ghost" id="tabPendentes" onclick="mostrarSecao('pendentes')" style="border-radius: 0; white-space: nowrap;">
        ‚è≥ Pendentes
      </button>
      <button class="btn btn-ghost" id="tabHistorico" onclick="mostrarSecao('historico')" style="border-radius: 0; white-space: nowrap;">
        ‚úÖ Hist√≥rico
      </button>
      <button class="btn btn-ghost" id="tabPerfil" onclick="mostrarSecao('perfil')" style="border-radius: 0; white-space: nowrap;">
        üë§ Perfil
      </button>
    </div>

    <div id="secaoAgendar" class="fade-in">
      <h3>üìÖ Agendar Novo Servi√ßo</h3>
      <p style="color: var(--text-secondary);">Selecione o(s) servi√ßo(s), a data e o hor√°rio desejados.</p>

      <form id="formAgendamento" class="mt-3">
        
        <div class="form-group">
            <h4 class="form-label mb-2">Servi√ßos Selecionados</h4>
            <div id="servicosContainer" class="services-list-grid">
                </div>
            
            <div class="flex justify-between items-center card card-light" style="padding: 12px 16px; margin-top: 16px;">
                <span style="font-weight: 600;">Dura√ß√£o Total:</span>
                <span id="totalDuracaoDisplay" class="badge badge-info">0 min</span>
                <input type="hidden" id="inputDuracaoTotal" value="0">
                
                <span style="font-weight: 600;">Pre√ßo Total:</span>
                <span id="totalPrecoDisplay" class="badge badge-success">R$ 0,00</span>
            </div>
        </div>

        <div class="form-group mt-3">
            <label class="form-label" for="agendamentoData">Data</label>
            <input 
                class="form-input" 
                type="date" 
                id="agendamentoData" 
                required
            >
        </div>
        
        <div class="form-group" id="grupoHorarios">
            <label class="form-label">Hor√°rio Dispon√≠vel (Baseado na Dura√ß√£o Total)</label>
            <div id="horariosDisponiveis" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
                <p style="grid-column: 1/-1; color: var(--text-secondary); text-align: center;">Selecione um ou mais servi√ßos e uma data.</p>
            </div>
            <input type="hidden" id="horarioSelecionado" required>
        </div>

        <div class="form-group mt-3">
            <label class="form-label" for="agendamentoObservacoes">Observa√ß√µes (Opcional)</label>
            <textarea 
                class="form-input" 
                id="agendamentoObservacoes" 
                rows="3" 
                placeholder="Ex: Prefiro tal profissional, ou tenho alergia a algo."
            ></textarea>
        </div>

        <button class="btn btn-primary btn-full mt-3" type="submit">
            Confirmar Agendamento
        </button>
      </form>
      <div id="mensagemAgendar" class="mt-2" style="display: none;"></div>
    </div>

    <div id="secaoPendentes" class="hidden">
      <h3>‚è≥ Agendamentos Pendentes</h3>
      <p style="color: var(--text-secondary);">Voc√™ pode editar ou cancelar agendamentos pendentes</p>
      <div id="listaPendentes">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="secaoHistorico" class="hidden">
      <h3>‚úÖ Hist√≥rico de Agendamentos</h3>
      <p style="color: var(--text-secondary);">Seus agendamentos conclu√≠dos</p>
      <div id="listaHistorico">
        <div class="spinner"></div>
      </div>
    </div>

    <div id="secaoPerfil" class="hidden">
      <h3>üë§ Meu Perfil</h3>
      
      <form id="formPerfil" style="max-width: 500px;">
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input class="form-input" type="text" id="perfilNomeCompleto" required>
        </div>

        <div class="form-group">
          <label class="form-label">Telefone</label>
          <input class="form-input" type="tel" id="perfilTelefone" required>
        </div>

        <div class="form-group">
          <label class="form-label">E-mail</label>
          <input class="form-input" type="email" id="perfilEmail" disabled>
        </div>

        <button type="submit" class="btn btn-primary">
          üíæ Salvar Altera√ß√µes
        </button>
      </form>

      <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);">

      <h4>üîí Alterar Senha</h4>
      <form id="formSenha" style="max-width: 500px;">
        <div class="form-group">
          <label class="form-label">Nova Senha</label>
          <input class="form-input" type="password" id="novaSenha" minlength="6">
        </div>

        <div class="form-group">
          <label class="form-label">Confirmar Nova Senha</label>
          <input class="form-input" type="password" id="confirmarSenha" minlength="6">
        </div>

        <button type="submit" class="btn btn-warning">
          üîë Alterar Senha
        </button>
      </form>

      <div id="mensagemPerfil" class="mt-2" style="display: none;"></div>
    </div>
  </div>

  <div id="modalChat" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="width: 90%; max-width: 600px;">
      <div class="chat-container">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>üí¨ Chat com a Empresa</span>
          <button onclick="fecharChat()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input form-input" id="chatInput" placeholder="Digite sua mensagem..." style="margin: 0;">
          <button class="btn btn-primary" onclick="enviarMensagemChat()">üì§</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let usuarioAtual = null;
    let perfilAtual = {}; // Armazena o perfil para n√£o precisar buscar toda hora
    let agendamentoAtualChat = null;
    let servicosSelecionados = []; // Lista de objetos de servi√ßo selecionados

    // ===============================================
    // FUN√á√ïES DE PERFIL E AUTENTICA√á√ÉO
    // ===============================================

    /**
     * Carrega os dados do perfil do Firebase e preenche o formul√°rio.
     */
    async function carregarDadosPerfil(userId) {
        // obterPerfilUsuario est√° em database.js
        const perfil = await obterPerfilUsuario(userId);
        if (perfil) {
            perfilAtual = perfil;
            
            // Atualiza o nome de exibi√ß√£o no navbar
            document.getElementById('nomeUsuario').textContent = perfil.nomeCompleto || perfil.email;
            
            // Preenche os campos do formul√°rio de perfil (se√ß√£o Perfil)
            document.getElementById('perfilNomeCompleto').value = perfil.nomeCompleto || '';
            document.getElementById('perfilTelefone').value = perfil.telefone || '';
            document.getElementById('perfilEmail').value = perfil.email || usuarioAtual.email;
        }
    }

    // Fun√ß√£o de conveni√™ncia para ser chamada ao clicar na aba Perfil
    async function carregarPerfil() {
        await carregarDadosPerfil(usuarioAtual.uid);
    }

    // Listener de Autentica√ß√£o
    firebase.auth().onAuthStateChanged(async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        usuarioAtual = user;
        
        // 1. Carrega e preenche o perfil
        await carregarDadosPerfil(user.uid); 
        
        // 2. Carrega e exibe os servi√ßos no agendamento
        carregarServicos();
        
        // 3. Configura a data m√≠nima de agendamento
        configurarDataMinima();
        
        // Garante que a primeira se√ß√£o seja exibida
        mostrarSecao('agendar');
    });

    // ===============================================
    // FUN√á√ïES DE AGENDAMENTO (MULTI-SERVI√áO)
    // ===============================================

    // Carregar servi√ßos (agora com checkboxes para multi-sele√ß√£o)
    function carregarServicos() {
        // getTodosServicos, formatarPreco e formatarDuracao v√™m de services-config.js
        const servicos = getTodosServicos();
        const container = document.getElementById('servicosContainer');
        container.innerHTML = ''; 

        servicos.forEach(servico => {
            const item = document.createElement('div');
            item.innerHTML = `
                <input 
                    type="checkbox" 
                    id="servico-${servico.id}" 
                    data-id="${servico.id}"
                    data-preco="${servico.preco}"
                    data-duracao="${servico.duracao}"
                    class="service-checkbox hidden"
                >
                <label for="servico-${servico.id}" class="card service-label">
                    <div class="service-icon">${servico.icon}</div>
                    <div class="service-details">
                        <div class="service-name">${servico.nome}</div>
                        <div class="service-description">${servico.descricao}</div>
                    </div>
                    <div class="service-price-duration">
                        <span class="badge badge-success">${formatarPreco(servico.preco)}</span>
                        <span class="badge badge-info">${formatarDuracao(servico.duracao)}</span>
                    </div>
                </label>
            `;
            container.appendChild(item);
        });

        // Adicionar listener para recalcular totais e hor√°rios
        container.addEventListener('change', () => {
            atualizarTotaisAgendamento();
            carregarHorarios(); // Recarrega hor√°rios quando a dura√ß√£o muda
        });
        atualizarTotaisAgendamento(); // Inicializa os totais
    }
    
    // Atualiza totais de pre√ßo e dura√ß√£o e a lista de servi√ßos selecionados
    function atualizarTotaisAgendamento() {
        const checkboxes = document.querySelectorAll('#servicosContainer .service-checkbox');
        let totalPreco = 0;
        let totalDuracao = 0;
        servicosSelecionados = [];

        checkboxes.forEach(checkbox => {
            const label = checkbox.nextElementSibling;

            if (checkbox.checked) {
                totalPreco += parseFloat(checkbox.dataset.preco);
                totalDuracao += parseInt(checkbox.dataset.duracao);
                servicosSelecionados.push(getServicoPorId(checkbox.dataset.id));
                label.classList.add('selected');
            } else {
                 label.classList.remove('selected');
            }
        });

        // Atualiza a interface do usu√°rio (UI)
        document.getElementById('totalPrecoDisplay').textContent = formatarPreco(totalPreco);
        document.getElementById('totalDuracaoDisplay').textContent = formatarDuracao(totalDuracao);
        
        // Atualiza o campo oculto que ser√° usado na checagem de hor√°rio
        document.getElementById('inputDuracaoTotal').value = totalDuracao;

        // Se a dura√ß√£o for 0 (nenhum servi√ßo selecionado), limpa a sele√ß√£o de hor√°rio
        if (totalDuracao === 0 && document.getElementById('agendamentoData').value) {
            document.getElementById('horariosDisponiveis').innerHTML = '<p style="grid-column: 1/-1; color: var(--text-secondary); text-align: center;">Selecione um ou mais servi√ßos.</p>';
            document.getElementById('horarioSelecionado').value = '';
        }
    }


    // Configurar data m√≠nima (m√≠nimo amanh√£)
    function configurarDataMinima() {
        const hoje = new Date();
        hoje.setDate(hoje.getDate() + 1); 
        const dataMin = hoje.toISOString().split('T')[0];
        document.getElementById('agendamentoData').min = dataMin;
    }

    // Carregar hor√°rios dispon√≠veis
    document.getElementById('agendamentoData').addEventListener('change', carregarHorarios);

    async function carregarHorarios() {
        const data = document.getElementById('agendamentoData').value;
        const duracaoTotal = parseInt(document.getElementById('inputDuracaoTotal').value);
        
        const container = document.getElementById('horariosDisponiveis');
        const grupo = document.getElementById('grupoHorarios');
        
        if (!data || duracaoTotal === 0) {
            if (duracaoTotal > 0) {
                 container.innerHTML = '<p style="grid-column: 1/-1; color: var(--text-secondary); text-align: center;">Selecione uma data para ver hor√°rios.</p>';
            }
            // N√£o faz sentido carregar se n√£o tem dura√ß√£o/data
            return;
        }

        container.innerHTML = '<div class="spinner" style="grid-column: 1/-1;"></div>';
        grupo.style.display = 'block';
        document.getElementById('horarioSelecionado').value = ''; // Limpa sele√ß√£o anterior

        try {
            // USANDO A FUN√á√ÉO CORRETA: verificarDisponibilidadeComDuracao (em database.js)
            const horariosDisponiveis = await verificarDisponibilidadeComDuracao(data, duracaoTotal);
            
            container.innerHTML = '';
            
            if (horariosDisponiveis.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; color: var(--text-secondary); text-align: center;">Nenhum hor√°rio dispon√≠vel nesta data para a dura√ß√£o selecionada.</p>';
                return;
            }

            horariosDisponiveis.forEach(horario => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-outline btn-sm';
                btn.textContent = horario;
                btn.onclick = () => selecionarHorario(horario, btn);
                container.appendChild(btn);
            });
        } catch (error) {
            console.error('Erro ao carregar hor√°rios:', error);
            container.innerHTML = '<p style="grid-column: 1/-1; color: var(--danger);">Erro ao carregar hor√°rios</p>';
        }
    }

    function selecionarHorario(horario, btn) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('#horariosDisponiveis .btn').forEach(b => {
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline');
        });
        
        // Marcar selecionado
        btn.classList.remove('btn-outline');
        btn.classList.add('btn-primary');
        document.getElementById('horarioSelecionado').value = horario;
    }

    // Enviar agendamento (Atualizado para multi-servi√ßo)
    document.getElementById('formAgendamento').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = document.getElementById('agendamentoData').value;
        const horario = document.getElementById('horarioSelecionado').value;
        const observacoes = document.getElementById('agendamentoObservacoes').value;
        const duracaoTotal = parseInt(document.getElementById('inputDuracaoTotal').value);
        const precoTotal = servicosSelecionados.reduce((sum, s) => sum + s.preco, 0);

        
        if (servicosSelecionados.length === 0) {
            mostrarMensagemAgendar('‚ùå Selecione pelo menos um servi√ßo', 'erro');
            return;
        }
        
        if (!horario) {
            mostrarMensagemAgendar('‚ùå Selecione um hor√°rio', 'erro');
            return;
        }

        const dados = {
            userId: usuarioAtual.uid,
            nomeCompleto: perfilAtual.nomeCompleto, 
            telefone: perfilAtual.telefone,
            email: perfilAtual.email,
            
            // Novos campos para multi-servi√ßo (array de objetos)
            servicos: servicosSelecionados.map(s => ({ 
                id: s.id, 
                nome: s.nome, 
                preco: s.preco, 
                duracao: s.duracao 
            })),
            precoTotal: precoTotal,
            duracaoTotal: duracaoTotal,
            
            dataHora: `${data}T${horario}`,
            observacoes: observacoes || 'Nenhuma',
            status: 'pendente'
        };

        try {
            // salvarAgendamento (em database.js)
            await salvarAgendamento(dados);
            mostrarMensagemAgendar('‚úÖ Agendamento realizado com sucesso!', 'sucesso');
            document.getElementById('formAgendamento').reset();
            document.getElementById('horariosDisponiveis').innerHTML = '';
            document.getElementById('horarioSelecionado').value = ''; 
            atualizarTotaisAgendamento(); // Limpa os totais e checkboxes
            
            setTimeout(() => mostrarSecao('pendentes'), 2000);
        } catch (error) {
            console.error('Erro:', error);
            mostrarMensagemAgendar('‚ùå Erro ao criar agendamento', 'erro');
        }
    });

    function mostrarMensagemAgendar(texto, tipo) {
        const msg = document.getElementById('mensagemAgendar');
        msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
        msg.textContent = texto;
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 5000);
    }

    // ===============================================
    // FUN√á√ïES DE EXIBI√á√ÉO E MANIPULA√á√ÉO
    // ===============================================

    // Navega√ß√£o entre se√ß√µes
    function mostrarSecao(secao) {
        // Ocultar todas
        document.getElementById('secaoAgendar').classList.add('hidden');
        document.getElementById('secaoPendentes').classList.add('hidden');
        document.getElementById('secaoHistorico').classList.add('hidden');
        document.getElementById('secaoPerfil').classList.add('hidden');

        // Remover destaque dos tabs
        document.querySelectorAll('[id^="tab"]').forEach(tab => {
            tab.style.borderBottom = 'none';
        });

        // Mostrar se√ß√£o selecionada
        if (secao === 'agendar') {
            document.getElementById('secaoAgendar').classList.remove('hidden');
            document.getElementById('tabAgendar').style.borderBottom = '3px solid var(--primary-color)';
        } else if (secao === 'pendentes') {
            document.getElementById('secaoPendentes').classList.remove('hidden');
            document.getElementById('tabPendentes').style.borderBottom = '3px solid var(--primary-color)';
            carregarPendentes();
        } else if (secao === 'historico') {
            document.getElementById('secaoHistorico').classList.remove('hidden');
            document.getElementById('tabHistorico').style.borderBottom = '3px solid var(--primary-color)';
            carregarHistorico();
        } else if (secao === 'perfil') {
            document.getElementById('secaoPerfil').classList.remove('hidden');
            document.getElementById('tabPerfil').style.borderBottom = '3px solid var(--primary-color)';
            carregarPerfil(); 
        }
    }
    
    // Carregar pendentes
    async function carregarPendentes() {
        const container = document.getElementById('listaPendentes');
        container.innerHTML = '<div class="spinner"></div>';

        try {
            const agendamentos = await listarAgendamentosPorUsuario(usuarioAtual.uid);
            const pendentes = Object.entries(agendamentos || {})
                .filter(([id, ag]) => ag.status === 'pendente')
                .map(([id, ag]) => ({ id, ...ag }));

            if (pendentes.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento pendente</p>';
                return;
            }

            container.innerHTML = '';
            pendentes.forEach(ag => {
                const card = criarCardAgendamento(ag, true);
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Erro:', error);
            container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar agendamentos</p>';
        }
    }

    // Carregar hist√≥rico
    async function carregarHistorico() {
        const container = document.getElementById('listaHistorico');
        container.innerHTML = '<div class="spinner"></div>';

        try {
            const agendamentos = await listarAgendamentosPorUsuario(usuarioAtual.uid);
            const concluidos = Object.entries(agendamentos || {})
                .filter(([id, ag]) => ag.status === 'concluido')
                .map(([id, ag]) => ({ id, ...ag }));

            if (concluidos.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento conclu√≠do</p>';
                return;
            }

            container.innerHTML = '';
            concluidos.forEach(ag => {
                const card = criarCardAgendamento(ag, false);
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Erro:', error);
            container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar hist√≥rico</p>';
        }
    }

    // Criar card de agendamento (Atualizado para multi-servi√ßo)
    function criarCardAgendamento(ag, isPendente) {
        const card = document.createElement('div');
        card.className = 'card mb-2';
        
        const data = new Date(ag.dataHora);
        const dataFormatada = data.toLocaleDateString('pt-BR');
        const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        // Mapeia o array de servi√ßos para uma lista bonita (usando a nova estrutura)
        const listaServicos = (ag.servicos || [{ nome: ag.servico || 'Servi√ßo Indefinido' }]) 
                                .map(s => `<li>${s.nome} (${formatarPreco(s.preco)})</li>`)
                                .join('');
        
        // Usa precoTotal e duracaoTotal, ou os campos antigos para compatibilidade
        const precoDisplay = formatarPreco(ag.precoTotal || ag.preco || 0);
        const duracaoDisplay = formatarDuracao(ag.duracaoTotal || ag.duracao || 0);

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span class="badge ${isPendente ? 'badge-warning' : 'badge-success'}">
                            ${isPendente ? '‚è≥ Pendente' : '‚úÖ Conclu√≠do'}
                        </span>
                    </div>
                    <h4 style="margin: 8px 0;">Servi√ßos:</h4>
                    <ul style="list-style-type: disc; margin-left: 20px; font-size: 14px; padding: 0;">
                        ${listaServicos}
                    </ul>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 8px 0;">
                        üìÖ ${dataFormatada} √†s ${horaFormatada}
                    </p>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
                        ‚è±Ô∏è Dura√ß√£o Total: ${duracaoDisplay}
                    </p>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
                        üí∞ Pre√ßo Total: ${precoDisplay}
                    </p>
                    ${ag.observacoes && ag.observacoes !== 'Nenhuma' ? `<p style="font-size: 13px; color: var(--text-tertiary); margin-top: 8px;">üí¨ ${ag.observacoes}</p>` : ''}
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${isPendente ? `
                        <button class="btn btn-sm btn-danger" onclick="cancelarAgendamento('${ag.id}')">
                            ‚ùå Cancelar
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-primary" onclick="abrirChat('${ag.id}')">
                        üí¨ Chat
                    </button>
                </div>
            </div>
        `;
        
        return card;
    }

    // Cancelar agendamento
    async function cancelarAgendamento(id) {
        if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;

        try {
            await alterarStatusAgendamento(id, 'cancelado');
            alert('‚úÖ Agendamento cancelado com sucesso!');
            carregarPendentes();
        } catch (error) {
            console.error('Erro:', error);
            alert('‚ùå Erro ao cancelar agendamento');
        }
    }

    // Chat
    function abrirChat(agendamentoId) {
        agendamentoAtualChat = agendamentoId;
        document.getElementById('modalChat').classList.remove('hidden');
        carregarMensagensChat();
    }

    function fecharChat() {
        document.getElementById('modalChat').classList.add('hidden');
        agendamentoAtualChat = null;
    }

    function carregarMensagensChat() {
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';

        // listarMensagens (em database.js)
        listarMensagens(agendamentoAtualChat, (mensagens) => {
            container.innerHTML = '';
            mensagens.forEach(msg => {
                const div = document.createElement('div');
                div.className = msg.userId === usuarioAtual.uid ? 'chat-message sent' : 'chat-message received';
                div.innerHTML = `
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${msg.userNome}</div>
                    <div>${msg.mensagem}</div>
                    <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">
                        ${new Date(msg.timestamp).toLocaleTimeString('pt-BR')}
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        });
    }

    async function enviarMensagemChat() {
        const input = document.getElementById('chatInput');
        const mensagem = input.value.trim();
        
        if (!mensagem) return;

        const perfil = await obterPerfilUsuario(usuarioAtual.uid);
        
        await enviarMensagem(agendamentoAtualChat, {
            userId: usuarioAtual.uid,
            userNome: perfil.nomeCompleto, // Corrigido para nomeCompleto
            mensagem
        });

        input.value = '';
    }

    // Salvar perfil (Atualizado para nomeCompleto)
    document.getElementById('formPerfil').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const nomeCompleto = document.getElementById('perfilNomeCompleto').value; // Usando ID corrigido
        const telefone = document.getElementById('perfilTelefone').value;
        
        const dados = {
            nomeCompleto: nomeCompleto, 
            telefone: telefone,
            email: usuarioAtual.email,
            role: 'cliente'
        };

        try {
            // atualizarPerfilUsuario (em database.js)
            await atualizarPerfilUsuario(usuarioAtual.uid, dados);
            await usuarioAtual.updateProfile({ displayName: nomeCompleto }); 
            document.getElementById('nomeUsuario').textContent = nomeCompleto; 
            mostrarMensagemPerfil('‚úÖ Perfil atualizado com sucesso!', 'sucesso');
        } catch (error) {
            console.error('Erro:', error);
            mostrarMensagemPerfil('‚ùå Erro ao atualizar perfil', 'erro');
        }
    });

    // Alterar senha
    document.getElementById('formSenha').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;

        if (novaSenha !== confirmarSenha) {
            mostrarMensagemPerfil('‚ùå As senhas n√£o coincidem', 'erro');
            return;
        }

        try {
            await usuarioAtual.updatePassword(novaSenha);
            mostrarMensagemPerfil('‚úÖ Senha alterada com sucesso!', 'sucesso');
            document.getElementById('formSenha').reset();
        } catch (error) {
            console.error('Erro:', error);
            if (error.code === 'auth/requires-recent-login') {
                mostrarMensagemPerfil('‚ùå Por seguran√ßa, fa√ßa login novamente antes de alterar a senha', 'erro');
            } else {
                mostrarMensagemPerfil('‚ùå Erro ao alterar senha', 'erro');
            }
        }
    });

    function mostrarMensagemPerfil(texto, tipo) {
        const msg = document.getElementById('mensagemPerfil');
        msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
        msg.textContent = texto;
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 5000);
    }

    // M√°scara telefone
    document.getElementById('perfilTelefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            e.target.value = value;
        }
    });

    // Logout
    function logout() {
        firebase.auth().signOut().then(() => {
            window.location.href = 'index.html';
        });
    }

    // Enter no chat
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            enviarMensagemChat();
        }
    });
  </script>
</body>
</html>