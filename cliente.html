<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√Årea do Cliente - Sistema de Agendamentos</title>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <!-- Navega√ß√£o -->
  <nav class="nav-bar">
    <div class="nav-container" style="display: flex; justify-content: space-between; align-items: center;">
      <a href="#" class="nav-logo">üìÖ Agendamentos</a>
      <div style="display: flex; align-items: center; gap: 16px;">
        <!-- Bot√£o de tema -->
        <button onclick="toggleTheme()" class="btn btn-sm btn-ghost" style="padding: 8px 12px;">
          <span id="themeIcon">üåô</span>
        </button>
        <span id="nomeUsuario" style="color: var(--text-secondary); font-size: 14px;"></span>
        <!-- Bot√£o Admin (se for admin) -->
        <a href="admin.html" id="btnAdmin" class="btn btn-sm btn-primary" style="display: none;">
          üõ†Ô∏è Admin
        </a>
        <button class="btn btn-sm btn-ghost" onclick="logout()">Sair</button>
      </div>
    </div>
  </nav>

  <!-- Container Principal -->
  <div class="container container-wide" style="margin-top: 20px;">
    <!-- Tabs de Navega√ß√£o -->
    <div class="flex gap-2 mb-3" style="border-bottom: 2px solid var(--border-color); overflow-x: auto;">
      <button class="btn btn-ghost" id="tabAgendar" onclick="mostrarSecao('agendar')"
        style="border-radius: 0; border-bottom: 3px solid var(--primary-color); white-space: nowrap;">
        üìÖ Agendar Novo
      </button>
      <button class="btn btn-ghost" id="tabPendentes" onclick="mostrarSecao('pendentes')"
        style="border-radius: 0; white-space: nowrap;">
        ‚è≥ Pendentes
      </button>
      <button class="btn btn-ghost" id="tabHistorico" onclick="mostrarSecao('historico')"
        style="border-radius: 0; white-space: nowrap;">
        ‚úÖ Hist√≥rico
      </button>
      <button class="btn btn-ghost" id="tabPerfil" onclick="mostrarSecao('perfil')"
        style="border-radius: 0; white-space: nowrap;">
        üë§ Perfil
      </button>
    </div>

    <!-- Se√ß√£o: Agendar Novo -->
    <div id="secaoAgendar" class="fade-in">
      <h3>üìÖ Novo Agendamento</h3>
      <p style="color: var(--text-secondary);">Selecione o servi√ßo e escolha data/hor√°rio dispon√≠vel</p>

      <form id="formAgendar" style="max-width: 600px;">
        <!-- Sele√ß√£o de Servi√ßo -->
        <div class="form-group">
          <label class="form-label">Servi√ßo Desejado</label>
          <select class="form-input" id="servicoSelecionado" required>
            <option value="">Selecione um servi√ßo</option>
          </select>
          <div id="infoServico" class="mt-1" style="display: none;">
            <div class="card" style="padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong id="servicoNome"></strong>
                  <p id="servicoDescricao" style="font-size: 14px; margin: 4px 0;"></p>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);" id="servicoPreco"></div>
                  <div style="font-size: 12px; color: var(--text-tertiary);" id="servicoDuracao"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sele√ß√£o de Data -->
        <div class="form-group">
          <label class="form-label">Data</label>
          <input class="form-input" type="date" id="dataAgendamento" required>
        </div>

        <!-- Hor√°rios Dispon√≠veis -->
        <div class="form-group" id="grupoHorarios" style="display: none;">
          <label class="form-label">Hor√°rio Dispon√≠vel</label>
          <div id="horariosDisponiveis"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
            <!-- Hor√°rios ser√£o inseridos aqui -->
          </div>
          <input type="hidden" id="horarioSelecionado" required>
        </div>

        <!-- Observa√ß√µes -->
        <div class="form-group">
          <label class="form-label">Observa√ß√µes (opcional)</label>
          <textarea class="form-input" id="observacoes" rows="3" placeholder="Alguma observa√ß√£o adicional?"></textarea>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
          ‚úÖ Confirmar Agendamento
        </button>
      </form>

      <div id="mensagemAgendar" class="mt-2"></div>
    </div>

    <!-- Se√ß√£o: Agendamentos Pendentes -->
    <div id="secaoPendentes" class="hidden">
      <h3>‚è≥ Agendamentos Pendentes</h3>
      <p style="color: var(--text-secondary);">Voc√™ pode editar ou cancelar agendamentos pendentes</p>

      <div id="listaPendentes">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Se√ß√£o: Hist√≥rico -->
    <div id="secaoHistorico" class="hidden">
      <h3>‚úÖ Hist√≥rico de Agendamentos</h3>
      <p style="color: var(--text-secondary);">Seus agendamentos conclu√≠dos</p>

      <div id="listaHistorico">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Se√ß√£o: Perfil -->
    <div id="secaoPerfil" class="hidden">
      <h3>üë§ Meu Perfil</h3>

      <form id="formPerfil" style="max-width: 500px;">
        <div class="form-group">
          <label class="form-label">Nome Completo</label>
          <input class="form-input" type="text" id="perfilNome" required>
        </div>

        <div class="form-group">
          <label class="form-label">Telefone</label>
          <input class="form-input" type="tel" id="perfilTelefone" required>
        </div>

        <div class="form-group">
          <label class="form-label">E-mail</label>
          <input class="form-input" type="email" id="perfilEmail" disabled>
        </div>

        <button type="submit" class="btn btn-primary">
          üíæ Salvar Altera√ß√µes
        </button>
      </form>

      <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);">

      <h4>üîí Alterar Senha</h4>
      <form id="formSenha" style="max-width: 500px;">
        <div class="form-group">
          <label class="form-label">Nova Senha</label>
          <input class="form-input" type="password" id="novaSenha" minlength="6">
        </div>

        <div class="form-group">
          <label class="form-label">Confirmar Nova Senha</label>
          <input class="form-input" type="password" id="confirmarSenha" minlength="6">
        </div>

        <button type="submit" class="btn btn-warning">
          üîë Alterar Senha
        </button>
      </form>

      <div id="mensagemPerfil" class="mt-2"></div>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="modalChat" class="hidden"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="width: 90%; max-width: 600px;">
      <div class="chat-container">
        <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>üí¨ Chat com a Empresa</span>
          <button onclick="fecharChat()"
            style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
          <input type="text" class="chat-input form-input" id="chatInput" placeholder="Digite sua mensagem..."
            style="margin: 0;">
          <button class="btn btn-primary" onclick="enviarMensagemChat()">üì§</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let usuarioAtual = null;
    let agendamentoAtualChat = null;

    // Inicializar
    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      usuarioAtual = user;
      const perfil = await obterPerfilUsuario(user.uid);

      document.getElementById('nomeUsuario').textContent = perfil?.nome || user.email;

      carregarServicos();
      configurarDataMinima();
      carregarPerfil();
    });

    // Navega√ß√£o entre se√ß√µes
    function mostrarSecao(secao) {
      // Ocultar todas
      document.getElementById('secaoAgendar').classList.add('hidden');
      document.getElementById('secaoPendentes').classList.add('hidden');
      document.getElementById('secaoHistorico').classList.add('hidden');
      document.getElementById('secaoPerfil').classList.add('hidden');

      // Remover destaque dos tabs
      document.querySelectorAll('[id^="tab"]').forEach(tab => {
        tab.style.borderBottom = 'none';
      });

      // Mostrar se√ß√£o selecionada
      if (secao === 'agendar') {
        document.getElementById('secaoAgendar').classList.remove('hidden');
        document.getElementById('tabAgendar').style.borderBottom = '3px solid var(--primary-color)';
      } else if (secao === 'pendentes') {
        document.getElementById('secaoPendentes').classList.remove('hidden');
        document.getElementById('tabPendentes').style.borderBottom = '3px solid var(--primary-color)';
        carregarPendentes();
      } else if (secao === 'historico') {
        document.getElementById('secaoHistorico').classList.remove('hidden');
        document.getElementById('tabHistorico').style.borderBottom = '3px solid var(--primary-color)';
        carregarHistorico();
      } else if (secao === 'perfil') {
        document.getElementById('secaoPerfil').classList.remove('hidden');
        document.getElementById('tabPerfil').style.borderBottom = '3px solid var(--primary-color)';
      }
    }

    // Carregar servi√ßos
    function carregarServicos() {
      const select = document.getElementById('servicoSelecionado');
      const servicos = getTodosServicos();

      servicos.forEach(servico => {
        const option = document.createElement('option');
        option.value = servico.id;
        option.textContent = `${servico.icon} ${servico.nome} - ${formatarPreco(servico.preco)}`;
        select.appendChild(option);
      });
    }

    // Mostrar info do servi√ßo
    document.getElementById('servicoSelecionado').addEventListener('change', function () {
      const servicoId = this.value;
      if (!servicoId) {
        document.getElementById('infoServico').style.display = 'none';
        return;
      }

      const servico = getServicoPorId(servicoId);
      document.getElementById('servicoNome').textContent = `${servico.icon} ${servico.nome}`;
      document.getElementById('servicoDescricao').textContent = servico.descricao;
      document.getElementById('servicoPreco').textContent = formatarPreco(servico.preco);
      document.getElementById('servicoDuracao').textContent = `‚è±Ô∏è ${formatarDuracao(servico.duracao)}`;
      document.getElementById('infoServico').style.display = 'block';

      // Recarregar hor√°rios se data j√° selecionada
      if (document.getElementById('dataAgendamento').value) {
        carregarHorarios();
      }
    });

    // Configurar data m√≠nima
    function configurarDataMinima() {
      const hoje = new Date();
      hoje.setDate(hoje.getDate() + 1); // M√≠nimo amanh√£
      const dataMin = hoje.toISOString().split('T')[0];
      document.getElementById('dataAgendamento').min = dataMin;
    }
    document.addEventListener('DOMContentLoaded', () => {
      const dataInput = document.getElementById('dataAgendamento');
      const hoje = new Date();
      hoje.setDate(hoje.getDate() + 1);
      const dataMin = hoje.toISOString().split('T')[0];
      dataInput.min = dataMin;
      dataInput.value = ''; // Limpar qualquer valor
    });
    // Carregar hor√°rios dispon√≠veis
    document.getElementById('dataAgendamento').addEventListener('change', carregarHorarios);

    async function carregarHorarios() {
      const data = document.getElementById('dataAgendamento').value;
      const servicoId = document.getElementById('servicoSelecionado').value;

      if (!data || !servicoId) return;

      const servico = getServicoPorId(servicoId);
      const container = document.getElementById('horariosDisponiveis');
      const grupo = document.getElementById('grupoHorarios');

      container.innerHTML = '<div class="spinner" style="grid-column: 1/-1;"></div>';
      grupo.style.display = 'block';

      try {
        const horariosDisponiveis = await obterHorariosDisponiveis(data, servico.duracao);

        container.innerHTML = '';

        if (horariosDisponiveis.length === 0) {
          container.innerHTML = '<p style="grid-column: 1/-1; color: var(--text-secondary); text-align: center;">Nenhum hor√°rio dispon√≠vel nesta data</p>';
          return;
        }

        horariosDisponiveis.forEach(horario => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline btn-sm';
          btn.textContent = horario;
          btn.onclick = () => selecionarHorario(horario, btn);
          container.appendChild(btn);
        });
      } catch (error) {
        console.error('Erro ao carregar hor√°rios:', error);
        container.innerHTML = '<p style="grid-column: 1/-1; color: var(--danger);">Erro ao carregar hor√°rios</p>';
      }
    }

    function selecionarHorario(horario, btn) {
      // Remover sele√ß√£o anterior
      document.querySelectorAll('#horariosDisponiveis .btn').forEach(b => {
        b.classList.remove('btn-primary');
        b.classList.add('btn-outline');
      });

      // Marcar selecionado
      btn.classList.remove('btn-outline');
      btn.classList.add('btn-primary');
      document.getElementById('horarioSelecionado').value = horario;
    }

    // Enviar agendamento
    document.getElementById('formAgendar').addEventListener('submit', async (e) => {
      e.preventDefault();

      const servicoId = document.getElementById('servicoSelecionado').value;
      const data = document.getElementById('dataAgendamento').value;
      const horario = document.getElementById('horarioSelecionado').value;
      const observacoes = document.getElementById('observacoes').value;

      if (!horario) {
        mostrarMensagemAgendar('‚ùå Selecione um hor√°rio', 'erro');
        return;
      }

      const servico = getServicoPorId(servicoId);
      const perfil = await obterPerfilUsuario(usuarioAtual.uid);

      const dados = {
        userId: usuarioAtual.uid,
        nome: perfil.nome,
        telefone: perfil.telefone,
        email: perfil.email,
        servicoId: servico.id,
        servico: servico.nome,
        preco: servico.preco,
        duracao: servico.duracao,
        dataHora: `${data}T${horario}`,
        observacoes: observacoes || 'Nenhuma',
        status: 'pendente'
      };

      try {
        await salvarAgendamento(dados);
        mostrarMensagemAgendar('‚úÖ Agendamento realizado com sucesso!', 'sucesso');
        document.getElementById('formAgendar').reset();
        document.getElementById('infoServico').style.display = 'none';
        document.getElementById('grupoHorarios').style.display = 'none';

        setTimeout(() => mostrarSecao('pendentes'), 2000);
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagemAgendar('‚ùå Erro ao criar agendamento', 'erro');
      }
    });

    function mostrarMensagemAgendar(texto, tipo) {
      const msg = document.getElementById('mensagemAgendar');
      msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
      msg.textContent = texto;
    }

    // Carregar pendentes
    async function carregarPendentes() {
      const container = document.getElementById('listaPendentes');
      container.innerHTML = '<div class="spinner"></div>';

      try {
        const agendamentos = await listarAgendamentosPorUsuario(usuarioAtual.uid);
        const pendentes = Object.entries(agendamentos || {})
          .filter(([id, ag]) => ag.status === 'pendente')
          .map(([id, ag]) => ({ id, ...ag }));

        if (pendentes.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento pendente</p>';
          return;
        }

        container.innerHTML = '';
        pendentes.forEach(ag => {
          const card = criarCardAgendamento(ag, true);
          container.appendChild(card);
        });
      } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar agendamentos</p>';
      }
    }

    // Carregar hist√≥rico
    async function carregarHistorico() {
      const container = document.getElementById('listaHistorico');
      container.innerHTML = '<div class="spinner"></div>';

      try {
        const agendamentos = await listarAgendamentosPorUsuario(usuarioAtual.uid);
        const concluidos = Object.entries(agendamentos || {})
          .filter(([id, ag]) => ag.status === 'concluido')
          .map(([id, ag]) => ({ id, ...ag }));

        if (concluidos.length === 0) {
          container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">Nenhum agendamento conclu√≠do</p>';
          return;
        }

        container.innerHTML = '';
        concluidos.forEach(ag => {
          const card = criarCardAgendamento(ag, false);
          container.appendChild(card);
        });
      } catch (error) {
        console.error('Erro:', error);
        container.innerHTML = '<p style="color: var(--danger);">Erro ao carregar hist√≥rico</p>';
      }
    }

    // Criar card de agendamento
    function criarCardAgendamento(ag, isPendente) {
      const card = document.createElement('div');
      card.className = 'card mb-2';

      const data = new Date(ag.dataHora);
      const dataFormatada = data.toLocaleDateString('pt-BR');
      const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span class="badge ${isPendente ? 'badge-warning' : 'badge-success'}">
                ${isPendente ? '‚è≥ Pendente' : '‚úÖ Conclu√≠do'}
              </span>
            </div>
            <h4 style="margin: 8px 0;">${ag.servico}</h4>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              üìÖ ${dataFormatada} √†s ${horaFormatada}
            </p>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              ‚è±Ô∏è Dura√ß√£o: ${formatarDuracao(ag.duracao)}
            </p>
            <p style="color: var(--text-secondary); font-size: 14px; margin: 4px 0;">
              üí∞ Pre√ßo: ${formatarPreco(ag.precoFinal || ag.preco)}
            </p>
            ${ag.observacoes !== 'Nenhuma' ? `<p style="font-size: 13px; color: var(--text-tertiary); margin-top: 8px;">üí¨ ${ag.observacoes}</p>` : ''}
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${isPendente ? `
              <button class="btn btn-sm btn-danger" onclick="cancelarAgendamento('${ag.id}')">
                ‚ùå Cancelar
              </button>
            ` : ''}
            <button class="btn btn-sm btn-primary" onclick="abrirChat('${ag.id}')">
              üí¨ Chat
            </button>
          </div>
        </div>
      `;

      return card;
    }

    // Cancelar agendamento
    async function cancelarAgendamento(id) {
      if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;

      try {
        await alterarStatusAgendamento(id, 'cancelado');
        alert('‚úÖ Agendamento cancelado com sucesso!');
        carregarPendentes();
      } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao cancelar agendamento');
      }
    }

    // Chat
    function abrirChat(agendamentoId) {
      agendamentoAtualChat = agendamentoId;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagensChat();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      agendamentoAtualChat = null;
    }

    function carregarMensagensChat() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';

      listarMensagens(agendamentoAtualChat, (mensagens) => {
        container.innerHTML = '';
        mensagens.forEach(msg => {
          const div = document.createElement('div');
          div.className = msg.userId === usuarioAtual.uid ? 'chat-message sent' : 'chat-message received';
          div.innerHTML = `
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${msg.userNome}</div>
            <div>${msg.mensagem}</div>
            <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">
              ${new Date(msg.timestamp).toLocaleTimeString('pt-BR')}
            </div>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const mensagem = input.value.trim();

      if (!mensagem) return;

      const perfil = await obterPerfilUsuario(usuarioAtual.uid);

      await enviarMensagem(agendamentoAtualChat, {
        userId: usuarioAtual.uid,
        userNome: perfil.nome,
        mensagem
      });

      input.value = '';
    }

    // Perfil
    async function carregarPerfil() {
      const perfil = await obterPerfilUsuario(usuarioAtual.uid);
      if (perfil) {
        document.getElementById('perfilNome').value = perfil.nome || '';
        document.getElementById('perfilTelefone').value = perfil.telefone || '';
        document.getElementById('perfilEmail').value = perfil.email || usuarioAtual.email;
      }
    }

    // Salvar perfil
    document.getElementById('formPerfil').addEventListener('submit', async (e) => {
      e.preventDefault();

      const dados = {
        nome: document.getElementById('perfilNome').value,
        telefone: document.getElementById('perfilTelefone').value,
        email: usuarioAtual.email,
        role: 'cliente'
      };

      try {
        await atualizarPerfilUsuario(usuarioAtual.uid, dados);
        await usuarioAtual.updateProfile({ displayName: dados.nome });
        mostrarMensagemPerfil('‚úÖ Perfil atualizado com sucesso!', 'sucesso');
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagemPerfil('‚ùå Erro ao atualizar perfil', 'erro');
      }
    });

    // Alterar senha
    document.getElementById('formSenha').addEventListener('submit', async (e) => {
      e.preventDefault();

      const novaSenha = document.getElementById('novaSenha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;

      if (novaSenha !== confirmarSenha) {
        mostrarMensagemPerfil('‚ùå As senhas n√£o coincidem', 'erro');
        return;
      }

      try {
        await usuarioAtual.updatePassword(novaSenha);
        mostrarMensagemPerfil('‚úÖ Senha alterada com sucesso!', 'sucesso');
        document.getElementById('formSenha').reset();
      } catch (error) {
        console.error('Erro:', error);
        if (error.code === 'auth/requires-recent-login') {
          mostrarMensagemPerfil('‚ùå Por seguran√ßa, fa√ßa login novamente antes de alterar a senha', 'erro');
        } else {
          mostrarMensagemPerfil('‚ùå Erro ao alterar senha', 'erro');
        }
      }
    });

    function mostrarMensagemPerfil(texto, tipo) {
      const msg = document.getElementById('mensagemPerfil');
      msg.className = tipo === 'sucesso' ? 'alert alert-success' : 'alert alert-error';
      msg.textContent = texto;
    }

    // M√°scara telefone
    document.getElementById('perfilTelefone').addEventListener('input', function (e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length <= 11) {
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = value;
      }
    });

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'index.html';
      });
    }

    // Enter no chat
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        enviarMensagemChat();
      }
    });
  </script>
</body>

</html>