<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√Årea do Cliente - Sistema de Agendamentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
  
  <!-- Navbar -->
  <nav class="bg-white dark:bg-gray-800 shadow-lg fixed w-full top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">üìÖ</span>
          <span class="text-xl font-bold text-gray-900 dark:text-white">√Årea do Cliente</span>
        </div>
        <div class="flex items-center space-x-4">
          <button onclick="abrirModalPerfil()" id="nomeUsuario" class="text-gray-600 dark:text-gray-300 text-sm hidden md:block hover:text-primary cursor-pointer font-semibold"></button>
          <a href="admin.html" id="btnPainelAdmin" class="hidden bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition text-sm">
            üõ†Ô∏è Painel Admin
          </a>
          <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <span id="themeIcon" class="text-xl">üåô</span>
          </button>
          <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
            Sair
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="pt-20 pb-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
    
    <!-- Tabs -->
    <div class="flex space-x-2 mb-6 overflow-x-auto border-b-2 border-gray-200 dark:border-gray-700">
      <button onclick="mostrarSecao('agendar')" id="tabAgendar" class="px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap">
        üìÖ Agendar Novo
      </button>
      <button onclick="mostrarSecao('pendentes')" id="tabPendentes" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ‚è≥ Pendentes
      </button>
      <button onclick="mostrarSecao('historico')" id="tabHistorico" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        ‚úÖ Hist√≥rico
      </button>
      <button onclick="mostrarSecao('perfil')" id="tabPerfil" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üë§ Perfil
      </button>
      <button onclick="mostrarSecao('equipe')" id="tabEquipe" class="px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap">
        üë• Equipe
      </button>
    </div>

    <!-- Se√ß√£o: Agendar Novo -->
    <div id="secaoAgendar">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">üìÖ Novo Agendamento</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-6">Selecione os servi√ßos desejados e escolha data/hor√°rio</p>
      
      <form id="formAgendar" class="space-y-6">
        <!-- Para quem √© o agendamento -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
          <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-3">Para quem √© o agendamento?</label>
          <div class="flex gap-6">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="agendadoPara" value="proprio" checked onchange="toggleNomeOutraPessoa()" 
                     class="w-4 h-4 text-primary">
              <span class="ml-2 text-gray-900 dark:text-white">Para mim</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="agendadoPara" value="terceiro" onchange="toggleNomeOutraPessoa()"
                     class="w-4 h-4 text-primary">
              <span class="ml-2 text-gray-900 dark:text-white">Para outra pessoa</span>
            </label>
          </div>
          <div id="campoNomeOutraPessoa" class="hidden mt-3">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome completo da pessoa</label>
            <input type="text" id="nomeOutraPessoa" placeholder="Digite o nome completo"
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
          </div>
        </div>

        <!-- Grid de Servi√ßos -->
        <div>
          <label class="block text-lg font-semibold text-gray-900 dark:text-white mb-3">Servi√ßos</label>
          <div id="gridServicos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Servi√ßos ser√£o carregados aqui -->
          </div>
          <div id="resumoServicos" class="mt-4 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg hidden">
            <p class="font-semibold text-gray-900 dark:text-white mb-2">Servi√ßos Selecionados:</p>
            <div id="listaServicos" class="space-y-1"></div>
            <div class="mt-3 pt-3 border-t border-blue-200 dark:border-blue-700 flex justify-between items-center">
              <span class="font-bold text-gray-900 dark:text-white">Total:</span>
              <div class="text-right">
                <div id="totalPreco" class="text-2xl font-bold text-primary"></div>
                <div id="totalDuracao" class="text-sm text-gray-600 dark:text-gray-400"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Data e Hor√°rio -->
        <div id="secaoDataHorario" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
            ‚ö†Ô∏è <strong>Selecione pelo menos um servi√ßo</strong> para escolher data e hor√°rio
          </p>
          <div class="grid md:grid-cols-2 gap-4 opacity-50 pointer-events-none" id="camposDataHora">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
              <input type="date" id="dataAgendamento" required
                     class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white">
            </div>
            <div id="containerHorario" class="hidden">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hor√°rio</label>
              <div id="gridHorarios" class="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                <!-- Hor√°rios dispon√≠veis -->
              </div>
              <input type="hidden" id="horarioSelecionado">
            </div>
          </div>
        </div>

        <!-- Produtos Opcionais -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Produtos (opcional)
            <span class="text-xs text-gray-500">Adicione produtos ao seu agendamento</span>
          </label>
          <div id="gridProdutos" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-60 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-lg p-3">
            <!-- Produtos ser√£o carregados aqui -->
          </div>
          <div id="resumoProdutos" class="mt-2 text-sm text-gray-600 dark:text-gray-400 hidden"></div>
        </div>

        <!-- Observa√ß√µes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observa√ß√µes (opcional)</label>
          <textarea id="observacoes" rows="3" placeholder="Alguma observa√ß√£o adicional?"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white"></textarea>
        </div>

        <button type="submit" class="w-full md:w-auto bg-primary hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition transform hover:scale-105">
          ‚úÖ Confirmar Agendamento
        </button>
      </form>
      <div id="mensagemAgendar" class="mt-4"></div>
    </div>

    <!-- Se√ß√£o: Pendentes -->
    <div id="secaoPendentes" class="hidden">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">‚è≥ Agendamentos Pendentes</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-6">Voc√™ pode cancelar ou entrar em contato via chat</p>
      <div id="listaPendentes" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Hist√≥rico -->
    <div id="secaoHistorico" class="hidden">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">‚úÖ Hist√≥rico de Agendamentos</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-6">Seus agendamentos conclu√≠dos</p>
      <div id="listaHistorico" class="space-y-4"></div>
    </div>

    <!-- Se√ß√£o: Perfil -->
    <div id="secaoPerfil" class="hidden">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">üë§ Meu Perfil</h2>
      
      <div class="max-w-2xl">
        <form id="formPerfil" class="space-y-4 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome Completo</label>
            <input type="text" id="perfilNome" required
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Telefone</label>
            <input type="tel" id="perfilTelefone" required maxlength="15"
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">E-mail</label>
            <input type="email" id="perfilEmail" disabled
                   class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-600 dark:text-gray-300">
          </div>
          <button type="submit" class="bg-primary hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
            üíæ Salvar Altera√ß√µes
          </button>
        </form>

        <div class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
          <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">üîí Alterar Senha</h3>
          <form id="formSenha" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nova Senha</label>
              <input type="password" id="novaSenha" minlength="6"
                     class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirmar Nova Senha</label>
              <input type="password" id="confirmaSenha" minlength="6"
                     class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition">
              üîë Atualizar Senha
            </button>
          </form>
        </div>
      </div>
      <div id="mensagemPerfil" class="mt-4"></div>
    </div>

    <!-- Se√ß√£o: Equipe -->
    <div id="secaoEquipe" class="hidden">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">üë• Nossa Equipe</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-6">Conhe√ßa os profissionais que v√£o cuidar de voc√™</p>
      <div id="listaEquipe" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>
  </div>

  <!-- Modal de Chat -->
  <div id="modalChat" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col">
      <div class="bg-primary text-white p-4 rounded-t-lg flex justify-between items-center">
        <span id="chatTitulo" class="font-bold">üí¨ Chat com Administradores</span>
        <button onclick="fecharChat()" class="text-2xl hover:text-gray-200">&times;</button>
      </div>
      <div id="chatMessages" class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 dark:bg-gray-900"></div>
      <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex gap-2">
        <input type="text" id="chatInput" placeholder="Digite sua mensagem..." 
               class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
        <button onclick="enviarMensagemChat()" class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
          üì§
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="firebase/firebase-config.js"></script>
  <script src="firebase/services-config.js"></script>
  <script src="firebase/database.js"></script>
  <script src="firebase/session-manager.js"></script>
  <script src="assets/theme.js"></script>

  <script>
    let usuarioAtual = null;
    let servicosSelecionados = [];
    let produtosSelecionados = [];
    let chatAgendamentoId = null;
    let chatListener = null;
    
    console.log('‚úÖ Vari√°veis inicializadas');
    console.log('‚úÖ Firebase dispon√≠vel:', typeof firebase !== 'undefined');
    console.log('‚úÖ Database dispon√≠vel:', typeof db !== 'undefined');

    // Verificar autentica√ß√£o
    firebase.auth().onAuthStateChanged(async (user) => {
      console.log('üîê Estado de autentica√ß√£o mudou:', user ? 'Logado' : 'N√£o logado');
      
      if (!user) {
        console.log('‚ùå Usu√°rio n√£o autenticado, redirecionando...');
        window.location.href = 'login.html';
        return;
      }
      
      usuarioAtual = user;
      console.log('‚úÖ Usu√°rio autenticado:', user.email);
      
      // Atualizar nome do usu√°rio no navbar
      const nomeElement = document.getElementById('nomeUsuario');
      if (nomeElement) {
        nomeElement.textContent = user.displayName || user.email;
        console.log('‚úÖ Nome exibido:', nomeElement.textContent);
      }
      
      // Definir data m√≠nima como hoje
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('dataAgendamento').setAttribute('min', hoje);
      console.log('‚úÖ Data m√≠nima configurada:', hoje);
      
      // Verificar se usu√°rio √© admin
      try {
        const perfilSnap = await firebase.database().ref(`usuarios/${user.uid}`).once('value');
        const perfil = perfilSnap.val();
        console.log('üë§ Perfil do usu√°rio:', perfil);
        
        if (perfil && perfil.role === 'admin') {
          document.getElementById('btnPainelAdmin').classList.remove('hidden');
          console.log('‚úÖ Bot√£o admin exibido');
        }
      } catch (error) {
        console.error('‚ùå Erro ao verificar perfil:', error);
      }
      
      // Carregar dados
      console.log('üì• Iniciando carregamento de dados...');
      try {
        await carregarServicos();
        console.log('‚úÖ Servi√ßos carregados');
      } catch (error) {
        console.error('‚ùå Erro ao carregar servi√ßos:', error);
      }
      
      try {
        await carregarProdutos();
        console.log('‚úÖ Produtos carregados');
      } catch (error) {
        console.error('‚ùå Erro ao carregar produtos:', error);
      }
      
      try {
        await carregarPendentes();
        console.log('‚úÖ Pendentes carregados');
      } catch (error) {
        console.error('‚ùå Erro ao carregar pendentes:', error);
      }
      
      try {
        await carregarHistorico();
        console.log('‚úÖ Hist√≥rico carregado');
      } catch (error) {
        console.error('‚ùå Erro ao carregar hist√≥rico:', error);
      }
      
      try {
        await carregarPerfil();
        console.log('‚úÖ Perfil carregado');
      } catch (error) {
        console.error('‚ùå Erro ao carregar perfil:', error);
      }
      
      console.log('üéâ Carregamento completo!');
    });

    // Logout
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    // Fun√ß√£o para mostrar/ocultar campo de nome para outra pessoa
    function toggleNomeOutraPessoa() {
      const agendadoPara = document.querySelector('input[name="agendadoPara"]:checked').value;
      const campoNome = document.getElementById('campoNomeOutraPessoa');
      const inputNome = document.getElementById('nomeOutraPessoa');
      
      if (agendadoPara === 'terceiro') {
        campoNome.classList.remove('hidden');
        inputNome.required = true;
      } else {
        campoNome.classList.add('hidden');
        inputNome.required = false;
        inputNome.value = '';
      }
    }

    // Alternar se√ß√µes
    function mostrarSecao(secao) {
      console.log('üîÑ Mudando para se√ß√£o:', secao);
      
      ['agendar', 'pendentes', 'historico', 'perfil', 'equipe'].forEach(s => {
        const secaoElement = document.getElementById(`secao${s.charAt(0).toUpperCase() + s.slice(1)}`);
        const tabElement = document.getElementById(`tab${s.charAt(0).toUpperCase() + s.slice(1)}`);
        
        if (secaoElement) secaoElement.classList.add('hidden');
        if (tabElement) {
          tabElement.className = 'px-6 py-3 font-semibold text-gray-600 dark:text-gray-400 hover:text-primary whitespace-nowrap';
        }
      });
      
      const secaoAtiva = document.getElementById(`secao${secao.charAt(0).toUpperCase() + secao.slice(1)}`);
      const tabAtiva = document.getElementById(`tab${secao.charAt(0).toUpperCase() + secao.slice(1)}`);
      
      if (secaoAtiva) {
        secaoAtiva.classList.remove('hidden');
        console.log('‚úÖ Se√ß√£o exibida:', secao);
      } else {
        console.error('‚ùå Se√ß√£o n√£o encontrada:', secao);
      }
      
      if (tabAtiva) {
        tabAtiva.className = 'px-6 py-3 font-semibold text-primary border-b-4 border-primary whitespace-nowrap';
      }
      
      // Carregar equipe se for a se√ß√£o de equipe
      if (secao === 'equipe') {
        console.log('üë• Carregando equipe...');
        carregarEquipe();
      }
    }

    // Fun√ß√µes Auxiliares do Firebase
    async function obterPerfilUsuario(userId) {
      const snapshot = await firebase.database().ref(`usuarios/${userId}`).once('value');
      return snapshot.val();
    }

    async function atualizarPerfilUsuario(userId, dados) {
      dados.atualizadoEm = new Date().toISOString();
      await firebase.database().ref(`usuarios/${userId}`).update(dados);
    }

    async function listarEquipe() {
      const snapshot = await firebase.database().ref('equipe').once('value');
      return snapshot.val() || {};
    }

    async function curtirMembroEquipe(membroId, usuarioId) {
      const membroRef = firebase.database().ref(`equipe/${membroId}`);
      const snapshot = await membroRef.once('value');
      const membro = snapshot.val();
      
      if (membro) {
        const curtidas = (membro.curtidas || 0) + 1;
        await membroRef.update({
          curtidas: curtidas,
          atualizadoEm: new Date().toISOString()
        });
      }
    }

    // Carregar servi√ßos do Firebase
    async function carregarServicos() {
      const grid = document.getElementById('gridServicos');
      grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-600 dark:text-gray-400">Carregando servi√ßos...</div>';
      
      try {
        // Buscar todos os servi√ßos e filtrar localmente
        const snapshot = await db.ref('servicos').once('value');
        const servicosData = snapshot.val();
        const servicos = [];
        
        if (servicosData) {
          Object.entries(servicosData).forEach(([id, data]) => {
            // Filtrar apenas servi√ßos ativos (ou sem campo ativo definido)
            if (data.ativo !== false) {
              servicos.push({
                id,
                nome: data.nome,
                descricao: data.descricao,
                preco: data.preco,
                duracao: data.duracao,
                icone: data.icone || '‚úÇÔ∏è'
              });
            }
          });
        }
        
        // Atualizar window.SERVICOS
        window.SERVICOS = servicos;
        
        console.log('Servi√ßos carregados:', servicos.length);
        
        if (servicos.length === 0) {
          grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-600 dark:text-gray-400">Nenhum servi√ßo dispon√≠vel no momento.</div>';
          return;
        }
        
        grid.innerHTML = servicos.map(s => `
          <div onclick="toggleServico('${s.id}')" id="servico-${s.id}" 
               class="cursor-pointer p-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg hover:border-primary transition">
            <div class="flex justify-between items-start mb-2">
              <div class="text-2xl">${s.icone}</div>
              <input type="checkbox" id="check-${s.id}" class="w-5 h-5 pointer-events-none">
            </div>
            <h3 class="font-bold text-gray-900 dark:text-white mb-1">${s.nome}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${s.descricao}</p>
            <div class="flex justify-between items-center text-sm">
              <span class="font-bold text-primary">${formatarPreco(s.preco)}</span>
              <span class="text-gray-600 dark:text-gray-400">${s.duracao} min</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar servi√ßos:', error);
        grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-600">Erro ao carregar servi√ßos. Por favor, recarregue a p√°gina.</div>';
      }
    }

    // Toggle servi√ßo
    function toggleServico(id) {
      console.log('üîÑ Toggle servi√ßo:', id);
      
      if (!window.SERVICOS) {
        console.error('‚ùå window.SERVICOS n√£o est√° definido');
        return;
      }
      
      const servico = window.SERVICOS.find(s => s.id === id);
      if (!servico) {
        console.error('‚ùå Servi√ßo n√£o encontrado:', id);
        return;
      }
      
      console.log('‚úÖ Servi√ßo encontrado:', servico);
      
      const index = servicosSelecionados.findIndex(s => s.id === id);
      const card = document.getElementById(`servico-${id}`);
      const check = document.getElementById(`check-${id}`);
      
      if (!card || !check) {
        console.error('‚ùå Elementos n√£o encontrados para o servi√ßo:', id);
        return;
      }
      
      if (index > -1) {
        servicosSelecionados.splice(index, 1);
        card.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        card.classList.add('border-gray-300', 'dark:border-gray-600');
        check.checked = false;
        console.log('‚ûñ Servi√ßo removido. Total:', servicosSelecionados.length);
      } else {
        servicosSelecionados.push(servico);
        card.classList.remove('border-gray-300', 'dark:border-gray-600');
        card.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = true;
        console.log('‚ûï Servi√ßo adicionado. Total:', servicosSelecionados.length);
      }
      
      atualizarResumo();
    }

    // Atualizar resumo
    function atualizarResumo() {
      const resumo = document.getElementById('resumoServicos');
      const lista = document.getElementById('listaServicos');
      const secaoDataHorario = document.getElementById('secaoDataHorario');
      const camposDataHora = document.getElementById('camposDataHora');
      
      if (servicosSelecionados.length === 0) {
        resumo.classList.add('hidden');
        // Desabilitar se√ß√£o de data/hora
        secaoDataHorario.classList.add('border-dashed', 'border-gray-300', 'dark:border-gray-600', 'bg-gray-100', 'dark:bg-gray-700');
        secaoDataHorario.classList.remove('border-primary', 'bg-white', 'dark:bg-gray-800');
        camposDataHora.classList.add('opacity-50', 'pointer-events-none');
        secaoDataHorario.querySelector('p').classList.remove('hidden');
        return;
      }
      
      // Habilitar se√ß√£o de data/hora
      secaoDataHorario.classList.remove('border-dashed', 'border-gray-300', 'dark:border-gray-600', 'bg-gray-100', 'dark:bg-gray-700');
      secaoDataHorario.classList.add('border-primary', 'bg-white', 'dark:bg-gray-800');
      camposDataHora.classList.remove('opacity-50', 'pointer-events-none');
      secaoDataHorario.querySelector('p').classList.add('hidden');
      
      resumo.classList.remove('hidden');
      lista.innerHTML = servicosSelecionados.map(s => 
        `<div class="flex justify-between text-sm">
          <span>${s.nome}</span>
          <span class="font-semibold">${formatarPreco(s.preco)}</span>
        </div>`
      ).join('');
      
      const totalPreco = servicosSelecionados.reduce((sum, s) => sum + s.preco, 0);
      const totalDuracao = servicosSelecionados.reduce((sum, s) => sum + s.duracao, 0);
      
      document.getElementById('totalPreco').textContent = formatarPreco(totalPreco);
      document.getElementById('totalDuracao').textContent = `${totalDuracao} minutos`;
    }

    // Carregar produtos do Firebase
    async function carregarProdutos() {
      try {
        // Buscar todos os produtos e filtrar localmente
        const snapshot = await db.ref('produtos').once('value');
        const produtosData = snapshot.val();
        const produtos = [];
        
        if (produtosData) {
          Object.entries(produtosData).forEach(([id, data]) => {
            // Filtrar apenas produtos ativos (ou sem campo ativo definido)
            if (data.ativo !== false) {
              produtos.push({
                id,
                nome: data.nome,
                descricao: data.descricao,
                preco: data.preco,
                estoque: data.estoque,
                icone: data.icone || 'üõçÔ∏è'
              });
            }
          });
        }
        
        console.log('Produtos carregados:', produtos.length);
        
        // Armazenar produtos globalmente
        window.PRODUTOS = produtos;
        
        const grid = document.getElementById('gridProdutos');
        if (!grid) return;
        
        if (produtos.length === 0) {
          grid.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Nenhum produto dispon√≠vel no momento.</p>';
          return;
        }
        
        grid.innerHTML = produtos.map(p => `
          <div id="produto-${p.id}" 
               class="border-2 border-gray-300 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:shadow-md transition-all"
               onclick="toggleProduto('${p.id}')">
            <div class="flex items-start gap-3">
              <span class="text-2xl">${p.icone}</span>
              <div class="flex-1">
                <h4 class="font-semibold text-gray-900 dark:text-white">${p.nome}</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${p.descricao || ''}</p>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-primary font-bold">${formatarPreco(p.preco)}</span>
                  ${p.estoque ? `<span class="text-xs text-gray-500">Estoque: ${p.estoque}</span>` : ''}
                </div>
              </div>
              <input type="checkbox" id="check-produto-${p.id}" class="w-5 h-5 pointer-events-none">
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        const grid = document.getElementById('gridProdutos');
        if (grid) {
          grid.innerHTML = '<p class="text-red-500">Erro ao carregar produtos.</p>';
        }
      }
    }

    // Toggle sele√ß√£o de produto
    function toggleProduto(produtoId) {
      const produto = window.PRODUTOS.find(p => p.id === produtoId);
      if (!produto) return;
      
      const index = produtosSelecionados.findIndex(p => p.id === produtoId);
      const card = document.getElementById(`produto-${produtoId}`);
      const check = document.getElementById(`check-produto-${produtoId}`);
      
      if (index > -1) {
        produtosSelecionados.splice(index, 1);
        card.classList.remove('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        card.classList.add('border-gray-300', 'dark:border-gray-600');
        check.checked = false;
      } else {
        produtosSelecionados.push(produto);
        card.classList.remove('border-gray-300', 'dark:border-gray-600');
        card.classList.add('border-primary', 'bg-blue-50', 'dark:bg-blue-900');
        check.checked = true;
      }
    }

    // Carregar hor√°rios dispon√≠veis
    document.getElementById('dataAgendamento').addEventListener('change', async (e) => {
      const data = e.target.value;
      if (!data || servicosSelecionados.length === 0) return;
      
      const duracao = servicosSelecionados.reduce((sum, s) => sum + s.duracao, 0);
      const container = document.getElementById('containerHorario');
      const grid = document.getElementById('gridHorarios');
      
      container.classList.remove('hidden');
      grid.innerHTML = '<div class="col-span-3 text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const horarios = await obterHorariosDisponiveis(data, duracao);
        grid.innerHTML = horarios.map(h => `
          <button type="button" onclick="selecionarHorario('${h}')" 
                  class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded hover:bg-primary hover:text-white transition text-sm">
            ${h}
          </button>
        `).join('');
      } catch (error) {
        grid.innerHTML = '<div class="col-span-3 text-center py-4 text-red-600">Erro ao carregar hor√°rios</div>';
      }
    });

    // Selecionar hor√°rio
    function selecionarHorario(horario) {
      document.querySelectorAll('#gridHorarios button').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
      });
      event.target.classList.add('bg-primary', 'text-white');
      document.getElementById('horarioSelecionado').value = horario;
    }

    // Submeter agendamento
    document.getElementById('formAgendar').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (servicosSelecionados.length === 0) {
        mostrarMensagem('erro', 'Selecione pelo menos um servi√ßo!', 'mensagemAgendar');
        return;
      }
      
      const data = document.getElementById('dataAgendamento').value;
      const horario = document.getElementById('horarioSelecionado').value;
      const obs = document.getElementById('observacoes').value;
      const agendadoPara = document.querySelector('input[name="agendadoPara"]:checked').value;
      const nomeOutraPessoa = document.getElementById('nomeOutraPessoa').value;
      
      if (!horario) {
        mostrarMensagem('erro', 'Selecione um hor√°rio!', 'mensagemAgendar');
        return;
      }
      
      if (agendadoPara === 'terceiro' && !nomeOutraPessoa) {
        mostrarMensagem('erro', 'Informe o nome da pessoa para quem o agendamento ser√° feito!', 'mensagemAgendar');
        return;
      }
      
      const dataHora = `${data}T${horario}`;
      const totalPreco = servicosSelecionados.reduce((sum, s) => sum + s.preco, 0) + 
                         produtosSelecionados.reduce((sum, p) => sum + p.preco, 0);
      const totalDuracao = servicosSelecionados.reduce((sum, s) => sum + s.duracao, 0);
      
      // Determinar o nome do cliente (pessoa para quem √© o agendamento)
      const clienteNome = agendadoPara === 'proprio' ? usuarioAtual.displayName : nomeOutraPessoa;
      
      try {
        await salvarAgendamento({
          clienteId: usuarioAtual.uid,
          clienteNome: clienteNome,
          clienteEmail: usuarioAtual.email,
          agendadoPor: usuarioAtual.displayName,
          paraQuem: agendadoPara === 'proprio' ? 'proprio' : 'terceiro',
          servicos: servicosSelecionados.map(s => ({ id: s.id, nome: s.nome, preco: s.preco, duracao: s.duracao })),
          produtos: produtosSelecionados.length > 0 ? produtosSelecionados.map(p => ({ id: p.id, nome: p.nome, preco: p.preco })) : [],
          dataHora: dataHora,
          duracaoTotal: totalDuracao,
          precoTotal: totalPreco,
          observacoes: obs,
          status: 'pendente'
        });
        
        mostrarMensagem('sucesso', 'Agendamento criado com sucesso! Aguarde a confirma√ß√£o.', 'mensagemAgendar');
        document.getElementById('formAgendar').reset();
        servicosSelecionados = [];
        produtosSelecionados = [];
        atualizarResumo();
        document.getElementById('containerHorario').classList.add('hidden');
        document.getElementById('campoNomeOutraPessoa').classList.add('hidden');
        
        setTimeout(() => {
          mostrarSecao('pendentes');
          carregarPendentes();
        }, 2000);
      } catch (error) {
        console.error('Erro ao criar agendamento:', error);
        mostrarMensagem('erro', 'Erro ao criar agendamento. Tente novamente.', 'mensagemAgendar');
      }
    });

    // Salvar agendamento
    async function salvarAgendamento(agendamento) {
      const novoId = firebase.database().ref('agendamentos').push().key;
      agendamento.criadoEm = new Date().toISOString();
      agendamento.timestamp = Date.now();
      agendamento.precoOriginal = agendamento.precoTotal;
      agendamento.desconto = 0;
      agendamento.atualizadoEm = new Date().toISOString();
      await firebase.database().ref(`agendamentos/${novoId}`).set(agendamento);
      return novoId;
    }

    // Listar agendamentos
    async function listarAgendamentosOnce() {
      const snapshot = await firebase.database().ref('agendamentos').once('value');
      return snapshot.val() || {};
    }

    // Carregar pendentes
    async function carregarPendentes() {
      const lista = document.getElementById('listaPendentes');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const pendentes = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.clienteId === usuarioAtual.uid && (a.status === 'pendente' || a.status === 'confirmado'))
          .sort((a, b) => new Date(b[1].dataHora) - new Date(a[1].dataHora));
        
        if (pendentes.length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento pendente</div>';
          return;
        }
        
        lista.innerHTML = pendentes.map(([id, a]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${a.status === 'confirmado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                  ${a.status === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                </span>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mt-2">
                  ${new Date(a.dataHora).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}
                </h3>
                <p class="text-gray-600 dark:text-gray-400">
                  ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} ‚Ä¢ ${a.duracaoTotal} min
                </p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold text-primary">${formatarPreco(a.precoTotal)}</div>
              </div>
            </div>
            <div class="mb-4">
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Servi√ßos:</p>
              <div class="flex flex-wrap gap-2">
                ${(a.servicos || []).map(s => `<span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm">${s.nome}</span>`).join('')}
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="abrirChat('${id}')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
                üí¨ Chat
              </button>
              ${a.status === 'pendente' ? `
                <button onclick="cancelarAgendamento('${id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">
                  ‚ùå Cancelar
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar pendentes:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar agendamentos</div>';
      }
    }

    // Carregar hist√≥rico
    async function carregarHistorico() {
      const lista = document.getElementById('listaHistorico');
      lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const agendamentos = await listarAgendamentosOnce();
        const historico = Object.entries(agendamentos || {})
          .filter(([id, a]) => a.clienteId === usuarioAtual.uid && (a.status === 'concluido' || a.status === 'cancelado'))
          .sort((a, b) => new Date(b[1].dataHora) - new Date(a[1].dataHora));
        
        if (historico.length === 0) {
          lista.innerHTML = '<div class="text-center py-8 text-gray-600 dark:text-gray-400">Nenhum agendamento no hist√≥rico</div>';
          return;
        }
        
        lista.innerHTML = historico.map(([id, a]) => `
          <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow opacity-75">
            <div class="flex justify-between items-start mb-4">
              <div>
                <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${a.status === 'concluido' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'}">
                  ${a.status === 'concluido' ? '‚úÖ Conclu√≠do' : '‚ùå Cancelado'}
                </span>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mt-2">
                  ${new Date(a.dataHora).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' })}
                </h3>
                <p class="text-gray-600 dark:text-gray-400">
                  ${new Date(a.dataHora).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} ‚Ä¢ ${a.duracaoTotal} min
                </p>
              </div>
              ${a.status === 'concluido' ? `
                <div class="text-right">
                  <div class="text-2xl font-bold text-primary">${formatarPreco(a.precoTotal)}</div>
                </div>
              ` : ''}
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Servi√ßos:</p>
              <div class="flex flex-wrap gap-2">
                ${(a.servicos || []).map(s => `<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded text-sm">${s.nome}</span>`).join('')}
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        lista.innerHTML = '<div class="text-center py-8 text-red-600">Erro ao carregar hist√≥rico</div>';
      }
    }

    // Cancelar agendamento
    async function cancelarAgendamento(id) {
      if (!confirm('Deseja realmente cancelar este agendamento?')) return;
      
      try {
        await alterarStatusAgendamento(id, 'cancelado');
        mostrarMensagem('sucesso', 'Agendamento cancelado com sucesso!', 'mensagemAgendar');
        await carregarPendentes();
      } catch (error) {
        console.error('Erro ao cancelar:', error);
        alert('Erro ao cancelar agendamento. Tente novamente.');
      }
    }

    // Chat
    function abrirChat(agendamentoId) {
      chatAgendamentoId = agendamentoId;
      document.getElementById('modalChat').classList.remove('hidden');
      carregarMensagens();
    }

    function fecharChat() {
      document.getElementById('modalChat').classList.add('hidden');
      if (chatListener) chatListener();
      chatAgendamentoId = null;
    }

    function carregarMensagens() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      chatListener = listarMensagens(chatAgendamentoId, (mensagens) => {
        if (!mensagens || Object.keys(mensagens).length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-gray-600 dark:text-gray-400">Nenhuma mensagem ainda</div>';
          return;
        }
        
        const msgs = Object.values(mensagens).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
        container.innerHTML = msgs.map(m => {
          const isMinha = m.userId === usuarioAtual.uid;
          const nome = m.nome || 'Usu√°rio';
          const texto = m.texto || '';
          const data = m.timestamp ? new Date(m.timestamp) : new Date();
          const horaFormatada = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          
          return `
            <div class="flex ${isMinha ? 'justify-end' : 'justify-start'}">
              <div class="max-w-xs px-4 py-2 rounded-lg ${isMinha ? 'bg-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'}">
                <p class="text-xs font-semibold mb-1">${nome}</p>
                <p>${texto}</p>
                <p class="text-xs opacity-75 mt-1">${horaFormatada}</p>
              </div>
            </div>
          `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
      });
    }

    async function enviarMensagemChat() {
      const input = document.getElementById('chatInput');
      const texto = input.value.trim();
      if (!texto) return;
      
      try {
        await enviarMensagem(chatAgendamentoId, {
          userId: usuarioAtual.uid,
          nome: usuarioAtual.displayName || 'Cliente',
          texto: texto,
          timestamp: Date.now()
        });
        input.value = '';
      } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem. Tente novamente.');
      }
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarMensagemChat();
    });

    // Perfil
    async function carregarPerfil() {
      try {
        const perfil = await obterPerfilUsuario(usuarioAtual.uid);
        if (perfil) {
          document.getElementById('perfilNome').value = perfil.nome || '';
          document.getElementById('perfilTelefone').value = perfil.telefone || '';
          document.getElementById('perfilEmail').value = usuarioAtual.email;
        }
      } catch (error) {
        console.error('Erro ao carregar perfil:', error);
      }
    }

    // M√°scara telefone no perfil
    document.getElementById('perfilTelefone').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length > 6) {
        value = `(${value.slice(0,2)}) ${value.slice(2,7)}-${value.slice(7)}`;
      } else if (value.length > 2) {
        value = `(${value.slice(0,2)}) ${value.slice(2)}`;
      } else if (value.length > 0) {
        value = `(${value}`;
      }
      e.target.value = value;
    });

    // Salvar perfil
    document.getElementById('formPerfil').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nome = document.getElementById('perfilNome').value;
      const telefone = document.getElementById('perfilTelefone').value;
      
      try {
        await atualizarPerfilUsuario(usuarioAtual.uid, { nome, telefone });
        await usuarioAtual.updateProfile({ displayName: nome });
        document.getElementById('nomeUsuario').textContent = nome;
        mostrarMensagem('sucesso', 'Perfil atualizado com sucesso!', 'mensagemPerfil');
      } catch (error) {
        console.error('Erro ao atualizar perfil:', error);
        mostrarMensagem('erro', 'Erro ao atualizar perfil. Tente novamente.', 'mensagemPerfil');
      }
    });

    // Alterar senha
    document.getElementById('formSenha').addEventListener('submit', async (e) => {
      e.preventDefault();
      const novaSenha = document.getElementById('novaSenha').value;
      const confirmaSenha = document.getElementById('confirmaSenha').value;
      
      if (novaSenha !== confirmaSenha) {
        mostrarMensagem('erro', 'As senhas n√£o coincidem!', 'mensagemPerfil');
        return;
      }
      
      try {
        await usuarioAtual.updatePassword(novaSenha);
        mostrarMensagem('sucesso', 'Senha alterada com sucesso!', 'mensagemPerfil');
        document.getElementById('formSenha').reset();
      } catch (error) {
        console.error('Erro ao alterar senha:', error);
        mostrarMensagem('erro', 'Erro ao alterar senha. Fa√ßa login novamente e tente.', 'mensagemPerfil');
      }
    });

    // Mostrar mensagens
    function mostrarMensagem(tipo, mensagem, divId) {
      const div = document.getElementById(divId);
      const classes = tipo === 'sucesso' 
        ? 'bg-green-100 dark:bg-green-900 border border-green-400 text-green-700 dark:text-green-200 px-4 py-3 rounded'
        : 'bg-red-100 dark:bg-red-900 border border-red-400 text-red-700 dark:text-red-200 px-4 py-3 rounded';
      div.innerHTML = `<div class="${classes}">${mensagem}</div>`;
      setTimeout(() => div.innerHTML = '', 5000);
    }

    // Formatar pre√ßo
    function formatarPreco(valor) {
      return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    // ============================================
    // FUN√á√ïES DA EQUIPE
    // ============================================
    
    async function carregarEquipe() {
      const lista = document.getElementById('listaEquipe');
      lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Carregando...</div>';
      
      try {
        const equipe = await listarEquipe();
        if (!equipe || Object.keys(equipe).length === 0) {
          lista.innerHTML = '<div class="col-span-3 text-center py-8 text-gray-600 dark:text-gray-400">Nenhum membro cadastrado ainda</div>';
          return;
        }
        
        lista.innerHTML = Object.entries(equipe).map(([id, membro]) => `
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="aspect-square bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center">
              ${membro.foto 
                ? `<img src="${membro.foto}" alt="${membro.nome}" class="w-full h-full object-cover">` 
                : `<span class="text-6xl text-white">üë§</span>`
              }
            </div>
            <div class="p-4">
              <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">${membro.nome || 'Profissional'}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${membro.bio || 'Profissional especializado'}</p>
              <div class="flex items-center justify-between">
                <button onclick="curtirMembro('${id}')" class="flex items-center gap-2 px-4 py-2 bg-pink-100 dark:bg-pink-900 text-pink-600 dark:text-pink-300 rounded-lg hover:bg-pink-200 dark:hover:bg-pink-800 transition">
                  ‚ù§Ô∏è <span id="curtidas-${id}">${membro.curtidas || 0}</span>
                </button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao carregar equipe:', error);
        lista.innerHTML = '<div class="col-span-3 text-center py-8 text-red-600">Erro ao carregar equipe</div>';
      }
    }
    
    async function curtirMembro(membroId) {
      try {
        await curtirMembroEquipe(membroId, usuarioAtual.uid);
        carregarEquipe();
      } catch (error) {
        console.error('Erro ao curtir membro:', error);
      }
    }

    // ============================================
    // FUN√á√ïES AUXILIARES DO CHAT
    // ============================================
    
    function listarMensagens(agendamentoId, callback) {
      const ref = firebase.database().ref(`chats/${agendamentoId}/mensagens`);
      ref.on('value', (snapshot) => {
        callback(snapshot.val());
      });
      return () => ref.off('value');
    }

    async function enviarMensagem(agendamentoId, mensagem) {
      const ref = firebase.database().ref(`chats/${agendamentoId}/mensagens`);
      await ref.push(mensagem);
    }

    // ============================================
    // FUN√á√ÉO DE HOR√ÅRIOS DISPON√çVEIS
    // ============================================
    
    async function obterHorariosDisponiveis(data, duracaoNecessaria) {
      // Configurar hor√°rios do sal√£o (8:00 √†s 19:00)
      const horarios = [];
      for (let hora = 8; hora < 19; hora++) {
        for (let minuto = 0; minuto < 60; minuto += 30) {
          const horario = `${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`;
          horarios.push(horario);
        }
      }
      
      // Buscar agendamentos da data selecionada
      try {
        const agendamentos = await listarAgendamentosOnce();
        const agendamentosData = Object.values(agendamentos || {})
          .filter(a => {
            const dataAgendamento = a.dataHora.split('T')[0];
            return dataAgendamento === data && (a.status === 'pendente' || a.status === 'confirmado');
          });
        
        // Filtrar hor√°rios dispon√≠veis
        return horarios.filter(horario => {
          const dataHoraAtual = new Date(`${data}T${horario}`);
          const fimAtual = new Date(dataHoraAtual.getTime() + duracaoNecessaria * 60000);
          
          // Verificar se h√° conflito com algum agendamento existente
          return !agendamentosData.some(a => {
            const inicioExistente = new Date(a.dataHora);
            const fimExistente = new Date(inicioExistente.getTime() + a.duracaoTotal * 60000);
            
            return (dataHoraAtual >= inicioExistente && dataHoraAtual < fimExistente) ||
                   (fimAtual > inicioExistente && fimAtual <= fimExistente) ||
                   (dataHoraAtual <= inicioExistente && fimAtual >= fimExistente);
          });
        });
      } catch (error) {
        console.error('Erro ao verificar hor√°rios:', error);
        return horarios; // Retornar todos os hor√°rios em caso de erro
      }
    }
  </script>
</body>
</html>
